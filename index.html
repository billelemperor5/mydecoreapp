
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>My Decor Manager — مدير الديكور</title>
<!-- Google Fonts: Tajawal -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<!-- Dexie.js (for IndexedDB) -->
<script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<!-- html2canvas.js (for creating images from HTML) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<!-- Marked.js (for rendering Markdown from AI) -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
  :root{
    --primary:#0f766e; /* teal */
    --accent:#f59e0b;  /* amber */
    --bg:#f8fafc;
    --card:#ffffff;
    --muted:#6b7280;
    --border-color: rgba(2,6,23,.06);
    --text-primary: #071331; /* لون النص الأساسي */
  }
  body.dark{
    --bg:#071026;
    --card:#0b1220;
    --muted:#9aa6b2;
    --border-color: rgba(255,255,255,.06);
    --text-primary: #f1f5f9; /* لون النص الأساسي في الوضع الليلي */
  }
  html,body{height:100%}
  body{
    margin:0;font-family: 'Tajawal', sans-serif; background:var(--bg); color: var(--text-primary);
    -webkit-font-smoothing:antialiased; display:flex;flex-direction:column;min-height:100vh;
  }
  
  /* --- Splash Screen Styles --- */
  .splash{
    position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;
    background:linear-gradient(135deg,var(--primary),#065f46); color:white; z-index:60;
    transition:opacity .4s ease-out, visibility .4s;
  }
  .splash.hidden{ opacity:0; visibility:hidden; pointer-events:none; }
  .splash-content {
    text-align: center;
    animation: fadeInFromBottom 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
  }
  @keyframes fadeInFromBottom {
    from { opacity: 0; transform: translateY(25px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .progress-bar { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 28px; height: 20px; }
  .progress-bar div { width: 12px; height: 12px; background-color: var(--accent); border-radius: 50%; animation: pulse 1.4s infinite ease-in-out both; }
  .progress-bar .dot1 { animation-delay: -0.30s; }
  .progress-bar .dot2 { animation-delay: -0.15s; }
  .progress-bar .dot3 { animation-delay: 0s; }
  @keyframes pulse {
    0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
    40% { transform: scale(1.0); opacity: 1; }
  }
  /* --- End Splash Screen Styles --- */

  /* --- Responsive App Layout --- */
  .app-layout {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
  }
  .app{
    display:flex;
    flex-direction:column;
    flex:1; 
    padding-bottom: 70px; /* Space for mobile bottom nav */
  }

  header.app-header{
    display:flex; align-items:center; justify-content:space-between; padding:12px 16px; position:sticky; top:0; z-index:40;
    background:rgba(255,255,255,.7); backdrop-filter: blur(6px); border-bottom:1px solid rgba(2,6,23,.04)
  }
  body.dark header.app-header{background:rgba(255,255,255,.02);border-bottom:1px solid rgba(255,255,255,.04)}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:46px;height:46px;border-radius:12px;background:linear-gradient(135deg,var(--primary),#0b8f81);display:flex;align-items:center;justify-content:center;color:white;font-weight:900}
  main{flex:1;overflow:auto;padding:16px;-webkit-overflow-scrolling:touch}

  .hero{background:linear-gradient(90deg,var(--primary),#047857);color:white;padding:16px;border-radius:12px;display:flex;flex-direction:column;gap:10px}
  .kpis{display:flex;gap:10px;flex-wrap:wrap}
  .kpi{background:rgba(255,255,255,0.09);padding:10px;border-radius:10px;min-width:110px;text-align:center}

  .grid-cards{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:14px}
  
  .card{
    background:var(--card); border-radius:12px; padding:16px; display:flex; flex-direction:column;
    align-items:center; text-align:center; gap:8px; box-shadow:0 10px 30px rgba(2,6,23,.05);
    cursor:pointer; border: 2px solid transparent; position: relative; /* *** إضافة: لجعل نقطة الإشعار مرتبطة بالبطاقة *** */
  }
  .card .icon{
    width:50px; height:50px; border-radius:14px; display:flex; align-items:center;
    justify-content:center; color:white; font-size:20px; margin-bottom: 4px;
  }
  /* *** إضافة: تصميم احترافي بسيط للبطاقات في الوضع النهاري *** */
  body:not(.dark) .card {
    border: 1px solid rgba(2, 6, 23, 0.15);
    box-shadow: 0 4px 12px rgba(2,6,23,.04);
  }
  /* *** إضافة: تطبيق نفس التصميم الاحترافي للبطاقات في الوضع الليلي *** */
  body.dark .card {
    border: 1px solid rgba(255, 255, 255, 0.15); /* إطار أبيض شفاف */
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); /* ظل داكن خفيف للعمق */
  }

  .btn{background:var(--primary);color:white;padding:6px 10px;border-radius:8px;font-weight:700; border:none; cursor:pointer; font-size: 13px; white-space: nowrap; display: inline-flex; align-items: center; justify-content: center; gap: 6px;}
  /* *** إضافة: تنسيق جديد للأزرار الأيقونية *** */
  .btn.icon-btn { width: 40px; height: 40px; border-radius: 50%; padding: 0; font-size: 18px; flex-shrink: 0; }
  .btn.icon-btn i { margin: 0; }
  .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,.06);color:var(--primary)}

  /* --- Navigation Styles (Mobile First) --- */
  .main-nav {
    position: fixed; bottom: 0; left: 0; right: 0; height: 65px;
    background: var(--card); display: flex; justify-content: space-around;
    align-items: center; box-shadow: 0 -2px 10px rgba(2,6,23,.08);
    z-index: 50; border-top: 1px solid var(--border-color);
  }
  .nav-item {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 4px; color: var(--muted); cursor: pointer; font-size: 12px; font-weight: 500;
    flex: 1; height: 100%; position: relative; /* *** إضافة: لجعل نقطة الإشعار مرتبطة بالعنصر *** */
  }
  .nav-brand { display: none; } /* Hide brand logo in nav on mobile */
  /* *** إضافة: تنسيق نقطة الإشعار *** */
  /* *** تعديل: إصلاح موضع نقطة الإشعار *** */
  .notification-dot {
    position: absolute;
    top: 8px;
    right: 8px; /* *** تعديل: تغيير الموضع ليناسب البطاقات *** */
    width: 10px;
    height: 10px;
    background-color: #ef4444;
    border-radius: 50%;
    border: 2px solid var(--card);
    display: none; /* Hidden by default */
  }
  /* *** إضافة: حركة اهتزاز للزر المهم *** */
  @keyframes pulse-animation {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); }
    70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
  }
  
  .nav-item:hover { color: var(--primary); }
  .nav-item.active { color: var(--primary); font-weight: 700; }
  .nav-item i { font-size: 20px; }

  /* Animations & Transitions */
  .btn, .card, .nav-item {
    transition: transform 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }
  .btn:active, .card:active, .nav-item:active {
    transform: scale(0.96);
  }
  .card:hover{
    transform:translateY(-6px);
  }
  .view-container { animation: fadeIn .4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
  .view-container.is-exiting { animation: fadeOut .25s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; pointer-events: none; }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes fadeOut {
    from { opacity: 1; transform: translateY(0); }
    to { opacity: 0; transform: translateY(15px); }
  }
  .nav-item.active i { animation: nav-bounce 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
  @keyframes nav-bounce {
    0%   { transform: translateY(0); }
    50%  { transform: translateY(-5px); }
    100% { transform: translateY(0); }
  }

  /* --- Desktop & Tablet Styles --- */
  @media (min-width: 768px) {
    .app-layout {
        flex-direction: row;
    }
    .main-nav {
        position: sticky; top: 0; width: 240px; height: 100vh;
        flex-direction: column; justify-content: flex-start; align-items: stretch;
        padding: 16px;
        gap: 8px; border-top: none;
        border-left: 1px solid var(--border-color);
        box-sizing: border-box;
    }
    .nav-brand {
        display: flex; align-items: center; gap: 12px;
        padding: 0 0 16px;
        margin-bottom: 8px;
        border-bottom: 1px solid var(--border-color);
        width: 100%;
    }
    .nav-item {
        flex-direction: row; justify-content: flex-start; gap: 12px;
        flex: 0 0 auto; width: 100%;
        height: auto; padding: 10px 12px;
        border-radius: 8px;
        margin: 0;
        box-sizing: border-box;
    }
    .nav-item span { font-size: 14px; }
    .nav-item.active { background-color: rgba(15, 118, 110, 0.1); }
    
    .app {
        /* *** إضافة: تنسيق نقطة الإشعار لنسخة الحاسوب *** */
        .notification-dot {
            top: 8px; right: 8px;
        }
        padding-bottom: 0;
        max-width: none;
        flex-grow: 1;
        margin: 0;
    }
    .grid-cards {
        grid-template-columns: repeat(3, 1fr);
    }
    header.app-header {
        display: none;
    }
    /* --- إعادة حجم الأزرار للشاشات الأكبر --- */
    .btn {
      padding: 8px 12px;
      font-size: initial; /* Or 15px, or whatever the original base size was */
    }
    .card .icon {
      width: 60px; height: 60px; border-radius: 16px; font-size: 24px;
    }
  }

  @media (min-width: 1024px) {
    .grid-cards {
        grid-template-columns: repeat(3, 1fr);
    }
  }
  /* --- End Desktop Styles --- */

  /* --- Modal Styles --- */
  .modal-container {
    position: fixed; inset: 0; z-index: 100;
    display: flex; align-items: center; justify-content: center;
    padding: 16px;
  }
  .modal-backdrop {
    position: absolute; inset: 0;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(4px);
    animation: fadeIn .3s ease;
  }
  .modal-content {
    position: relative; z-index: 101;
    background: var(--card);
    border-radius: 12px;
    width: 100%;
    max-width: 400px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    animation: fadeInFromBottom .4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    max-height: 90vh;
    display: flex;
    flex-direction: column;
  }
  .modal-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-color);
  }
  .modal-header h3 { margin: 0; font-size: 18px; }
  .modal-header .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted); padding: 0 8px; }
  .modal-body { padding: 16px; overflow-y: auto; }
  .form-group { margin-bottom: 16px; }
  .form-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 14px; }
  /* *** إصلاح: استثناء أزرار الراديو والتشيك بوكس من التنسيق العام للحقول *** */
  .form-group input:not([type="radio"]):not([type="checkbox"]), .form-group select {
    width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);
    background: var(--bg); color: var(--text-primary); font-size: 15px; box-sizing: border-box;
    background: var(--bg); color: var(--text-primary); font-size: 15px; box-sizing: border-box;
    -webkit-appearance: none; appearance: none;
  }
  .form-group textarea {
    width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);
    background: var(--bg); color: var(--text-primary); font-size: 15px; box-sizing: border-box;
    font-family: 'Tajawal', sans-serif;
    resize: vertical;
    min-height: 80px;
    line-height: 1.6;
  }
  .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
  .modal-container.is-exiting .modal-content { animation: fadeOut .25s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
  .modal-container.is-exiting .modal-backdrop { animation: fadeOut .25s ease forwards; }
  #deleteWorkerBtn {
    background-color: #ef4444;
    color: white;
  }
  #deleteWorkerBtn:hover {
    background-color: #dc2626;
  }

  /* Ensure the confirmation modal appears on top of other modals */
  #confirmModal {
    z-index: 110;
  }
  /* *** إضافة: صنف لإخفاء النوافذ المنبثقة *** */
  .modal-container.modal-hidden {
    display: none;
  }


  /* --- Worker Details & Calendar Styles --- */
  .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
  .calendar-header { font-weight: 700; font-size: 12px; color: var(--muted); padding-bottom: 8px; }
  .calendar-day { height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 14px; position: relative; }
  .calendar-day.not-in-month { color: var(--muted); opacity: 0.5; }
  .calendar-day.present { background-color: rgba(34, 197, 94, 0.2); color: #15803d; font-weight: 700; }
  .calendar-day.absent { background-color: rgba(239, 68, 68, 0.2); color: #b91c1c; font-weight: 700; }
  body.dark .calendar-day.present { color: #6ee7b7; }
  body.dark .calendar-day.absent { color: #fca5a5; }
  .activity-log-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-radius: 8px; margin-bottom: 8px; background: var(--bg); }
  .activity-log-item .icon { font-size: 16px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; margin-left: 12px; }
  .activity-log-item .delete-activity { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 16px; }
  .activity-log-item .delete-activity:hover { color: #ef4444; }
  .activity-log-item .note { font-size: 12px; color: var(--muted); margin-top: 4px; padding-right: 44px; }

  /* --- New Note Form Styles --- */
  .add-note-container {
    max-width: 600px;
    margin: 0 auto 24px;
    background: var(--card);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(2,6,23,.08);
    padding: 12px;
  }
  .add-note-container input,
  .add-note-container textarea {
    width: 100%;
    border: none;
    background: transparent;
    padding: 8px;
    font-size: 15px;
    color: var(--text-primary);
    font-family: 'Tajawal', sans-serif;
  }
  .add-note-container input:focus,
  .add-note-container textarea:focus {
    outline: none;
  }
  .add-note-container #newNoteTitle { font-weight: 700; font-size: 16px; }
  .add-note-container #newNoteContent { resize: none; min-height: 40px; }
  .new-note-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 12px;
  }

  /* --- Notes Feature Styles --- */
  .notes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 16px;
  }
  .note-card {
    background: var(--card);
    border-radius: 8px;
    padding: 16px;
    box-shadow: 0 2px 8px rgba(2,6,23,.05);
    border-top: 4px solid var(--primary);
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .note-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(2,6,23,.08);
  }
  .note-title { margin: 0 0 8px; font-weight: 700; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .note-content { margin: 0; font-size: 14px; color: var(--muted); line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 5; line-clamp: 5; -webkit-box-orient: vertical; overflow: hidden; min-height: 112px; }
  .note-footer { margin-top: 12px; padding-top: 8px; border-top: 1px solid var(--border-color); font-size: 12px; color: var(--muted); text-align: left; }
  #noteContent {
    resize: vertical;
    min-height: 120px;
    line-height: 1.6;
  }
  .color-swatches { display: flex; gap: 10px; margin-top: 8px; }
  .swatch {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: transform 0.2s ease, border-color 0.2s ease;
  }
  .swatch:hover { transform: scale(1.1); }
  .swatch.selected {
    border-color: var(--primary);
    box-shadow: 0 0 0 2px var(--card);
  }
  /* --- AI Action Dropdown --- */
  .ai-action-dropdown {
    position: absolute;
    bottom: 100%;
    left: 0;
    background-color: var(--card);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    padding: 8px;
    z-index: 120;
    display: flex;
    flex-direction: column;
    gap: 4px;
    min-width: 150px;
    margin-bottom: 8px;
  }

  /* --- Inventory Styles --- */
  .status-badge {
    padding: 3px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 700;
    color: white;
    text-align: center;
  }

  /* --- Calendar View Styles --- */
  .full-calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); border-left: 1px solid var(--border-color); }
  .full-calendar-header { text-align: center; padding: 8px 4px; font-weight: 700; font-size: 13px; color: var(--muted); border-bottom: 1px solid var(--border-color); }
  .full-calendar-day {
    min-height: 100px;
    border-right: 1px solid var(--border-color);
    border-bottom: 1px solid var(--border-color);
    padding: 4px;
    font-size: 13px;
    font-weight: 700;
  }
  .full-calendar-day.not-in-month { background-color: var(--bg); color: var(--muted); }
  .calendar-event {
    font-size: 12px; padding: 2px 6px; border-radius: 4px; color: white;
    margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    cursor: pointer;
  }


  /* --- Settlement Card Styles --- */
  .settlement-card {
    background: linear-gradient(135deg, var(--accent), #d97706);
    color: white;
    border-radius: 12px;
    padding: 16px;
    margin: 20px 0;
  }
  /* --- Print Styles --- */
  @media print {
    /* Hide everything on the page by default when printing */
    body > * {
      display: none !important;
    }
    /* Only show the print container and its content */
    #printContainer, #printContainer * {
      display: block !important;
      visibility: visible !important;
    }
  }

  /* --- Toast Notification Styles --- */
  .toast-container {
    position: fixed;
    bottom: 80px; /* Above the nav bar */
    left: 50%;
    transform: translateX(-50%);
    z-index: 120;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    pointer-events: none;
  }
  .toast {
    background-color: #22c55e; /* Green for success */
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    font-weight: 700;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    animation: fadeInFromBottom 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }
  .toast.error { background-color: #ef4444; }

  /* --- Switch Toggle Styles --- */
  .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
  .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background-color: var(--primary); }
  input:focus + .slider { box-shadow: 0 0 1px var(--primary); }
  input:checked + .slider:before { transform: translateX(22px); }


  /* --- AI Assistant Styles --- */
  .ai-chat-container { display: flex; flex-direction: column; height: 100%; }
  .ai-chat-history { flex-grow: 1; overflow-y: auto; padding: 10px; }
  .ai-chat-bubble { max-width: 85%; padding: 10px 14px; border-radius: 16px; margin-bottom: 12px; line-height: 1.6; }
  .ai-chat-bubble.user { background-color: var(--primary); color: white; border-bottom-right-radius: 4px; margin-left: auto; }
  .ai-chat-bubble.model { background-color: var(--card); border-bottom-left-radius: 4px; margin-right: auto; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
  .ai-chat-bubble.model p:first-child { margin-top: 0; }
  .ai-chat-bubble.model p:last-child { margin-bottom: 0; }
  .ai-chat-bubble.model strong { color: var(--primary); }
  .ai-chat-bubble.model code { background: var(--bg); padding: 2px 6px; border-radius: 4px; font-size: 13px; direction: ltr; display: inline-block; }
  .ai-chat-bubble.model pre { background: var(--bg); padding: 10px; border-radius: 8px; overflow-x: auto; font-size: 13px; }
  .ai-chat-bubble.model ul, .ai-chat-bubble.model ol { padding-right: 20px; }
  .ai-chat-input-area { display: flex; gap: 10px; padding: 10px; border-top: 1px solid var(--border-color); }
  #aiPromptInput { flex-grow: 1; resize: none; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg); color: var(--text-primary); font-family: 'Tajawal', sans-serif; font-size: 15px; }
  #sendAiPromptBtn { height: 44px; width: 44px; padding: 0; font-size: 18px; flex-shrink: 0; }
  .typing-indicator { display: flex; align-items: center; gap: 5px; }
  .typing-indicator span { width: 8px; height: 8px; background-color: var(--muted); border-radius: 50%; animation: typing-pulse 1.4s infinite ease-in-out both; }
  .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
  .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
  @keyframes typing-pulse {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1.0); }
  }

  /* *** تحسين: إعادة تصميم أزرار التبويب لتصبح بطاقات ملونة *** */
  .tab-card-container {
    display: grid;
    /* *** تحسين: تعديل حجم الأعمدة لتناسب البطاقات الأصغر *** */
    grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
  }
  .tab-card {
    /* *** تحسين: تقليل الحشو لجعل البطاقة أصغر *** */
    padding: 12px 10px;
    border-radius: 12px;
    color: white;
    text-align: center;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    border: 3px solid transparent;
    opacity: 0.9;
  }
  .tab-card.active { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); border-color: var(--accent); opacity: 1; }
  /* *** تحسين: تصغير حجم الأيقونة والنص *** */
  .tab-card i { font-size: 20px; margin-bottom: 6px; }
  .tab-card span { font-weight: 700; font-size: 13px; display: block; }
  .tab-content { display: none; }
  .tab-content.active { display: block; animation: fadeIn .4s; }

  /* *** إضافة: تنسيقات للجداول الاحترافية داخل النوافذ المنبثقة *** */
  .professional-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
  .professional-table th, .professional-table td { padding: 12px 10px; text-align: right; border-bottom: 1px solid var(--border-color); }
  .professional-table th { font-size: 13px; color: var(--muted); font-weight: 700; }
  .professional-table tbody tr { cursor: pointer; transition: background-color 0.2s ease; }
  .professional-table tbody tr:hover { background-color: var(--bg); }
  .professional-table .amount-col { font-weight: 700; text-align: left; }
  .professional-table .amount-col.positive { color: #10b981; }
  .professional-table .amount-col.negative { color: #ef4444; }
  .professional-table .icon-cell { width: 40px; text-align: center; }
  .professional-table .icon-cell i { color: var(--muted); }
  @media (max-width: 480px) {
    .professional-table .hide-on-mobile { display: none; }
  }
  /* *** إضافة: تنسيقات القائمة المنسدلة للمستخدم *** */
  .user-profile-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    background-color: var(--card);
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    border: 1px solid var(--border-color);
    width: 240px;
    z-index: 50;
    padding: 8px;
    animation: fadeInFromBottom 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }
  .user-profile-dropdown .user-info {
    padding: 8px 12px;
    margin-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
  }
  .user-profile-dropdown .user-info div {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  /* *** إضافة: تنسيقات لنتائج البحث *** */
  .search-results-group h4 {
    margin: 16px 0 8px;
    font-size: 14px;
    color: var(--muted);
    font-weight: 700;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
  }
  .search-result-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  .search-result-item:hover {
    background-color: var(--bg);
  }
  /* *** إضافة: تنسيقات بطاقة التاريخ والإجراءات السريعة (للوضع الفاتح والداكن) *** */
  .date-action-card {
    color: white;
    backdrop-filter: blur(10px);
    /* الوضع الفاتح: أزرق شفاف */
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.8), rgba(139, 92, 246, 0.8));
    border: 1px solid rgba(255, 255, 255, 0.2);
  }
  body.dark .date-action-card {
    /* الوضع الداكن: رمادي-أردوازي شفاف */
    background: linear-gradient(135deg, rgba(100, 116, 139, 0.7), rgba(71, 85, 105, 0.6));
    border: 1px solid rgba(255, 255, 255, 0.1);
  }


  /* *** إضافة: تنسيق خاص للبطاقة التي تأخذ عرض كامل *** */
  .full-width-card {
    grid-column: 1 / -1; /* اجعل البطاقة تمتد على جميع الأعمدة */
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    text-align: right;
  }
  .full-width-card .icon {
    margin-bottom: 0;
  }
</style>
<!-- *** إضافة: تنسيقات خاصة بنافذة الرسائل *** -->
<style>
  .message-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .message-item {
    background: var(--bg);
    padding: 12px;
    border-radius: 8px;
    border-right: 4px solid var(--primary);
  }
  .message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
    color: var(--muted);
    margin-bottom: 8px;
  }
  .message-text {
    line-height: 1.6;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
</style>
</head>
<!-- *** إضافة: تنسيقات خاصة بواجهة البلاغات *** -->
<style>
  .report-card {
    background: var(--card);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
    box-shadow: 0 4px 12px rgba(2,6,23,.04);
    border-right: 4px solid; /* سيتم تحديد اللون بواسطة JavaScript */
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .report-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(2,6,23,.06);
  }
  .report-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }
  .report-worker-name {
    font-weight: 700;
    font-size: 16px;
  }
  .report-note {
    color: var(--muted);
    line-height: 1.6;
    white-space: pre-wrap;
  }
</style>
<body>
  <!-- splash -->
  <div id="splash" class="splash" role="dialog" aria-hidden="false">
    <div class="splash-content">
        <div style="font-size:52px; margin-bottom:12px;"><i class="fas fa-paint-roller"></i></div>
        <h1 style="margin:0;font-size:24px;font-weight:800; letter-spacing: 1px;">My Decor Manager</h1>
        <p style="margin:8px 0 0;opacity:.9; font-size: 15px;">تطبيقك لإدارة أعمال الديكور والبناء</p>
        <div class="progress-bar">
            <div class="dot1"></div>
            <div class="dot2"></div>
            <div class="dot3"></div>
        </div>
    </div>
  </div>

  <!-- Main application wrapper for layout -->
  <div class="app-layout" id="appLayout">
    
    <!-- Navigation (bottom bar on mobile, sidebar on desktop) -->
    <nav class="main-nav" id="mainNav">
        <!-- Brand logo for sidebar view -->
        <div class="nav-brand">
            <div class="logo" style="width:40px;height:40px;border-radius:10px;"><i class="fas fa-paint-roller"></i></div>
            <div>
              <div style="font-weight:800; font-size: 15px;">My Decor Manager</div>
            </div>
        </div>
        <!-- Nav items -->
        <div class="nav-item active" data-view="home">
            <i class="fas fa-tachometer-alt"></i>
            <span>الرئيسية</span>
        </div>
        <div class="nav-item" data-view="about">
            <i class="fas fa-info-circle"></i>
            <span>حول</span>
        </div>
        <div class="nav-item" data-view="workers">
            <i class="fas fa-users"></i>
            <span>العمال</span>
        </div>
        <div class="nav-item" data-view="settings">
            <i class="fas fa-cog"></i>
            <span>الاعدادات</span>
            <span class="notification-dot" id="settingsNotificationDot"></span>
        </div>
    </nav>
    
    <!-- Main Content Area -->
    <div class="app" id="app" aria-hidden="true" style="visibility: hidden;">
        <!-- Header for mobile view only -->
        <header class="app-header">
            <div class="brand">
                <div class="logo"><i class="fas fa-paint-roller"></i></div>
                <div>
                <div style="font-weight:800">My Decor Manager</div>
                <div style="font-size:13px;color:var(--muted)">مدير الديكور الخاص بك</div>
                </div>
            </div>
            <!-- *** إضافة: زر الرسائل الجديد في الشريط العلوي *** -->
            <div style="display:flex;gap:8px;align-items:center; position: relative;">
                <button id="messagesBtn" class="btn icon-btn ghost" title="الرسائل">
                    <i class="fas fa-envelope"></i>
                </button>
                <button id="userProfileBtn" class="btn icon-btn ghost" title="الحساب">
                    <i id="userProfileIcon" class="fas fa-sign-in-alt"></i>
                </button>
                <div id="userProfileDropdown" class="user-profile-dropdown" style="display: none;">
                    <!-- Logged In View -->
                    <div id="loggedInView" style="display: none;">
                        <div class="user-info">
                        <div id="userDisplayName" style="font-weight: 700;">جاري التحميل...</div>
                        <div id="userDisplayEmail" style="font-size: 13px; color: var(--muted);"></div>
                        </div>
                        <button id="logoutBtn" class="btn ghost" style="width: 100%; justify-content: flex-start; color: #ef4444; border-color: transparent; text-align: right;">
                            <i class="fas fa-sign-out-alt" style="margin-left: 8px;"></i> تسجيل الخروج
                        </button>
                    </div>
                    <!-- Logged Out View -->
                    <!-- *** تعديل: إصلاح وتحسين مظهر أزرار تسجيل الدخول وإنشاء الحساب *** -->
                    <div id="loggedOutView" style="display: none; flex-direction: column; gap: 8px;">
                        <a href="login.html" class="btn" style="text-decoration: none; width: 100%; box-sizing: border-box;"><i class="fas fa-sign-in-alt" style="margin-left: 8px;"></i> تسجيل الدخول</a>
                        <a href="signup.html" class="btn ghost" style="text-decoration: none; width: 100%; box-sizing: border-box;">إنشاء حساب جديد</a>
                    </div>
                </div>
                <button id="themeToggleHeader" class="btn icon-btn ghost" title="تبديل الوضع"><i class="fas fa-moon"></i></button>
            </div>
        </header>

        <main id="mainContent">
            <!-- Views will be injected here -->
        </main>
    </div>

  </div>

  <!-- *** إضافة: نافذة منبثقة لعرض كل دفعات العميل لمشروع معين *** -->
  <div id="allPaymentsModal" class="modal-container modal-hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header">
              <h3>جميع الدفعات المستلمة</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <div id="allPaymentsContent">
                  <!-- Full payments list will be injected here -->
              </div>
          </div>
      </div>
  </div>

  <!-- *** إضافة: نافذة منبثقة للبحث الشامل *** -->
  <div id="searchModal" class="modal-container modal-hidden">
      <div class="modal-backdrop" data-action="close-modal"></div>
      <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header" style="padding: 12px 16px;">
              <div class="form-group" style="margin: 0; flex-grow: 1; position: relative;">
                  <i class="fas fa-search" style="position: absolute; top: 50%; right: 12px; transform: translateY(-50%); color: var(--muted);"></i>
                  <input type="search" id="searchInput" placeholder="ابحث عن مشروع, عامل, نفقة..." style="width: 100%; padding: 10px 40px 10px 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg); color: var(--text-primary); font-size: 15px; box-sizing: border-box;">
              </div>
          </div>
          <div class="modal-body" id="searchResultsContainer" style="min-height: 200px; max-height: 400px;">
              <!-- نتائج البحث ستظهر هنا -->
              <div style="text-align: center; padding: 40px 20px; color: var(--muted);">
                  <i class="fas fa-search" style="font-size: 32px; margin-bottom: 12px;"></i>
                  <p>ابدأ الكتابة للبحث في التطبيق.</p>
              </div>
          </div>
      </div>
  </div>

  <!-- *** إضافة: نافذة منبثقة لمساعد الذكاء الاصطناعي العام *** -->
  <div id="aiAssistantModal" class="modal-container modal-hidden">
      <div class="modal-backdrop" data-action="close-modal"></div>
      <div class="modal-content" style="max-width: 500px; height: 80vh;">
          <div class="modal-header">
              <h3>مساعد الذكاء الاصطناعي</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body" style="padding: 0;">
              <div class="ai-chat-container" style="height: 100%;">
                  <div id="aiChatHistory" class="ai-chat-history">
                      <!-- سيتم حقن سجل المحادثة هنا -->
                  </div>
                  <div class="ai-chat-input-area">
                      <textarea id="aiPromptInput" placeholder="اكتب سؤالك هنا..." rows="1"></textarea>
                      <button id="sendAiPromptBtn" class="btn" disabled><i class="fas fa-paper-plane"></i></button>
                  </div>
              </div>
          </div>
      </div>
  </div>













  <!-- *** إضافة: نافذة منبثقة لعرض كل الأنشطة المالية للمشروع *** -->
  <div id="projectFullFinanceModal" class="modal-container modal-hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header">
              <h3>السجل المالي الكامل للمشروع</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <div id="projectFullFinanceContent">
                  <!-- Full log will be injected here -->
              </div>
          </div>
      </div>
  </div>

  <!-- *** إضافة: نافذة منبثقة لعرض كل نفقات المشروع *** -->
  <div id="allExpensesModal" class="modal-container modal-hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header">
              <h3>جميع نفقات المشروع</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <div id="allExpensesContent">
                  <!-- Full expenses list will be injected here -->
              </div>
          </div>
      </div>
  </div>






  <!-- Modal for adding/editing workers -->
  <div id="workerModal" class="modal-container modal-hidden">
      <div class="modal-backdrop" data-action="close-modal"></div>
      <div class="modal-content">
          <div class="modal-header">
              <h3 id="workerModalTitle">إضافة عامل جديد</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <!-- ملاحظة: تخزين PIN محلياً ليس آمناً 100% للبيئات الإنتاجية الحساسة. -->
          <div class="modal-body">
              <form id="workerForm">
                  <input type="hidden" id="workerId">
                  <input type="hidden" id="workerImageDataBase64">

                  <div class="form-group" style="text-align: center; position: relative;">
                      <img id="workerImagePreview" src="" alt="صورة العامل" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--border-color); display: none; margin: 0 auto 10px;">
                      <button type="button" id="workerImageRemoveBtn" title="إزالة الصورة" style="position: absolute; top: -5px; left: 50%; transform: translateX(40px); width: 28px; height: 28px; border-radius: 50%; background: #ef4444; color: white; border: 2px solid var(--card); font-size: 14px; display: none; cursor: pointer; padding: 0; line-height: 1;">&times;</button>

                      <div id="workerImagePlaceholder" class="icon" style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg,#f97316,#f59e0b); font-size: 40px; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                          <i class="fas fa-user"></i>
                      </div>
                      <input type="file" id="workerImageInput" accept="image/*" style="display: none;">
                      <button type="button" id="workerImageUploadBtn" class="btn ghost" style="padding: 6px 12px; font-size: 13px;">اختر صورة</button>
                  </div>

                  <div class="form-group">
                      <label for="workerName">اسم العامل</label>
                      <input type="text" id="workerName" required>
                  </div>
                  <div class="form-group">
                      <label for="workerPhone">رقم الهاتف</label>
                      <input type="tel" id="workerPhone">
                  </div>
                  <div class="form-group">
                      <label for="workerDailyRate">الأجرة اليومية الافتراضية (د.ج)</label>
                      <input type="number" id="workerDailyRate" required>
                  </div>
                  <div class="form-group">
                      <label for="workerPin">رمز PIN (اختياري - 4 أرقام)</label>
                      <input type="password" id="workerPin" pattern="\d{4}" maxlength="4" placeholder="اتركه فارغاً لعدم تعيين رمز">
                  </div>
                  <div class="form-actions">
                      <button type="submit" class="btn">حفظ</button>
                      <button type="button" class="btn" id="deleteWorkerBtn" style="display: none; background-color: #ef4444;">حذف</button>
                  </div>
              </form>
          </div>
      </div>
  </div>

  <!-- *** إضافة: نافذة منبثقة لإدخال PIN العامل *** -->
  <div id="workerPinModal" class="modal-container modal-hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-content" style="max-width: 360px;">
        <div class="modal-header">
            <h3>التحقق من الهوية</h3>
            <button class="close-btn" data-action="close-modal">&times;</button>
        </div>
        <div class="modal-body" style="text-align: center;">
            <p style="margin-top:0; margin-bottom: 20px;">الرجاء إدخال رمز PIN الخاص بالعامل <strong id="pinWorkerName"></strong> للمتابعة.</p>
            <form id="workerPinForm">
                <input type="hidden" id="pinWorkerId">
                <div class="form-group">
                    <input type="password" id="pinInput" required pattern="\d{4}" maxlength="4" style="text-align: center; font-size: 24px; letter-spacing: 10px;">
                </div>
                <div class="form-actions" style="justify-content: center;">
                    <button type="submit" class="btn" style="flex: 1;">دخول</button>
                </div>
                <!-- *** إضافة: خيار تذكر PIN *** -->
                <div class="form-group" style="text-align: right; margin-top: 15px; margin-bottom: 0;">
                    <label style="display: inline-flex; align-items: center; cursor: pointer; font-size: 14px; color: var(--muted);">
                        <input type="checkbox" id="rememberPinCheckbox" style="width: auto; margin-left: 8px; transform: scale(1.1);">
                        تذكر رمز PIN على هذا الجهاز
                    </label>
                    <!-- ملاحظة أمنية: حفظ PIN في localStorage مناسب للراحة فقط وليس للبيئات عالية الأمان. -->
                </div>
            </form>
        </div>
    </div>
</div>

  <!-- Modal for adding attendance/payment -->
  <div id="activityModal" class="modal-container modal-hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
          <div class="modal-header">
              <h3 id="activityModalTitle">إضافة نشاط</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <form id="activityForm">
                  <input type="hidden" id="activityWorkerId">
                  <input type="hidden" id="activityType">
                  <div class="form-group">
                      <label for="activityDate">التاريخ</label>
                      <input type="date" id="activityDate" required>
                  </div>
                  <div id="attendanceRateGroup" class="form-group" style="display: none;">
                      <label for="attendanceDailyRate">أجرة هذا اليوم (د.ج)</label>
                      <input type="number" id="attendanceDailyRate" placeholder="تُستخدم الأجرة الافتراضية إذا ترك فارغاً">
                  </div>
                  <div id="paymentAmountGroup" class="form-group" style="display: none;">
                      <label for="paymentAmount">المبلغ المدفوع (د.ج)</label>
                      <input type="number" id="paymentAmount" placeholder="مثال: 5000">
                  </div>
                  <div id="activityNoteGroup" class="form-group" style="display: none;">
                      <label for="activityNote">ملاحظة (اختياري)</label>
                      <input type="text" id="activityNote" placeholder="مثال: سلفة أسبوعية">
                  </div>
                  <div class="form-actions"><button type="submit" class="btn">حفظ</button></div>
              </form>
          </div>
      </div>
  </div>

  <!-- Modal for full activity log -->
  <div id="activityLogModal" class="modal-container modal-hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header">
              <h3>السجل الكامل للأنشطة</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <div id="fullActivityLogContent">
                  <!-- Full log will be injected here -->
              </div>
          </div>
      </div>
  </div>

  <!-- Modal for adding/editing suppliers -->
  <div id="supplierModal" class="modal-container modal-hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
          <div class="modal-header">
              <h3 id="supplierModalTitle">إضافة مورد جديد</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <form id="supplierForm">
                  <input type="hidden" id="supplierId">
                  <input type="hidden" id="supplierImageDataBase64">

                  <div class="form-group" style="text-align: center; position: relative;">
                      <img id="supplierImagePreview" src="" alt="صورة المورد" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--border-color); display: none; margin: 0 auto 10px;">
                      <button type="button" id="supplierImageRemoveBtn" title="إزالة الصورة" style="position: absolute; top: -5px; left: 50%; transform: translateX(40px); width: 28px; height: 28px; border-radius: 50%; background: #ef4444; color: white; border: 2px solid var(--card); font-size: 14px; display: none; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
                      <div id="supplierImagePlaceholder" class="icon" style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg,#10b981,#059669); font-size: 40px; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                          <i class="fas fa-truck"></i>
                      </div>
                      <input type="file" id="supplierImageInput" accept="image/*" style="display: none;">
                      <button type="button" id="supplierImageUploadBtn" class="btn ghost" style="padding: 6px 12px; font-size: 13px;">اختر صورة</button>
                  </div>

                  <div class="form-group">
                      <label for="supplierName">اسم المورد</label>
                      <input type="text" id="supplierName" required>
                  </div>
                  <div class="form-group">
                      <label for="supplierPhone">رقم الهاتف</label>
                      <input type="tel" id="supplierPhone">
                  </div>
                  <div class="form-group">
                      <label for="supplierSpecialty">التخصص (مثال: دهانات, كهرباء)</label>
                      <input type="text" id="supplierSpecialty">
                  </div>
                  <!-- *** إضافة: حقل جديد للملاحظات *** -->
                  <div class="form-group">
                      <label for="supplierNotes">ملاحظات (اختياري)</label>
                      <textarea id="supplierNotes" rows="3" placeholder="أي تفاصيل إضافية عن المورد..."></textarea>
                  </div>
                  <div class="form-actions">
                      <button type="submit" class="btn">حفظ</button>
                      <button type="button" class="btn" id="deleteSupplierBtn" style="display: none; background-color: #ef4444;">حذف</button>
                  </div>
              </form>
          </div>
      </div>
  </div>

  <!-- Modal for attendance confirmation -->
  <div id="attendanceConfirmModal" class="modal-container modal-hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content" style="max-width: 360px;">
          <div class="modal-header">
              <h3>تأكيد حالة اليوم</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body" style="text-align: center;">
              <p style="margin-top:0; margin-bottom: 20px;">الرجاء تحديد حالة العامل لتاريخ <strong id="confirmDate"></strong>:</p>
              <div class="form-actions" style="justify-content: center;">
                  <button type="button" class="btn" id="confirmPresentBtn" style="background-color: #10b981; flex: 1;"><i class="fas fa-check" style="margin-left: 6px;"></i> حضور</button>
                  <button type="button" class="btn" id="confirmAbsentBtn" style="background-color: #ef4444; flex: 1;"><i class="fas fa-times" style="margin-left: 6px;"></i> غياب</button>
              </div>
          </div>
      </div>
  </div>

  <!-- Modal for generic confirmation -->
  <div id="confirmModal" class="modal-container modal-hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content" style="max-width: 380px;">
          <div class="modal-header">
              <h3 id="confirmModalTitle">تأكيد الحذف</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body" style="text-align: center;">
              <div style="font-size: 48px; color: #ef4444; margin-bottom: 16px;"><i class="fas fa-exclamation-triangle"></i></div>
              <p id="confirmModalMessage" style="margin-top:0; margin-bottom: 20px; font-size: 15px; line-height: 1.6;"></p>
              <div class="form-actions" style="justify-content: center;">
                  <button type="button" class="btn" id="confirmModalCancelBtn" style="background-color: var(--muted);">إلغاء</button>
                  <button type="button" class="btn" id="confirmModalConfirmBtn">نعم</button>
              </div>
          </div>
      </div>
  </div>

  <!-- Modal for adding/editing notes -->
  <div id="noteModal" class="modal-container modal-hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header">
              <h3 id="noteModalTitle">إضافة ملاحظة</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <form id="noteForm">
                  <input type="hidden" id="noteId">
                  <div class="form-group">
                      <label for="noteTitle">العنوان</label>
                      <input type="text" id="noteTitle" placeholder="عنوان الملاحظة...">
                  </div>
                  <div class="form-group">
                      <label for="noteContent">المحتوى</label>
                      <textarea id="noteContent" rows="8" placeholder="اكتب أفكارك أو مقاساتك هنا..."></textarea>
                  </div>
                  <div class="form-group">
                      <label>اختر لوناً</label>
                      <div class="color-swatches">
                          <div class="swatch selected" data-color="#3b82f6" style="background: #3b82f6;"></div>
                          <div class="swatch" data-color="#10b981" style="background: #10b981;"></div>
                          <div class="swatch" data-color="#f59e0b" style="background: #f59e0b;"></div>
                          <div class="swatch" data-color="#ef4444" style="background: #ef4444;"></div>
                          <div class="swatch" data-color="#64748b" style="background: #64748b;"></div>
                      </div>
                      <input type="hidden" id="noteColor" value="#3b82f6">
                  </div>
                  <div class="form-actions" style="position: relative;">
                      <button type="button" class="btn ghost" id="noteAiHelperBtn" style="color: #a855f7; border-color: #a855f7; margin-left: auto; margin-right: 10px;"><i class="fas fa-magic"></i> مساعدة AI</button>
                      <button type="button" class="btn" id="deleteNoteBtn" style="display: none; background-color: #ef4444; margin-left: auto; margin-right: 0;">حذف</button>
                      <button type="submit" class="btn" style="margin-left: 0;">حفظ الملاحظة</button>
                      <div id="noteAiActionDropdown" class="ai-action-dropdown" style="display: none;">
                          <button type="button" data-action="summarize" class="btn ghost" style="text-align: right; width: 100%; border: none;">تلخيص النص</button>
                          <button type="button" data-action="rephrase" class="btn ghost" style="text-align: right; width: 100%; border: none;">إعادة صياغة</button>
                          <button type="button" data-action="suggest_title" class="btn ghost" style="text-align: right; width: 100%; border: none;">اقتراح عنوان</button>
                      </div>
                  </div>
              </form>
          </div>
      </div>
  </div>

  <!-- Modal for adding/editing inventory items -->
  <div id="inventoryModal" class="modal-container modal-hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
          <div class="modal-header">
              <h3 id="inventoryModalTitle">إضافة أداة جديدة</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <form id="inventoryForm">
                  <input type="hidden" id="inventoryId">
                  <input type="hidden" id="inventoryImageDataBase64">

                  <div class="form-group" style="text-align: center; position: relative;">
                      <img id="inventoryImagePreview" src="" alt="صورة الأداة" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--border-color); display: none; margin: 0 auto 10px;">
                      <button type="button" id="inventoryImageRemoveBtn" title="إزالة الصورة" style="position: absolute; top: -5px; left: 50%; transform: translateX(40px); width: 28px; height: 28px; border-radius: 50%; background: #ef4444; color: white; border: 2px solid var(--card); font-size: 14px; display: none; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
                      <div id="inventoryImagePlaceholder" class="icon" style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg,#22c55e,#16a34a); font-size: 40px; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                          <i class="fas fa-toolbox"></i>
                      </div>
                      <input type="file" id="inventoryImageInput" accept="image/*" style="display: none;">
                      <button type="button" id="inventoryImageUploadBtn" class="btn ghost" style="padding: 6px 12px; font-size: 13px;">اختر صورة</button>
                  </div>

                  <div class="form-group">
                      <label for="inventoryName">اسم الأداة</label>
                      <input type="text" id="inventoryName" required>
                  </div>
                  <div class="form-group">
                      <label for="inventoryQuantity">الكمية</label>
                      <input type="number" id="inventoryQuantity" value="1" required>
                  </div>
                  <div class="form-group">
                      <label for="inventoryStatus">الحالة</label>
                      <select id="inventoryStatus"><option value="available">متوفر</option><option value="in_use">قيد الاستخدام</option><option value="maintenance">صيانة</option></select>
                  </div>
                  <div class="form-actions">
                      <button type="submit" class="btn">حفظ</button>
                      <button type="button" class="btn" id="deleteInventoryBtn" style="display: none; background-color: #ef4444;">حذف</button>
                  </div>
              </form>
          </div>
      </div>
  </div>

  <!-- Modal for lending an item -->
  <div id="lendItemModal" class="modal-container modal-hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
          <div class="modal-header">
              <h3 id="lendItemModalTitle">إعارة أداة</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <form id="lendItemForm">
                  <input type="hidden" id="lendItemId">
                  <div class="form-group">
                      <label for="borrowerName">اسم المستعير</label>
                      <input type="text" id="borrowerName" required>
                  </div>
                  <div class="form-group">
                      <label for="borrowDate">تاريخ الإعارة</label>
                      <input type="date" id="borrowDate" required>
                  </div>
                  <div class="form-actions">
                      <button type="submit" class="btn">تأكيد الإعارة</button>
                  </div>
              </form>
          </div>
      </div>
  </div>

  <!-- Modal for adding/editing calendar events -->
  <div id="eventModal" class="modal-container modal-hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
          <div class="modal-header">
              <h3 id="eventModalTitle">إضافة حدث جديد</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <form id="eventForm">
                  <input type="hidden" id="eventId">
                  <div class="form-group">
                      <label for="eventTitle">عنوان الحدث</label>
                      <input type="text" id="eventTitle" required>
                  </div>
                  <div class="form-group">
                      <label for="eventStartDate">تاريخ البدء</label>
                      <input type="date" id="eventStartDate" required>
                  </div>
                  <div class="form-group">
                      <label for="eventEndDate">تاريخ الانتهاء</label>
                      <input type="date" id="eventEndDate" required>
                  </div>
                  <div class="form-group">
                      <label for="eventType">نوع الحدث</label>
                      <select id="eventType" class="form-group input" style="padding: 10px; width: 100%;"><option value="task">مهمة</option><option value="appointment">موعد</option><option value="delivery">تسليم</option><option value="start_work">بدء عمل</option></select>
                  </div>
                  <div class="form-actions">
                      <button type="submit" class="btn">حفظ</button>
                      <button type="button" class="btn" id="deleteEventBtn" style="display: none; background-color: #ef4444;">حذف</button>
                  </div>
              </form>
          </div>
      </div>
  </div>

  <!-- Modal for event details -->
  <div id="eventDetailsModal" class="modal-container modal-hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content" style="max-width: 420px;">
          <div class="modal-header">
              <h3>تفاصيل الحدث</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <h2 id="eventDetailsTitle" style="margin-top: 0; font-size: 20px;"></h2>
              <div style="margin-bottom: 12px;">
                  <span style="font-size: 14px; color: var(--muted);">النوع:</span>
                  <span id="eventDetailsType" class="status-badge" style="margin-right: 8px;"></span>
              </div>
              <p style="font-size: 15px;"><strong><i class="fas fa-calendar-alt" style="margin-left: 6px; color: var(--muted);"></i>تاريخ البدء:</strong> <span id="eventDetailsStartDate"></span></p>
              <p style="font-size: 15px;"><strong><i class="fas fa-calendar-check" style="margin-left: 6px; color: var(--muted);"></i>تاريخ الانتهاء:</strong> <span id="eventDetailsEndDate"></span></p>
              
              <div class="form-actions" style="margin-top: 24px;">
                  <button type="button" class="btn" id="deleteEventDetailsBtn" style="background-color: #ef4444; margin-left: auto; margin-right: 0;">حذف</button>
                  <button type="button" class="btn ghost" id="analyzeEventDetailsBtn" style="color: #0ea5e9; border-color: #0ea5e9;"><i class="fas fa-robot"></i> تحليل</button>
                  <button type="button" class="btn" id="editEventDetailsBtn">تعديل</button>
              </div>
          </div>
      </div>
  </div>

  <!-- *** إضافة: نافذة منبثقة لإضافة/تعديل الديون *** -->
  <div id="debtModal" class="modal-container modal-hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
          <div class="modal-header">
              <h3 id="debtModalTitle">إضافة دين جديد</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <form id="debtForm">
                  <input type="hidden" id="debtId">
                  <div class="form-group">
                      <label for="debtPerson">اسم الشخص</label>
                      <input type="text" id="debtPerson" required placeholder="مثال: أحمد علي">
                  </div>
                  <div class="form-group">
                      <label for="debtAmount">المبلغ (د.ج)</label>
                      <input type="number" id="debtAmount" required>
                  </div>
                  <div class="form-group">
                      <label for="debtDueDate">تاريخ الاستحقاق (اختياري)</label>
                      <input type="date" id="debtDueDate">
                  </div>
                  <div class="form-group"><label for="debtNotes">ملاحظات</label><textarea id="debtNotes" rows="3" placeholder="تفاصيل إضافية عن الدين..."></textarea></div><div class="form-actions"><button type="submit" class="btn">حفظ</button><button type="button" class="btn" id="deleteDebtBtn" style="display: none; background-color: #ef4444;">حذف</button></div>
              </form>
          </div>
      </div>
  </div>


  <!-- Container for printing content -->
  <div id="printContainer" class="print-only" style="display: none;"></div>

  <!-- Container for toast notifications -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- *** إضافة: نافذة منبثقة لإدارة رموز PIN (مدمجة من pin.html) *** -->
  <div id="pinManagementModal" class="modal-container modal-hidden">
      <div class="modal-backdrop" data-action="close-modal"></div>
      <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header">
              <h3>إدارة رموز PIN للعمال</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body" id="pinManagementContent">
              <!-- Worker list for PIN management will be injected here -->
          </div>
      </div>
  </div>

  <!-- *** إضافة: نافذة منبثقة لتعيين/تعديل PIN (مدمجة من pin.html) *** -->
  <div id="pinEditModal" class="modal-container modal-hidden" style="z-index: 105;">
      <div class="modal-backdrop" data-action="close-modal"></div>
      <div class="modal-content" style="max-width: 380px;">
          <div class="modal-header">
              <h3 id="pinEditModalTitle">تعيين رمز PIN</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <form id="pinEditForm">
                  <input type="hidden" id="pinEditWorkerId">
                  <div class="form-group">
                      <label for="newPin">رمز PIN الجديد (4 أرقام)</label>
                      <input type="password" id="newPin" required pattern="\d{4}" maxlength="4" placeholder="اتركه فارغاً لإزالة الرمز">
                  </div>
                  <div class="form-actions">
                      <button type="submit" class="btn">حفظ الرمز</button>
                  </div>
              </form>
          </div>
      </div>
  </div>

  <!-- *** إضافة: نافذة منبثقة لتفعيل الاشتراك *** -->
  <div id="subscriptionModal" class="modal-container modal-hidden">
      <div class="modal-backdrop" data-action="close-modal"></div>
      <!-- *** تحسين: إعادة تصميم نافذة إدخال رمز الاشتراك *** -->
      <div class="modal-content" style="max-width: 420px;">
          <div class="modal-header">
              <h3>الترقية إلى النسخة الكاملة</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body" style="text-align: center;">
              <div class="icon" style="width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, #f59e0b, #d97706); font-size: 28px; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center;">
                  <i class="fas fa-gem"></i>
              </div>
              <p style="color: var(--muted); line-height: 1.6; margin-top: 0; margin-bottom: 24px;">
                  أدخل رمز التفعيل الذي حصلت عليه لفتح جميع الميزات الاحترافية في التطبيق.
              </p>
              <form id="subscriptionForm">
                  <div class="form-group">
                      <label for="subscriptionKeyInput" style="text-align: right;">رمز التفعيل</label>
                      <input type="text" id="subscriptionKeyInput" required placeholder="XXXX-XXXX-XXXX-XXXX" style="text-align: center; font-size: 18px; letter-spacing: 2px; font-weight: 700;">
                  </div>
                  <div id="subscriptionMessage" style="margin-top: 15px; text-align: center; font-weight: 700; min-height: 20px;"></div>
                  <div class="form-actions">
                      <button type="submit" id="activateSubscriptionBtn" class="btn" style="width: 100%; padding: 12px; font-size: 16px;">
                          <i class="fas fa-check-circle" style="margin-left: 8px;"></i> تفعيل الآن
                      </button>
                  </div>
              </form>
          </div>
      </div>
  </div>

  <!-- *** إضافة: نافذة منبثقة لإرسال الرسائل *** -->
  <div id="messageModal" class="modal-container modal-hidden">
      <div class="modal-backdrop" data-action="close-modal"></div>
      <div class="modal-content">
          <div class="modal-header">
              <h3>إرسال رسالة الى العمال</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <form id="messageForm">
                  <!-- *** تعديل: تم إزالة حقل اختيار العامل، حيث يتم الإرسال لنفس الحساب *** -->
                  <div class="form-group">
                      <label for="messageText">محتوى الرسالة</label>
                      <textarea id="messageText" rows="5" required placeholder="اكتب رسالتك هنا..."></textarea>
                  </div>
                  <div class="form-actions">
                      <button type="submit" class="btn">إرسال</button>
                  </div>
              </form>
          </div>
      </div>
  </div>

  <!-- *** إضافة: نافذة منبثقة احترافية لعرض تفاصيل الاشتراك *** -->
  <div id="subscriptionDetailsModal" class="modal-container modal-hidden">
      <div class="modal-backdrop" data-action="close-modal"></div>
      <div class="modal-content" style="max-width: 420px;">
          <div class="modal-header">
              <h3>تفاصيل اشتراكك</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body" id="subscriptionDetailsContent" style="line-height: 1.8;">
              <!-- سيتم حقن التفاصيل هنا بواسطة JavaScript -->
              <div style="text-align: center; padding: 20px;">
                  <div class="icon" style="width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, #10b981, #059669); font-size: 28px; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center;">
                      <i class="fas fa-shield-alt"></i>
                  </div>
                  <h4 style="margin: 0 0 4px;">النسخة الكاملة</h4>
                  <p style="color: var(--muted); margin-top: 0;">أنت تستمتع بجميع الميزات الاحترافية.</p>
              </div>
              <div id="subDetailsList">
                  <!-- سيتم حقن قائمة التفاصيل هنا -->
              </div>
          </div>
          <div class="form-actions" style="padding: 16px; border-top: 1px solid var(--border-color);">
              <button data-action="close-modal" class="btn ghost" style="width: 100%;">إغلاق</button>
          </div>
      </div>
  </div>

  <!-- *** إضافة: نافذة منبثقة لمراجعة البلاغات (للمدير) *** -->
  <div id="reportReviewModal" class="modal-container modal-hidden">
      <div class="modal-backdrop" data-action="close-modal"></div>
      <div class="modal-content" style="max-width: 450px;">
          <div class="modal-header">
              <h3>مراجعة بلاغ العامل</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body" id="reportReviewContent">
              <!-- تفاصيل البلاغ سيتم حقنها هنا -->
          </div>
          <div class="modal-footer" style="padding: 16px; border-top: 1px solid var(--border-color);">
              <form id="reportReviewForm">
                  <input type="hidden" id="reviewReportId">
                  <div class="form-group" style="margin-bottom: 12px;">
                      <label for="adminNote">ملاحظة المدير (اختياري)</label>
                      <textarea id="adminNote" rows="2" placeholder="أضف ملاحظة للعامل..."></textarea>
                  </div>
                  <div class="form-actions" style="margin-top: 0;">
                      <button type="button" id="rejectReportBtn" class="btn" style="background-color: #ef4444; margin-left: auto; margin-right: 0;"><i class="fas fa-times" style="margin-left: 6px;"></i> رفض</button>
                      <button type="button" id="approveReportBtn" class="btn" style="background-color: #10b981; margin-left: 0;"><i class="fas fa-check" style="margin-left: 6px;"></i> موافقة</button>
                  </div>
              </form>
          </div>
      </div>
  </div>









<script>
  // =================================================================
  // 1. CONFIGURATION & APP STATE
  // =================================================================
  // *** تحديث النظام: تمت مراجعة وتحديث الحزم بتاريخ 2024-05-22 ***
  // Firebase SDKs & Dexie.js are loaded via CDN with latest versions.
  // =================================================================
  
  // Your web app's Firebase configuration
  const firebaseConfig = {
      apiKey: "AIzaSyC52e_whkQh-vwgdwuuzl4wMpVxILXGkSQ",
      authDomain: "shoes-manager-pro.firebaseapp.com",
      projectId: "shoes-manager-pro",
      storageBucket: "shoes-manager-pro.firebasestorage.app",
      messagingSenderId: "951149272003",
      appId: "1:951149272003:web:85d665da99166298047b76"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const firestore = firebase.firestore(); // Initialize Firestore

  // --- Database Setup (Dexie.js) ---
  const db = new Dexie('decorManagerDB');
  // *** إصلاح: توحيد إصدار قاعدة البيانات إلى 23 وتصحيح مخطط جدول المشتريات ***
  // This version must match the worker app's version to avoid schema errors if they ever share a DB.
    db.version(25).stores({
      workers: '++id, name, pin, settlements',
      projects: '++id, name, status, builderName',
      suppliers: '++id, name',
      inventory: '++id, name, borrowerName',
      debts: '++id, type, dueDate', // جدول الديون الجديد
      calendarEvents: '++id, startDate, endDate',
      // *** إصلاح: تصحيح مخطط المشتريات ليشمل جميع الحقول ويستخدم firestoreId كمفتاح أساسي ***
      purchases: 'firestoreId, workerId, status, date',
      expenses: '++id, date, projectId, workerId, supplierId, category, paymentStatus',
      messages: '++id, receiverUid, timestamp', // *** إضافة: جدول للرسائل ***
      projectPayments: '++id, projectId, date',
      api_configs: '++id, name, provider', // New table for AI API configurations, added provider index
      companyProfiles: '++id, profileName', 
      reports: 'firestoreId, workerId, status, date', // *** إضافة: جدول للبلاغات ***
      notes: '++id, updatedAt',
      app_settings: 'key, subscriptionData' // A key-value store. Added subscriptionData for subscription info.
  }).upgrade(tx => { 
      // This upgrade function will run if the user's DB version is less than 25.
  });

  // *** إضافة: متغير لتتبع حالة فتح قاعدة البيانات ***
  let isDbOpen = false;

  // *** تعديل: استخدام معرّف جهاز دائم بدلاً من معرّف جلسة مؤقت ***
  function getOrCreateDeviceId() {
    let deviceId = localStorage.getItem('appDeviceId');
    if (!deviceId) {
        deviceId = `device_${Date.now()}_${Math.random()}`;
        localStorage.setItem('appDeviceId', deviceId);
    }
    return deviceId;
  }
  const deviceIdentifier = getOrCreateDeviceId();

  // حالة التطبيق (البيانات)
  let state = {
    previousView: null, // *** إضافة: لتتبع الواجهة السابقة ***
    currentView: { name: 'home', params: {} },
    projects: [],
    workers: [],
    suppliers: [],
    notes: [], // *** إصلاح: إضافة حالة لتخزين المهام ***
    inventory: [],
    debts: [], // *** إضافة: حالة لتخزين الديون ***
    reports: [], // *** إضافة: حالة لتخزين البلاغات ***
    projectPayments: [],
    messages: [], // *** إضافة: حالة لتخزين الرسائل ***
      hasActiveCalendarEvents: false, // *** إضافة: حالة لتتبع وجود أحداث نشطة في الجدول الزمني ***
      purchases: [], // *** إضافة: حالة لتخزين المشتريات للمراجعة ***
    calendarEvents: [],
    hasNewPurchases: false, // *** إضافة: حالة لتتبع إشعارات المشتريات الجديدة ***
    currentUser: null, // *** إضافة: لتخزين معلومات المستخدم الحالي ***
    hasNewReports: false, // *** إضافة: حالة لتتبع البلاغات الجديدة ***
    companyProfiles: [], 
    aiChatHistory: [], // *** إضافة: تهيئة سجل محادثة الذكاء الاصطناعي ***
    api_configs: []
  };

  // *** إضافة: متغير لمنع تكرار محاولة حذف الاشتراك المنتهي ***
  let hasAttemptedExpiredSubCleanup = false;

  // *** إضافة: متغير لتخزين دوال إلغاء الاشتراك في Firestore لمنع التكرار ***
  let firestoreUnsubscribeFunctions = [];

  // Temporary storage for multi-step modals
  let tempAttendanceData = {};

  // تعريف الوحدات الأساسية للتطبيق
  const appModules = [
    { 
      key: 'projects',
      title: 'إدارة المشاريع',
      description: 'عرض، إضافة، وتعديل المشاريع',
      icon: 'fa-hard-hat',
      color: 'linear-gradient(135deg,#06b6d4,#0284c7)',
    },
    {
      key: 'workers',
      title: 'سجل العمال',
      description: 'قائمة العمال وتسجيل أيام العمل',
      icon: 'fa-users',
      color: 'linear-gradient(135deg,#f97316,#f59e0b)',
    },
    {
      key: 'suppliers',
      title: 'قائمة الموردين',
      description: 'سجل الموردين وبيانات الاتصال',
      icon: 'fa-truck',
      color: 'linear-gradient(135deg,#10b981,#059669)',
    },
    {
      key: 'expenses', 
      title: 'إدارة النفقات', 
      description: 'تتبع وإدارة جميع نفقات المشاريع', 
      icon: 'fa-wallet', 
      color: 'linear-gradient(135deg,#ef4444,#dc2626)' 
    },
    {
      key: 'purchases',
      title: 'سجل المشتريات',
      description: 'تتبع وإدارة جميع المشتريات',
      icon: 'fa-shopping-cart',
      color: 'linear-gradient(135deg,#8b5cf6,#6366f1)'
    },
    // *** إضافة: وحدة جديدة لعرض بلاغات العمال ***
    {
      key: 'reportsDashboard',
      title: 'بلاغات العمال',
      description: 'مراجعة البلاغات الواردة من العمال',
      icon: 'fa-flag',
      color: 'linear-gradient(135deg,#3b82f6,#2563eb)',
    },
    {
      key: 'more_features',
      title: 'ميزات إضافية',
      description: 'أدوات تنظيمية متقدمة',
      icon: 'fa-layer-group', // *** تعديل: إضافة دالة التحقق من الإشعارات ***
      hasNotification: () => state.hasActiveCalendarEvents,
      color: 'linear-gradient(135deg,#64748b,#475569)',
    }
  ];

  const subModules = [
    { 
      key: 'my_info', 
      title: 'ملفاتي التعريفية', 
      description: 'إدارة معلومات الدفع والشركة', 
      icon: 'fa-user-tie', 
      color: 'linear-gradient(135deg,#a855f7,#9333ea)' 
    },
    { 
      key: 'ai_assistant', 
      title: 'مساعد الذكاء الاصطناعي', 
      description: 'الحصول على أفكار واقتراحات لمشاريعك', 
      icon: 'fa-robot', 
      color: 'linear-gradient(135deg,#0ea5e9,#0284c7)'
    },
    { key: 'calendar', title: 'الجدول الزمني', description: 'تنظيم مواعيد المشاريع والمهام', icon: 'fa-calendar-alt', color: 'linear-gradient(135deg,#ec4899,#d946ef)', hasNotification: () => state.hasActiveCalendarEvents },    
    { key: 'debts_feature', title: 'سجل الديون', description: 'تتبع ديونك وديون الآخرين', icon: 'fa-book-reader', color: 'linear-gradient(135deg,#8b5cf6,#7c3aed)' },
    { key: 'notes', title: 'ملاحظات سريعة', description: 'لتسجيل الأفكار والمقاسات', icon: 'fa-sticky-note', color: 'linear-gradient(135deg,#3b82f6,#2563eb)' },    {
      key: 'inventory',
      title: 'مخزون الأدوات',
      description: 'تتبع أدوات ومعدات العمل',
      icon: 'fa-toolbox',
      color: 'linear-gradient(135deg,#22c55e,#16a34a)'
    }
  ];

  const themes = {
    // Light Themes
    'default-light': { name: 'افتراضي فاتح', type: 'light', colors: { '--primary': '#0f766e', '--accent': '#f59e0b', '--bg': '#f8fafc', '--card': '#ffffff' } },
    'ocean-light': { name: 'محيط فاتح', type: 'light', colors: { '--primary': '#3b82f6', '--accent': '#f43f5e', '--bg': '#f0f9ff', '--card': '#ffffff' } },
    'forest-light': { name: 'غابة فاتحة', type: 'light', colors: { '--primary': '#16a34a', '--accent': '#d97706', '--bg': '#f0fdf4', '--card': '#ffffff' } },
    'sunset-light': { name: 'غروب فاتح', type: 'light', colors: { '--primary': '#f97316', '--accent': '#7c3aed', '--bg': '#fff7ed', '--card': '#ffffff' } },
    'neutral-light': { name: 'محايد فاتح', type: 'light', colors: { '--primary': '#475569', '--accent': '#0f766e', '--bg': '#f1f5f9', '--card': '#ffffff' } },
    // Dark Themes
    'default-dark': { name: 'افتراضي داكن', type: 'dark', colors: { '--primary': '#0d9488', '--accent': '#f59e0b', '--bg': '#071026', '--card': '#0b1220' } },
    'midnight-dark': { name: 'منتصف الليل', type: 'dark', colors: { '--primary': '#38bdf8', '--accent': '#f472b6', '--bg': '#020617', '--card': '#0f172a' } },
    'emerald-dark': { name: 'زمردي داكن', type: 'dark', colors: { '--primary': '#34d399', '--accent': '#facc15', '--bg': '#061e14', '--card': 'rgb(13, 39, 28)' } },
    'purple-dark': { name: 'بنفسجي داكن', type: 'dark', colors: { '--primary': '#a78bfa', '--accent': '#fb923c', '--bg': '#1e1b4b', '--card': '#312e81' } },
    'slate-dark': { name: 'أردوازي داكن', type: 'dark', colors: { '--primary': '#cbd5e1', '--accent': '#0ea5e9', '--bg': '#0f172a', '--card': '#1e293b' } },
  };
  // =================================================================
  // 2. DOM Elements
  // =================================================================
  const splash = document.getElementById('splash');
  const app = document.getElementById('app');
  const themeToggleHeader = document.getElementById('themeToggleHeader');
  const mainContent = document.getElementById('mainContent');
  const mainNav = document.getElementById('mainNav');
  
  // =================================================================
  // 3. CORE FUNCTIONS
  // =================================================================
  
  async function loadState() {
      const workerCount = await db.workers.count();
      if (workerCount === 0) {
          // Database is empty, seed with sample data
          await db.workers.add({ name: "عامل تجريبي", phone: "0555123456", dailyRate: 2000, attendance: [], bonuses: [], payments: [], imageUrl: '' });
          await db.projects.add({ name: "مشروع تجريبي: فيلا", budget: 500000, expenses: 120000 });
          await db.suppliers.add({ name: "مورد تجريبي", specialty: "دهانات" });
      }

      // Load all data into the state object
      state.workers = await db.workers.toArray();
      state.projects = await db.projects.toArray();
      state.suppliers = await db.suppliers.toArray();
      state.notes = await db.notes.toArray();
      state.projectPayments = await db.projectPayments.toArray();
      state.inventory = await db.inventory.toArray();
      state.debts = await db.debts.toArray();
      state.calendarEvents = await db.calendarEvents.toArray();
      state.purchases = await db.purchases.toArray();
      state.messages = await db.messages.toArray();
      state.expenses = await db.expenses.toArray();
      state.companyProfiles = await db.companyProfiles.toArray();
      state.reports = await db.reports.toArray(); // *** إضافة: تحميل البلاغات ***
      state.api_configs = await db.api_configs.toArray();
      // *** إضافة: تحميل معلومات الاشتراك من قاعدة البيانات المحلية ***
      const subscriptionInfo = await db.app_settings.get('subscriptionInfo');
      state.subscription = subscriptionInfo ? subscriptionInfo.value : null;

      
      // *** إصلاح: التحقق من وجود أحداث نشطة لم يتم الاطلاع عليها اليوم ***
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];
      const lastCalendarViewDate = localStorage.getItem('lastCalendarViewDate');

      if (lastCalendarViewDate !== todayStr) {
          today.setHours(0, 0, 0, 0); // تجاهل الوقت للمقارنة
          state.hasActiveCalendarEvents = state.calendarEvents.some(event => {
              const startDate = new Date(event.startDate);
              const endDate = new Date(event.endDate);
              startDate.setHours(0, 0, 0, 0);
              endDate.setHours(0, 0, 0, 0);
              return startDate <= today && endDate >= today;
          });
      } else {
          state.hasActiveCalendarEvents = false; // تم الاطلاع على إشعارات اليوم بالفعل
      }
      
      // Always start at home view
      // *** إضافة: التحقق من وجود مشتريات جديدة عند تحميل الحالة ***
      const lastChecked = parseInt(localStorage.getItem('lastCheckedPurchasesTimestamp') || '0');
      // *** إصلاح: استخدام دالة موحدة للتعامل مع أنواع التواريخ المختلفة ***
      const hasUnread = state.purchases.some(p => {
          if (p.status !== 'pending') return false;
          // استخدام الدالة المساعدة الجديدة للتعامل مع أنواع التواريخ المختلفة بأمان
          const purchaseTime = normalizeTimestamp(p.createdAt);
          return purchaseTime > lastChecked;
      });

      state.hasNewPurchases = hasUnread;
      state.currentView = { name: 'home', params: {} };
  }

  /**
   * *** إضافة: دالة للتحقق من وجود اشتراك فعال ***
   * تتحقق مما إذا كان المستخدم مسجلاً للدخول ولديه اشتراك نشط وغير منتهي.
   * @returns {boolean} True if the user has an active subscription.
   */
  function hasActiveSubscription() {
      const user = auth.currentUser;
      if (!user) return false; // يجب أن يكون مسجلاً للدخول

      const sub = state.subscription;
      if (!sub || !sub.isActive) return false; // يجب أن يكون لديه اشتراك فعال

      // التحقق من تاريخ انتهاء الصلاحية
      if (!sub.endDate) {
          return true; // No end date means it's active (e.g., lifetime)
      }

      const endDate = new Date(sub.endDate);
      const today = new Date();
      // *** تعديل: تجاهل الوقت وجعل الاشتراك ينتهي في بداية يوم الانتهاء ***
      today.setHours(0, 0, 0, 0); // ضبط تاريخ اليوم إلى بداية اليوم (00:00)
      if (today >= endDate) { // إذا كان اليوم هو يوم الانتهاء أو بعده، يعتبر الاشتراك منتهياً
          // *** إضافة: عند اكتشاف انتهاء الاشتراك، قم بتشغيل دالة الحذف ***
          if (!hasAttemptedExpiredSubCleanup) {
              handleExpiredSubscription();
              hasAttemptedExpiredSubCleanup = true; // منع المحاولة مرة أخرى في نفس الجلسة
          }
          return false;
      }

      return true; // مسجل ولديه اشتراك فعال وغير منتهي
  }

  /**
   * *** إضافة: دالة لحذف رمز التفعيل عند انتهاء الاشتراك ***
   * *** تعديل: ستقوم الدالة الآن بحذف بيانات الاشتراك من حساب المستخدم أيضاً ***
   * @param {string} keyToDelete The subscription key to delete from Firestore.
   */
  async function handleExpiredSubscription() {
      const user = auth.currentUser;
      if (!user) return;

      try {
           // *** تعديل: إزالة محاولة حذف رمز التفعيل من subscriptionKeys ***
           // المستخدم لا يملك صلاحية الحذف من هذه المجموعة، وهذا هو سبب الخطأ.
           // سنقوم فقط بحذف بيانات الاشتراك من مستند المستخدم نفسه.
          const userRef = firestore.collection('users').doc(user.uid);
 
           // حذف حقل الاشتراك من مستند المستخدم
           await userRef.update({
               subscription: firebase.firestore.FieldValue.delete()
           });
           console.log(`Expired subscription data removed for user: ${user.uid}`);
           showToast('تم تحديث حالة اشتراكك.');
      } catch (error) {
           console.error("Error cleaning up expired subscription:", error);
      }
  }

  async function applyThemeSet(themeName) {
    const theme = themes[themeName];
    if (!theme) return;

    // Apply light/dark class
    document.body.classList.toggle('dark', theme.type === 'dark');

    // Update header toggle icon
    const themeToggleHeader = document.getElementById('themeToggleHeader');
    if (themeToggleHeader) {
        themeToggleHeader.innerHTML = theme.type === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
    }

    // Apply CSS variables
    const root = document.documentElement;
    Object.entries(theme.colors).forEach(([key, value]) => {
        root.style.setProperty(key, value);
    });

    await db.app_settings.put({ key: 'selected_theme', value: themeName });
    state.selected_theme = themeName; // Update state immediately
  }

  async function toggleTheme() {
    const currentThemeName = state.selected_theme || 'default-light';
    const currentTheme = themes[currentThemeName];
    const newThemeName = (currentTheme.type === 'light') ? 'default-dark' : 'default-light';
    await applyThemeSet(newThemeName);
    // If on themes page, re-render to show change
    if (state.currentView.name === 'themes') renderView('themes');
  }
  
  async function renderView(viewName, params = {}) {
    // *** تحسين: التأكد من أن قاعدة البيانات مفتوحة قبل محاولة القراءة منها ***
    if (!isDbOpen) {
        console.log("Database not open yet, delaying renderView call...");
        // إذا لم تكن قاعدة البيانات مفتوحة، انتظر قليلاً ثم حاول مرة أخرى
        setTimeout(() => renderView(viewName, params), 100);
        return;
    }

    state.previousView = state.currentView; // *** إضافة: حفظ الواجهة الحالية قبل الانتقال ***
    state.currentView = { name: viewName, params };

    // *** إضافة: المرحلة الأولى - التحقق من تسجيل الدخول للوصول للميزات ***
    const isPublicView = ['home', 'settings', 'about', 'themes', 'backup_restore', 'factory_reset'].includes(viewName);
    if (!auth.currentUser && !isPublicView) {
        mainContent.innerHTML = `
            <div class="view-container" style="text-align: center; padding: 40px 20px;">
                <div style="font-size: 48px; color: var(--accent); margin-bottom: 16px;"><i class="fas fa-lock"></i></div>
                <h3 style="margin:0 0 8px;">الوصول مقيد</h3>
                <p style="color: var(--muted); line-height: 1.6;">يجب عليك <a href="login.html" style="color: var(--primary); font-weight: 700;">تسجيل الدخول</a> أولاً للوصول إلى هذه الميزة.</p>
            </div>`;
        return;
    }
    const currentView = mainContent.querySelector('.view-container');
    const transitionDuration = 250;

    // *** تحسين: إضافة try/catch لجلب البيانات لمعالجة أي أخطاء محتملة ***
    try {
        // Re-fetch data that might have changed, ensuring views are always fresh
        state.workers = await db.workers.toArray();
        state.projects = await db.projects.toArray();
        state.suppliers = await db.suppliers.toArray();
        state.notes = await db.notes.toArray();
        state.projectPayments = await db.projectPayments.toArray();
        state.inventory = await db.inventory.toArray();
        state.debts = await db.debts.toArray();
        state.calendarEvents = await db.calendarEvents.toArray();
      state.purchases = await db.purchases.toArray();
        state.expenses = await db.expenses.toArray();
        state.reports = await db.reports.toArray(); // *** إضافة: جلب البلاغات ***
        state.companyProfiles = await db.companyProfiles.toArray();
        state.api_configs = await db.api_configs.toArray();
    } catch (error) {
        console.error("Error fetching data in renderView:", error);
        mainContent.innerHTML = `<div class="view-container"><p style="color: #ef4444; text-align: center;">حدث خطأ أثناء تحميل بيانات الواجهة.</p></div>`;
        return; // إيقاف التنفيذ إذا فشل جلب البيانات
    }

    const renderNewContent = async () => {
        mainContent.innerHTML = '';
        let content = '';

        switch(viewName) {
            case 'home':          content = getHomeView(); break; 
            case 'projects':      content = getProjectsView(); break;
            case 'workers':       content = getWorkersView(); break;
            case 'project-details': content = getProjectDetailsView(params.id); break;
            case 'suppliers':     content = getSuppliersView(); break;
            case 'settings':      content = getSettingsView(); break;
            case 'reports':       content = getReportsView(); break;
            case 'more_features': content = getMoreFeaturesView(); break; 
            case 'calendar':      content = getCalendarView(); break;
            case 'expenses':      content = getExpensesView(); break;
            case 'debts_feature': content = getDebtsView(); break;
            case 'inventory':     content = getInventoryView(); break;
            case 'ai_assistant':  content = getAiAssistantView(); break;
            case 'notes':         content = getNotesView(); break;
            case 'worker-details':content = getWorkerDetailsView(params.id); break;
            case 'my_info':       content = getMyInfoView(); break;
            case 'profile-details': content = getProfileDetailsView(params.id); break;
            case 'expense-details': content = getExpenseDetailsView(params.id); break;
            case 'api_settings':  content = getApiSettingsView(); break;
            case 'factory_reset': content = getFactoryResetView(); break;
            case 'themes':        content = getThemesView(); break;
            case 'clear_cache':   content = getClearCacheView(); break; // *** إضافة: واجهة مسح الكاش ***
            case 'backup_restore': content = getBackupRestoreView(); break; // *** إضافة: واجهة النسخ الاحتياطي ***
            case 'about':         content = getAboutView(); break;
            case 'supplier-details': content = getSupplierDetailsView(params.id); break;
            case 'debt-details':  content = getDebtDetailsView(params.id); break; // *** إضافة: واجهة تفاصيل الدين ***
            case 'purchases':     content = getPurchasesView(); break; // *** إضافة: واجهة سجل المشتريات ***
            case 'reportsDashboard': content = getReportsDashboardView(); break; // *** إضافة: واجهة بلاغات العمال ***
            case 'inventory-details': content = getInventoryItemDetailsView(params.id); break;
            default:              content = `<h3>View Not Found: ${viewName}</h3>`;
        } 
        
        mainContent.innerHTML = `<div class="view-container">${content}</div>`;
        // *** إضافة: إخفاء إشعار المشتريات عند زيارة الصفحة ***
        if (viewName === 'purchases') {
            hidePurchasesNotification();
        }
        // *** إصلاح: إخفاء إشعار الجدول الزمني وتسجيل تاريخ الزيارة لمنع ظهوره مجدداً ***
        if (viewName === 'calendar' && state.hasActiveCalendarEvents) {
            state.hasActiveCalendarEvents = false;
            localStorage.setItem('lastCalendarViewDate', new Date().toISOString().split('T')[0]);
            updateNotificationDots(); // تحديث الواجهة لإزالة النقطة فوراً
        }
        // *** إضافة: إخفاء إشعار البلاغات عند زيارة الصفحة ***
        if (viewName === 'reportsDashboard') {
            state.hasNewReports = false;
            // لا يوجد شيء لحفظه في localStorage هنا، فقط تحديث الحالة
            updateNotificationDots();
        }
        
        if (viewName === 'settings') {
            document.getElementById('navigateToApiSettings')?.addEventListener('click', () => renderView('api_settings'));
            document.getElementById('navigateToThemes')?.addEventListener('click', () => renderView('themes'));
            document.getElementById('navigateToFactoryReset')?.addEventListener('click', () => renderView('factory_reset'));
            document.getElementById('navigateToBackupRestore')?.addEventListener('click', () => renderView('backup_restore'));
            document.getElementById('navigateToClearCache')?.addEventListener('click', () => renderView('clear_cache')); // *** إضافة: ربط زر مسح الكاش ***
            // *** إضافة: إظهار/إخفاء نقطة الإشعار على بطاقة النسخ الاحتياطي ***
            // *** تعديل: ربط زر إدارة PIN لفتح النافذة المنبثقة ***
            document.getElementById('managePinsBtn')?.addEventListener('click', openPinManagementModal);
            const backupCardDot = document.getElementById('backupRestoreCardDot');
            if (backupCardDot) {
                backupCardDot.style.display = document.getElementById('settingsNotificationDot').style.display;
            }
        }
        // *** إضافة: ربط زر مسح الكاش في واجهته الخاصة ***
        if (viewName === 'clear_cache') {
            document.getElementById('clearCacheBtn')?.addEventListener('click', handleClearCache);
        }
        if (viewName === 'backup_restore') {
            // After rendering the backup view, fetch the last backup date
            const user = auth.currentUser;
            if (user) {

                // *** تعديل: استخدام المسار الصحيح المتوافق مع قواعد Firestore ***
                firestore.collection('users').doc(user.uid).get().then(doc => {
                    const infoEl = document.getElementById('lastBackupInfo');
                    const restoreBtn = document.getElementById('restoreBtn');
                    // *** إصلاح: التحقق من وجود بيانات النسخ الاحتياطي قبل استخدامها ***
                    if (doc.exists && doc.data() && doc.data().backup && infoEl) {
                        const backupData = doc.data().backup;
                        const timestamp = backupData.backupTimestamp;
                        const date = timestamp ? timestamp.toDate().toLocaleString('ar-DZ') : 'غير معروف';
                        infoEl.textContent = `آخر نسخة احتياطية: ${date}`;
                        if (restoreBtn) restoreBtn.disabled = false;

                        if (backupData.backupTimestamp) { // Check if timestamp exists
                            const backupTime = backupData.backupTimestamp.toDate().getTime();
                            const lastSyncTime = parseInt(localStorage.getItem('lastBackupSyncTime') || '0');
                            const isFromAnotherDevice = backupData.lastUpdatedBy && backupData.lastUpdatedBy !== deviceIdentifier;
                            if (backupTime > lastSyncTime && isFromAnotherDevice) {
                                infoEl.innerHTML = `✨ تحديث جديد متوفر من جهاز آخر! <br><small>آخر نسخة احتياطية: ${date}</small>`;
                                restoreBtn.style.animation = 'pulse-animation 2s infinite';
                            }
                        }
                    } else if (infoEl) {
                        infoEl.textContent = 'لم يتم العثور على نسخة احتياطية في السحابة.';
                    }
                });
            }
            // *** إضافة: عند زيارة الصفحة، نعتبر أن المستخدم رأى الإشعار ***
            hideBackupNotification();
            // حفظ آخر وقت تمت فيه المزامنة (حتى لو لم يضغط استعادة)
            localStorage.setItem('lastBackupSyncTime', Date.now());
        }
        if (viewName === 'api_settings') {
            document.getElementById('addApiConfigBtn')?.addEventListener('click', () => openApiConfigModal());
            mainContent.querySelectorAll('[data-action="toggle-api-active"]').forEach(toggle => toggle.addEventListener('change', (e) => toggleActiveApi(parseInt(e.currentTarget.dataset.id))));
        }
        if (viewName === 'workers') {
            document.getElementById('addWorkerBtn')?.addEventListener('click', () => openWorkerModal());
            document.getElementById('syncWorkersBtn')?.addEventListener('click', syncWorkLogs);
            mainContent.querySelectorAll('[data-action="view-worker"]').forEach(card => card.addEventListener('click', async (e) => {
                // *** تعديل: منطق التحقق من PIN المحفوظ ***
                const workerId = parseInt(e.currentTarget.dataset.id);
                const worker = state.workers.find(w => w.id === workerId);

                // 1. إذا كان العامل لديه PIN
                if (worker && worker.pin) {
                    // 2. تحقق من localStorage (البنية الجديدة)
                    const rememberedPins = JSON.parse(localStorage.getItem('rememberedPins') || '{}');
                    const rememberedPin = rememberedPins[workerId];

                    // 3. إذا كان الـ PIN المحفوظ يطابق العامل الحالي
                    if (rememberedPin && rememberedPin === worker.pin) {
                        // الدخول مباشرة
                        renderView('worker-details', { id: workerId });
                    } else {
                        // إظهار نافذة إدخال PIN إذا لم يكن محفوظاً أو كان غير صحيح
                        openWorkerPinModal(workerId);
                    }
                } else {
                    // No PIN, go directly to details
                    renderView('worker-details', { id: workerId });
                }
            }));
        }
        if (viewName === 'pin_management') {
            document.getElementById('addWorkerBtn')?.addEventListener('click', () => openWorkerModal());
            mainContent.querySelectorAll('[data-action="edit-pin"]').forEach(btn => btn.addEventListener('click', (e) => openPinEditModal(parseInt(e.currentTarget.dataset.id))));
        }
        if (viewName === 'projects') {
            document.getElementById('addProjectBtn')?.addEventListener('click', () => openProjectModal());
            mainContent.querySelectorAll('[data-action="view-project"]').forEach(card => card.addEventListener('click', (e) => renderView('project-details', { id: parseInt(e.currentTarget.dataset.id) })));
        }
        if (viewName === 'worker-details') {
            document.getElementById('editWorkerBtn')?.addEventListener('click', (e) => openWorkerModal(parseInt(e.currentTarget.dataset.id)));
            document.getElementById('addWorkDayBtn')?.addEventListener('click', () => openActivityModal('attendance'));
            document.getElementById('analyzeWorkerBtn')?.addEventListener('click', (e) => handleAnalysisRequest('worker', parseInt(e.currentTarget.dataset.id)));
            document.getElementById('addBonusBtn')?.addEventListener('click', () => openActivityModal('bonus'));
            document.getElementById('addDeductionBtn')?.addEventListener('click', () => openActivityModal('deduction'));
            mainContent.querySelectorAll('.delete-activity').forEach(btn => btn.addEventListener('click', handleDeleteActivity));
            document.getElementById('backToWorkers')?.addEventListener('click', () => renderView('workers'));
            document.getElementById('settleMonthBtn')?.addEventListener('click', (e) => handleSettleMonth(parseInt(e.currentTarget.dataset.workerId), parseInt(e.currentTarget.dataset.year), parseInt(e.currentTarget.dataset.month)));
            document.getElementById('printReportBtn')?.addEventListener('click', (e) => printWorkerReport(e.currentTarget.dataset.id));
            document.getElementById('showFullLogBtn')?.addEventListener('click', (e) => openFullActivityLog(e.currentTarget.dataset.id));
        }
        if (viewName === 'supplier-details') {
            document.getElementById('editSupplierBtn')?.addEventListener('click', (e) => {
                if (!hasActiveSubscription()) { openModal('subscriptionModal'); return; }
                openSupplierModal(parseInt(e.currentTarget.dataset.id))
            });
            document.getElementById('analyzeSupplierBtn')?.addEventListener('click', (e) => handleAnalysisRequest('supplier', parseInt(e.currentTarget.dataset.id)));
            document.getElementById('backToSuppliers')?.addEventListener('click', () => renderView('suppliers'));
        }
        if (viewName === 'suppliers') {
            document.getElementById('addSupplierBtn')?.addEventListener('click', () => {
                if (!hasActiveSubscription()) {
                    openModal('subscriptionModal');
                    return;
                }
                openSupplierModal()
            });
            mainContent.querySelectorAll('[data-action="view-supplier"]').forEach(card => card.addEventListener('click', (e) => renderView('supplier-details', { id: parseInt(e.currentTarget.dataset.id) })));

        }
        if (viewName === 'notes') {
            mainContent.querySelectorAll('.note-card').forEach(card => card.addEventListener('click', (e) => openNoteModal(parseInt(e.currentTarget.dataset.id))));
            mainContent.querySelectorAll('[data-action="analyze-note"]').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); handleAnalysisRequest('note', parseInt(e.currentTarget.dataset.id)); }));
            setupInlineNoteForm();
        }
        if (viewName === 'inventory') {
            document.getElementById('addInventoryBtn')?.addEventListener('click', () => {
                if (!hasActiveSubscription()) {
                    openModal('subscriptionModal');
                    return;
                }
                openInventoryModal()
            });
            mainContent.querySelectorAll('[data-action="view-inventory-item"]').forEach(card => card.addEventListener('click', (e) => renderView('inventory-details', { id: parseInt(e.currentTarget.dataset.id) })));
            mainContent.querySelectorAll('[data-action="analyze-inventory-item"]').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); handleAnalysisRequest('inventory', parseInt(e.currentTarget.dataset.id)); }));
        }
        if (viewName === 'inventory-details') {
            document.getElementById('editInventoryBtn')?.addEventListener('click', (e) => {
                if (!hasActiveSubscription()) { openModal('subscriptionModal'); return; }
                openInventoryModal(parseInt(e.currentTarget.dataset.id))
            });
            document.getElementById('analyzeInventoryBtn')?.addEventListener('click', (e) => handleAnalysisRequest('inventory', parseInt(e.currentTarget.dataset.id)));
            document.getElementById('lendItemBtn')?.addEventListener('click', (e) => openLendModal(parseInt(e.currentTarget.dataset.id)));
            document.getElementById('returnItemBtn')?.addEventListener('click', (e) => handleReturnItem(parseInt(e.currentTarget.dataset.id)));
            document.getElementById('backToInventory')?.addEventListener('click', () => renderView('inventory'));
        }
        if (viewName === 'calendar') {
            document.getElementById('addEventBtn')?.addEventListener('click', () => openEventModal());
            // Open details modal instead of edit modal directly
            mainContent.querySelectorAll('.calendar-event, [data-action=\"view-event-details\"]').forEach(el => el.addEventListener('click', (e) => {
                openEventDetailsModal(parseInt(e.currentTarget.dataset.id));
            }));
        }
        if (viewName === 'my_info') {
            document.getElementById('addProfileBtn')?.addEventListener('click', () => {
                if (!hasActiveSubscription()) {
                    openModal('subscriptionModal');
                    return;
                }
                openProfileModal()
            });
            mainContent.querySelectorAll('[data-action="view-profile"]').forEach(card => card.addEventListener('click', (e) => renderView('profile-details', { id: parseInt(e.currentTarget.dataset.id) })));
        }
        if (viewName === 'profile-details') {
            document.getElementById('backToProfiles')?.addEventListener('click', () => renderView('my_info'));
            document.getElementById('editProfileBtn')?.addEventListener('click', (e) => openProfileModal(parseInt(e.currentTarget.dataset.id)));
            document.getElementById('analyzeProfileBtn')?.addEventListener('click', (e) => handleAnalysisRequest('profile', parseInt(e.currentTarget.dataset.id)));
            document.getElementById('saveProfileAsImageBtn')?.addEventListener('click', (e) => saveProfileAsImage(parseInt(e.currentTarget.dataset.id)));
        }
        if (viewName === 'about') {
            // No specific listeners needed for the about page for now
        }
        if (viewName === 'ai_assistant') {
            setupAiAssistantListeners();
        }
        if (viewName === 'factory_reset') {
            document.getElementById('factoryResetBtn')?.addEventListener('click', handleFactoryReset);
        }
        if (viewName === 'themes') {
            mainContent.querySelectorAll('.theme-card').forEach(card => card.addEventListener('click', async (e) => {
                await applyThemeSet(e.currentTarget.dataset.theme);
                renderView('themes'); // Re-render to show the active state
            }));
        }
        if (viewName === 'backup_restore') {
            mainContent.querySelectorAll('.theme-card').forEach(card => card.addEventListener('click', async (e) => {
                renderView('themes'); // Re-render to show the active state
            }));
        }
        if (viewName === 'debts_feature') {
            // Event handlers are now embedded in the HTML generated by getDebtsView
        }
        // *** إضافة: معالجات أحداث واجهة تفاصيل الدين ***
        if (viewName === 'debt-details') {
            document.getElementById('backToDebts')?.addEventListener('click', () => renderView('debts_feature'));
            document.getElementById('editDebtBtn')?.addEventListener('click', (e) => {
                if (!hasActiveSubscription()) { openModal('subscriptionModal'); return; }
                openDebtModal(parseInt(e.currentTarget.dataset.id))
            });
            document.getElementById('addDebtPaymentBtn')?.addEventListener('click', (e) => openDebtPaymentModal(parseInt(e.currentTarget.dataset.id)));
            document.getElementById('analyzeDebtBtn')?.addEventListener('click', (e) => handleAnalysisRequest('debt', parseInt(e.currentTarget.dataset.id)));
        }
    };

    const previouslyActiveNavItem = mainNav.querySelector('.nav-item.active');
    const isNewView = !previouslyActiveNavItem || previouslyActiveNavItem.dataset.view !== viewName;

    const isMainNavItem = [...mainNav.querySelectorAll('.nav-item')].some(item => item.dataset.view === viewName);
    if(isMainNavItem) {
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.toggle('active', item.dataset.view === viewName);
        });
    }


    if (currentView && isNewView) {
        currentView.classList.add('is-exiting');
        setTimeout(renderNewContent, transitionDuration);
    } else {
        renderNewContent();
    }
  }

  /**
   * Displays a temporary toast notification.
   * @param {string} message The message to display.
   */
  function showToast(message) {
      showCustomToast(message, 'success');
  }

  function showCustomToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      if (!container) return;

      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
      
      if (type === 'error') toast.classList.add('error');
      container.appendChild(toast);

      setTimeout(() => { toast.remove(); }, 3000);
  }
  // --- View Content Generators ---

  /**
   * *** إضافة: دالة لمعالجة تفعيل مفتاح الاشتراك ***
   * تتحقق من صحة المفتاح في Firestore، وتحدث حالة المفتاح، وتضيف بيانات الاشتراك للمستخدم.
   */
  async function handleSubscriptionActivation(e) {
      e.preventDefault();
      const keyInput = document.getElementById('subscriptionKeyInput');
      const messageEl = document.getElementById('subscriptionMessage');
      const activateBtn = document.getElementById('activateSubscriptionBtn');

      const subscriptionKey = keyInput.value.trim();
      messageEl.textContent = ''; // مسح الرسائل القديمة

      if (!subscriptionKey) {
          messageEl.textContent = 'الرجاء إدخال رمز الاشتراك.';
          messageEl.style.color = '#ef4444';
          return;
      }

      const user = auth.currentUser;
      if (!user) {
          messageEl.textContent = 'يجب تسجيل الدخول أولاً لتفعيل الاشتراك.';
          messageEl.style.color = '#ef4444';
          return;
      }

      activateBtn.disabled = true;
      activateBtn.textContent = 'جاري التحقق...';

      try {
          const keyRef = firestore.collection('subscriptionKeys').doc(subscriptionKey);
          const keyDoc = await keyRef.get();

          if (!keyDoc.exists) {
              throw new Error('رمز اشتراك غير صالح.');
          }

          const keyData = keyDoc.data();
          // *** تعديل: منع إعادة استخدام المفتاح حتى لو تم تغيير حالته يدوياً ***
          if (keyData.status === 'used' || keyData.usedBy) {
              throw new Error('هذا الرمز تم استخدامه مسبقاً.');
          }

          // حساب تاريخ الانتهاء
          const now = new Date();
          let endDate = new Date();
          if (keyData.type === 'daily') {
              endDate.setDate(now.getDate() + 1);
          } else if (keyData.type === 'monthly') {
              endDate.setMonth(now.getMonth() + 1);
          } else if (keyData.type === 'six-months') {
              endDate.setMonth(now.getMonth() + 6);
          } else if (keyData.type === 'yearly') {
              endDate.setFullYear(now.getFullYear() + 1);
          } else {
              throw new Error('نوع اشتراك غير معروف.');
          }

          // *** تعديل: ضبط وقت الانتهاء إلى بداية اليوم (00:00) لضمان الدقة في العرض والتحقق ***
          endDate.setHours(0, 0, 0, 0);

          const subscriptionData = {
              type: keyData.type, // *** تعديل: حفظ تاريخ ووقت البدء والانتهاء الكامل ***
              startDate: now.toISOString(),
              endDate: endDate.toISOString(),
              isActive: true,
              usedKey: subscriptionKey // *** إضافة: حفظ المفتاح المستخدم مع بيانات الاشتراك ***
          };

          // استخدام batch لضمان تنفيذ العمليتين معاً
          const batch = firestore.batch();
          const userRef = firestore.collection('users').doc(user.uid);
          // *** تعديل: تحديث حالة المفتاح بدلاً من حذفه، وربطه بالمستخدم ***
          batch.update(keyRef, { status: 'used', usedBy: user.uid, usedAt: firebase.firestore.FieldValue.serverTimestamp() });
          batch.set(userRef, { subscription: subscriptionData }, { merge: true });
          await batch.commit();

          messageEl.textContent = 'تم تفعيل الاشتراك بنجاح! سيتم إعادة تشغيل التطبيق.';
          messageEl.style.color = '#10b981';
          
          setTimeout(() => {
              // إعادة تحميل الصفحة بالكامل لتطبيق حالة الاشتراك الجديدة
              window.location.reload();
          }, 2000);
      } catch (error) {
          messageEl.textContent = error.message || 'حدث خطأ غير متوقع.';
          messageEl.style.color = '#ef4444';
      } finally {
          activateBtn.disabled = false;
          activateBtn.textContent = 'تفعيل الاشتراك';
      }
  }

  function createCardHTML(m) {
    // *** إضافة: إظهار نقطة الإشعار للمشتريات ***
    const showDot = (m.key === 'purchases' && state.hasNewPurchases) || 
                    (m.hasNotification && m.hasNotification()) ||
                    (m.key === 'reportsDashboard' && state.hasNewReports); // *** إضافة: إظهار إشعار للبلاغات ***

    // *** إضافة: التحقق من حالة الاشتراك لتقييد الوصول ***
    const isSubscribed = hasActiveSubscription();
    const isLoggedIn = !!auth.currentUser;
    // الميزة مقيدة إذا كان المستخدم مسجلاً دخوله ولكنه غير مشترك
    const isRestricted = isLoggedIn && !isSubscribed;

    // لا تقيد بطاقة "ميزات إضافية" لأنها تحتوي على ميزات مجانية ومدفوعة
    const featureIsAlwaysAccessible = ['more_features'].includes(m.key);
    const showLock = isRestricted && !featureIsAlwaysAccessible;

    return `
      <div class="card" data-key="${m.key}" style="${showLock ? 'opacity: 0.6; pointer-events: all;' : ''}" title="${showLock ? 'هذه الميزة تتطلب اشتراكاً فعالاً' : ''}">
        <div class="icon" style="background:${m.color}"><i class="fas ${m.icon}"></i></div>
        <div>
          <div style="font-weight:900; font-size: 16px;">${m.title}</div>
          <div style="color:var(--muted); font-size:13px; margin-top: 4px;">${m.description}</div>
        </div>
        <span class="notification-dot" style="display: ${showDot ? 'block' : 'none'};"></span>
        ${showLock ? `
            <div style="position: absolute; top: 10px; left: 10px; font-size: 18px; color: var(--accent); background: var(--card); padding: 4px; border-radius: 50%;">
                <i class="fas fa-lock"></i>
            </div>
        ` : ''}
      </div>
    `;
  }

  // *** إضافة: دالة مساعدة للتعامل مع أنواع التواريخ المختلفة (Firestore Timestamp, JS Date, etc.) ***
  function normalizeTimestamp(ts) {
      if (!ts) return 0;
      // إذا كان طابع زمني من Firestore
      if (typeof ts.toDate === 'function') return ts.toDate().getTime();
      // إذا كان كائن تاريخ JavaScript
      if (ts instanceof Date) return ts.getTime();
      // إذا كان رقم (timestamp)
      if (typeof ts === 'number') return ts;
      // محاولة تحويله كنص
      const parsed = Date.parse(ts);
      return isNaN(parsed) ? 0 : parsed;
  }

  // *** إضافة: دالة لتحديث نقاط الإشعارات على البطاقات دون إعادة رسم كامل ***
  function updateNotificationDots() {
      // *** إصلاح: توحيد منطق تحديث جميع نقاط الإشعارات ***
      document.querySelectorAll('.card[data-key]').forEach(cardEl => {
          const key = cardEl.dataset.key;
          const module = [...appModules, ...subModules].find(m => m.key === key);
          const dotEl = cardEl.querySelector('.notification-dot'); 
          if (dotEl) {
              // التحقق من جميع الحالات الممكنة لإظهار النقطة
              const showDot = 
                  (key === 'reportsDashboard' && state.hasNewReports) ||
                  (key === 'purchases' && state.hasNewPurchases) ||
                  (module && module.hasNotification && module.hasNotification());
              
              dotEl.style.display = showDot ? 'block' : 'none';
          }
      });
  }

  function getHomeView() {
    // *** تعديل: فصل بطاقة "ميزات إضافية" لجعلها بعرض كامل ***
    const regularModules = appModules.filter(m => m.key !== 'more_features');
    const moreFeaturesModule = appModules.find(m => m.key === 'more_features');

    const regularCardsHTML = regularModules.map(createCardHTML).join('');
    const moreFeaturesCardHTML = moreFeaturesModule ? `
      <div class="card full-width-card" data-key="${moreFeaturesModule.key}">
        <div style="display:flex; align-items:center; gap: 12px;">
          <div class="icon" style="background:${moreFeaturesModule.color}"><i class="fas ${moreFeaturesModule.icon}"></i></div>
          <div>
            <div style="font-weight:900; font-size: 16px;">${moreFeaturesModule.title}</div>
            <div style="color:var(--muted); font-size:13px; margin-top: 4px;">${moreFeaturesModule.description}</div>
          </div>
        </div>
        <i class="fas fa-chevron-left" style="color: var(--muted);"></i>
      </div>
    ` : '';

    // *** تعديل: إضافة اسم المستخدم إلى رسالة الترحيب ***
    const welcomeName = state.currentUser?.firstName ? ` ${state.currentUser.firstName}` : '';

    return `
      <section class="hero" aria-label="لوحة التحكم" style="padding: 20px; gap: 16px;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
              <h2 style="margin:0;font-weight:800">أهلاً بك${welcomeName}</h2>
              <p style="margin:6px 0 0;opacity:.95">نظرة سريعة على أعمالك الحالية.</p>
            </div>
            <button id="openSearchModalBtn" class="btn icon-btn" style="background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.2);" title="بحث شامل">
                <i class="fas fa-search"></i>
            </button>
        </div>
        <div class="kpis">
            <div class="kpi"><div style="font-size:18px;font-weight:800">${state.projects.length}</div><div style="font-size:12px;opacity:.9">إجمالي المشاريع</div></div>
            <div class="kpi"><div style="font-size:18px;font-weight:800">${state.workers.length}</div><div style="font-size:12px;opacity:.9">العمال النشطين</div></div>
        </div>
      </section>
      <!-- *** إضافة: بطاقة التاريخ والإجراءات السريعة *** -->
      <div class="card date-action-card" style="flex-direction: row; justify-content: space-between; align-items: center; text-align: right; margin-top: 16px; margin-bottom: 16px; padding: 16px; cursor: default; transform: none;">
        <div style="display:flex; align-items:center; gap: 12px;">
            <div class="icon" style="width:48px; height:48px; background: rgba(255,255,255,0.1); font-size: 20px; margin-bottom: 0;"><i class="fas fa-calendar-day"></i></div>
            <div>
                <div style="font-weight: 800; font-size: 16px;">${new Date().toLocaleDateString('ar-DZ', { weekday: 'long', day: 'numeric', month: 'long' })}</div>
                <div style="font-size: 13px; opacity: 0.8;">تاريخ اليوم</div>
            </div>
        </div>
        <div style="display: flex; gap: 8px;">
            <button onclick="openAiAssistantModal()" class="btn icon-btn" style="background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2);" title="مساعد الذكاء الاصطناعي">
                <i class="fas fa-robot"></i>
            </button>
            <button onclick="renderView(state.currentView.name, state.currentView.params)" class="btn icon-btn" style="background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2);" title="تحديث البيانات (Actualiser)">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
      </div>
      <div class="grid-cards">
        ${regularCardsHTML}
      </div>
      <div style="margin-top: 12px;">
        ${moreFeaturesCardHTML}
      </div>
    `;
  }

  function getMoreFeaturesView() {
    const subModulesHTML = subModules.map(createCardHTML).join('');
    
    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button onclick="renderView('home')" class="btn icon-btn" title="العودة للرئيسية"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">ميزات إضافية</h3>
        </div>
        <div class="grid-cards" style="margin-top:0;">
            ${subModulesHTML}
        </div>
    `;
  }
  
  function getProjectsView() { 
    const projectsListHTML = state.projects && state.projects.length > 0
        ? state.projects.map(project => {
            const statusStyles = {
                active: { text: 'نشط', bg: '#10b981', gradient: 'linear-gradient(135deg, #10b981, #059669)' },
                completed: { text: 'منتهي', bg: '#6366f1', gradient: 'linear-gradient(135deg, #6366f1, #4f46e5)' },
                default: { text: 'منتهي ', bg: '#64748b', gradient: 'linear-gradient(135deg, #64748b, #475569)' }
            };
            const status = project.status || 'active';
            const style = statusStyles[status] || statusStyles.default;
            return `
            <div class="card" data-action="view-project" data-id="${project.id}" style="flex-direction: row; justify-content: space-between; align-items: center; text-align: right; margin-bottom: 12px; padding: 12px 16px;">
                <div style="display:flex; align-items:center; gap: 12px;">
                    <div class="icon" style="width:48px; height:48px; background: linear-gradient(135deg,#06b6d4,#0284c7); font-size: 20px; margin-bottom: 0;"><i class="fas fa-hard-hat"></i></div>
                    <div>
                        <div style="font-weight: 700;">${project.name}</div>
                        <div class="status-badge" style="background: ${style.gradient}; display: inline-block; margin-top: 6px; font-size: 11px;">${style.text}</div>
                    </div>
                </div>
                <div style="text-align: left;">
                    <div style="font-weight: 700; font-size: 15px; color: var(--primary);">${(project.budget || 0).toLocaleString()} د.ج</div>
                    <div style="font-size: 12px; color: var(--muted);">الميزانية</div>
                </div>
            </div>
        `}).join('')
        : `<p style="text-align:center; color:var(--muted); padding: 20px;">لم يتم إضافة أي مشاريع بعد.</p>`;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button onclick="renderView('home')" class="btn icon-btn" title="العودة للرئيسية"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">إدارة المشاريع</h3>
            <div style="display: flex; gap: 8px;">
                <button id="addProjectBtn" class="btn icon-btn" title="إضافة مشروع" ${!hasActiveSubscription() && auth.currentUser ? 'disabled' : ''}><i class="fas fa-plus"></i></button>
            </div>
        </div>
        ${projectsListHTML}
    `;
  }
  
  function getSuppliersView() {
    const suppliersListHTML = state.suppliers && state.suppliers.length > 0
        ? state.suppliers.map(supplier => `
            <div class="card" data-action="view-supplier" data-id="${supplier.id}" style="flex-direction: row; justify-content: space-between; align-items: center; text-align: right; margin-bottom: 12px; padding: 12px 16px;">
                <div style="display:flex; align-items:center; gap: 12px;">
                    ${supplier.imageUrl
                        ? `<img src="${supplier.imageUrl}" alt="${supplier.name}" style="width:48px; height:48px; border-radius: 50%; object-fit: cover;">`
                        : `<div class="icon" style="width:48px; height:48px; background: linear-gradient(135deg,#10b981,#059669); font-size: 20px; margin-bottom: 0;"><i class="fas fa-truck"></i></div>`
                    }
                    <div>
                        <div style="font-weight: 700;">${supplier.name}</div>
                        <div style="font-size: 13px; color: var(--muted);">${supplier.specialty || 'لا يوجد تخصص'}</div>
                    </div>
                </div>
                <div style="text-align: left; font-size: 14px; color: var(--muted); direction: ltr;">${supplier.phone || ''}</div>
            </div>
        `).join('')
        : `<p style="text-align:center; color:var(--muted); padding: 20px;">لم يتم إضافة أي موردين بعد.</p>`;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button onclick="renderView('home')" class="btn icon-btn" title="العودة للرئيسية"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">قائمة الموردين</h3>
            <div style="display: flex; gap: 8px;">
                <button id="addSupplierBtn" class="btn icon-btn" title="إضافة مورد" ${!hasActiveSubscription() && auth.currentUser ? 'disabled' : ''}><i class="fas fa-plus"></i></button>
            </div>
        </div>
        ${suppliersListHTML}
    `;
  }

  function getSupplierDetailsView(supplierId) {
    const supplier = state.suppliers.find(s => s.id === supplierId);
    if (!supplier) return `<p>لم يتم العثور على المورد.</p><button onclick="renderView('suppliers')">العودة</button>`;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button id="backToSuppliers" class="btn icon-btn" title="العودة للموردين"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">تفاصيل المورد</h3>
        </div>

        <div class="card" style="cursor:default; transform:none; padding: 20px; align-items: stretch; text-align: right;">
            
            <div style="display: flex; align-items: center; gap: 16px; padding-bottom: 16px; margin-bottom: 16px; border-bottom: 1px solid var(--border-color);">
                ${supplier.imageUrl
                    ? `<img src="${supplier.imageUrl}" alt="${supplier.name}" style="width:64px; height:64px; border-radius: 50%; object-fit: cover; flex-shrink: 0;">`
                    : `<div class="icon" style="width:64px; height:64px; background: linear-gradient(135deg,#10b981,#059669); font-size: 28px; margin-bottom: 0; flex-shrink: 0;"><i class="fas fa-truck"></i></div>`
                }
                <div style="flex-grow: 1;">
                    <h2 style="margin: 0 0 4px; font-size: 20px;">${supplier.name}</h2>
                    <p style="margin: 0; color: var(--muted); font-size: 14px;">${supplier.specialty || 'تخصص غير محدد'}</p>
                </div>
                <div style="display: flex; gap: 8px; align-self: flex-start;">
                    <button id="analyzeSupplierBtn" data-id="${supplier.id}" class="btn icon-btn ghost" title="تحليل بالذكاء الاصطناعي" style="color: #0ea5e9; border-color: #0ea5e9;"><i class="fas fa-robot"></i></button>
                    <button id="editSupplierBtn" data-id="${supplier.id}" class="btn icon-btn ghost" title="تعديل"><i class="fas fa-edit"></i></button>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-size:13px; color:var(--muted);">رقم الهاتف</div>
                    <div style="font-weight:700; font-size:18px; direction: ltr; margin-top: 4px; text-align: right;">${supplier.phone || 'غير متوفر'}</div>
                </div>
                ${supplier.phone ? `
                <a href="tel:${supplier.phone}" class="btn" style="background-color: #10b981; padding: 10px 16px; font-size: 15px;">
                    <i class="fas fa-phone" style="margin-left: 8px;"></i> اتصال
                </a>` : ''}
            </div>

            ${supplier.notes ? `
            <div style="background: var(--bg); padding: 12px; border-radius: 8px; margin-top: 16px;">
                <div style="font-size:13px; color:var(--muted);">ملاحظات</div>
                <div style="font-weight:500; font-size:15px; margin-top: 4px; white-space: pre-wrap;">${supplier.notes}</div>
            </div>
            ` : ''}
        </div>
    `;
  }

  function getWorkersView() {
    const workersListHTML = state.workers && state.workers.length > 0
        ? state.workers.map(worker => {
            const { totalDue, totalPaid } = calculateWorkerFinancials(worker);
            const balance = totalDue - totalPaid;
            const workerColor = 'linear-gradient(135deg,#f97316,#f59e0b)';
            return `
            <div class="card" data-action="view-worker" data-id="${worker.id}" style="flex-direction: row; justify-content: space-between; align-items: center; text-align: right; margin-bottom: 12px; padding: 12px 16px;">
                <div style="display:flex; align-items:center; gap: 12px;">
                    ${worker.imageUrl
                        ? `<img src="${worker.imageUrl}" alt="${worker.name}" style="width:48px; height:48px; border-radius: 50%; object-fit: cover;">`
                        : `<div class="icon" style="width:48px; height:48px; background: ${workerColor}; font-size: 20px; margin-bottom: 0;"><i class="fas fa-user"></i></div>`
                    }
                    <div>
                        <div style="font-weight: 700;">${worker.name}</div>
                        <div style="font-size: 13px; color: var(--muted);">${worker.phone || 'لا يوجد رقم هاتف'}</div>
                    </div>
                </div>
                <div style="text-align: left;">
                    <div style="font-weight: 700; font-size: 15px; color: ${balance > 0 ? '#ef4444' : 'var(--primary)'};">${balance.toLocaleString()} د.ج</div>
                    <div style="font-size: 12px; color: var(--muted);">الرصيد الحالي</div>
                </div>
            </div>
        `}).join('')
        : `<p style="text-align:center; color:var(--muted); padding: 20px;">لم يتم إضافة أي عمال بعد.</p>`;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button onclick="renderView('home')" class="btn icon-btn" title="العودة للرئيسية"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">سجل العمال</h3>
            <div style="display: flex; gap: 8px;">
                <button id="addWorkerBtn" class="btn icon-btn" title="إضافة عامل" ${!hasActiveSubscription() && auth.currentUser ? 'disabled' : ''}><i class="fas fa-plus"></i></button>
                <button id="syncWorkersBtn" class="btn" title="مزامنة البيانات مع العمال" style="background-color: #3b82f6;" ${!hasActiveSubscription() && auth.currentUser ? 'disabled' : ''}><i class="fas fa-sync-alt"></i> مزامنة</button>
            </div>
        </div>
        ${workersListHTML}
    `;
  }

  function getWorkerDetailsView(workerId) {
    const worker = state.workers.find(w => w.id === workerId);
    if (!worker) return `<p>لم يتم العثور على العامل.</p><button id="backToWorkers">العودة</button>`;

    // For calendar
    const today = new Date();
    const currentMonth = state.currentView.params.month === undefined ? today.getMonth() : state.currentView.params.month;
    const currentYear = state.currentView.params.year === undefined ? today.getFullYear() : state.currentView.params.year;

    const { totalDue, totalPaid, presentDays, absentDays } = calculateWorkerFinancials(worker, currentYear, currentMonth);
    const balance = totalDue - totalPaid;

    const prevMonth = new Date(currentYear, currentMonth - 1, 1);
    const nextMonth = new Date(currentYear, currentMonth + 1, 1);

    // --- Settlement Card Logic ---
    const settlementKey = `${currentYear}-${currentMonth}`;
    const isSettled = (worker.settlements || []).includes(settlementKey);
    let settlementCardHTML = '';
    if (isSettled) {
        settlementCardHTML = `
            <div class="card" style="background-color: rgba(34, 197, 94, 0.1); color: #15803d; flex-direction: row; align-items: center; justify-content: center; gap: 10px; margin: 20px 0; cursor: default; transform: none;">
                <i class="fas fa-check-circle"></i>
                <span style="font-weight: 700;">تمت تسوية هذا الشهر بنجاح</span>
            </div>
        `; // The card should only appear if the balance is positive AND we are at or after the end of the month being viewed.
    } else if (balance > 0 && new Date() >= new Date(currentYear, currentMonth + 1, 0)) {
        settlementCardHTML = `
            <div class="settlement-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 800; font-size: 16px;">تسوية راتب الشهر</div>
                        <div style="opacity: 0.9; font-size: 14px;">الرصيد المتبقي: <strong>${balance.toLocaleString()} د.ج</strong></div>
                    </div>
                    <button id="settleMonthBtn" data-worker-id="${worker.id}" data-year="${currentYear}" data-month="${currentMonth}" class="btn" style="background: white; color: var(--accent);">تأكيد الدفع الكامل</button>
                </div>
            </div>`;
    }

    const calendarHTML = generateCalendar(currentMonth, currentYear, worker.attendance || []);
    const activityLogHTML = generateActivityLog(worker, 2, currentYear, currentMonth); // Show only 2 items from the current month

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button id="backToWorkers" class="btn icon-btn" title="العودة للعمال"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">${worker.name}</h3>
            <div style="display: flex; gap: 8px;">
                <button id="analyzeWorkerBtn" data-id="${worker.id}" class="btn icon-btn ghost" title="تحليل بالذكاء الاصطناعي" style="color: #0ea5e9; border-color: #0ea5e9;" ${!hasActiveSubscription() && auth.currentUser ? 'disabled' : ''}><i class="fas fa-robot"></i></button>
                <button id="editWorkerBtn" data-id="${worker.id}" class="btn icon-btn ghost" title="تعديل" ${!hasActiveSubscription() && auth.currentUser ? 'disabled' : ''}><i class="fas fa-edit"></i></button>
                <button id="printReportBtn" data-id="${worker.id}" class="btn icon-btn ghost" title="طباعة تقرير"><i class="fas fa-print"></i></button>
            </div>
        </div>

        <!-- Financial Summary -->
        <div class="grid-cards" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); margin-top:0; margin-bottom: 20px;">
            <div class="card" style="cursor:default; transform:none; text-align:right; align-items:flex-start; padding:12px;" title="مستحقات هذا الشهر فقط">
                <div style="font-size:13px; color:var(--muted);">إجمالي المستحقات</div>
                <div style="font-weight:800; font-size:18px; color:var(--primary);">${totalDue.toLocaleString()} د.ج</div>
            </div>
            <div class="card" style="cursor:default; transform:none; text-align:right; align-items:flex-start; padding:12px;">
                <div style="font-size:13px; color:var(--muted);">اجمالي الخصومات</div>
                <div style="font-weight:800; font-size:18px; color:#f97316;">${totalPaid.toLocaleString()} د.ج</div>
            </div>
            <div class="card" style="cursor:default; transform:none; text-align:right; align-items:flex-start; padding:12px;">
                <div style="font-size:13px; color:var(--muted);">الرصيد المتبقي</div>
                <div style="font-weight:800; font-size:18px; color:${balance > 0 ? '#ef4444' : 'var(--primary)'};">${balance.toLocaleString()} د.ج</div>
            </div>
        </div>

        <!-- Calendar -->
        <div class="card" style="cursor:default; transform:none; padding: 16px; margin-bottom: 20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; width:100%;">
                <button class="btn ghost" onclick="renderView('worker-details', {id: ${workerId}, month: ${prevMonth.getMonth()}, year: ${prevMonth.getFullYear()}})">‹</button>
                <h4 style="margin:0; font-weight:700;">${new Intl.DateTimeFormat('ar-DZ', { month: 'long', year: 'numeric' }).format(new Date(currentYear, currentMonth))}</h4>
                <button class="btn ghost" onclick="renderView('worker-details', {id: ${workerId}, month: ${nextMonth.getMonth()}, year: ${nextMonth.getFullYear()}})">›</button>
            </div>
            <div class="calendar">
                ${['ح', 'ن', 'ث', 'ر', 'خ', 'ج', 'س'].map(d => `<div class="calendar-header">${d}</div>`).join('')}
                ${calendarHTML}
            </div>
        </div>

        <!-- Settlement Card -->
        ${settlementCardHTML}

        <!-- Actions & Activity Log -->
        <div style="margin-bottom: 16px; display:flex; gap:10px;">
            <button id="addWorkDayBtn" class="btn" style="flex:1; background-color:#10b981;" ${!hasActiveSubscription() && auth.currentUser ? 'disabled' : ''}><i class="fas fa-calendar-check"></i> يوم عمل</button>
            <button id="addBonusBtn" class="btn" style="flex:1; background-color:#3b82f6;" ${!hasActiveSubscription() && auth.currentUser ? 'disabled' : ''}><i class="fas fa-star"></i> مكافأة</button>
            <button id="addDeductionBtn" class="btn" style="flex:1; background-color:#8b5cf6;" ${!hasActiveSubscription() && auth.currentUser ? 'disabled' : ''}><i class="fas fa-hand-holding-usd"></i> خصم</button>
        </div>
        
        <h4 style="margin: 24px 0 12px; font-weight:700;">أنشطة الشهر</h4>
        <div id="shortActivityLog">
            ${activityLogHTML}
        </div>
        <button id="showFullLogBtn" data-id="${worker.id}" class="btn" style="width: 100%; margin-top: 12px; background: var(--bg); color: var(--text-primary); border: 1px solid var(--border-color);">عرض السجل الكامل</button>
  `;
  }

  function generateCalendar(month, year, attendance) {
    let calendarHTML = '';
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    
    // Add empty cells for days before the 1st of the month
    for (let i = 0; i < firstDay; i++) {
        calendarHTML += `<div class="calendar-day not-in-month"></div>`;
    }

    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const record = attendance.find(a => a.date === dateStr);
        const statusClass = record ? record.status : ''; // 'present' or 'absent'
        calendarHTML += `<div class="calendar-day ${statusClass}">${day}</div>`;
    }
    return calendarHTML;
  }

  function generateActivityLog(worker, limit = null, year = null, month = null, format = 'html') {
    let combined = [
        ...(worker.attendance || []).map(a => ({ ...a, type: 'attendance' })),
        ...(worker.payments || []).map(p => ({ ...p, type: p.type || 'payment' })), // Ensure backward compatibility
        ...(worker.bonuses || []).map(b => ({ ...b, type: 'bonus' }))
    ].sort((a, b) => new Date(b.date) - new Date(a.date));

    if (year !== null && month !== null) {
        combined = combined.filter(item => {
            const itemDate = new Date(item.date);
            return itemDate.getFullYear() === year && itemDate.getMonth() === month;
        });
    }

    const itemsToRender = limit ? combined.slice(0, limit) : combined;

    if (itemsToRender.length === 0) {
        return format === 'html' ? `<p style="text-align:center; color:var(--muted);">لا توجد أنشطة مسجلة.</p>` : 'لا توجد أنشطة مسجلة.';
    }

    if (format === 'text') {
        return itemsToRender.map(item => {
            const date = new Date(item.date).toLocaleDateString('ar-DZ');
            if (item.type === 'attendance') return `${date}: ${item.status === 'present' ? `حضور (أجرة ${item.dailyRate || 0})` : 'غياب'}.`;
            if (item.type === 'bonus') return `${date}: مكافأة (${item.amount}) - ${item.note || ''}.`;
            if (item.type === 'deduction') return `${date}: خصم (${item.amount}) - ${item.note || ''}.`;
            return '';
        }).join('\n');
    }

    return itemsToRender.map((item, index) => {
        const date = new Intl.DateTimeFormat('ar-DZ', { day: '2-digit', month: 'long', year: 'numeric' }).format(new Date(item.date));
        if (item.type === 'attendance') {
            const isPresent = item.status === 'present';
            return `
            <div class="activity-log-item">
                <div style="display:flex; align-items:center;">
                    <div class="icon" style="color: ${isPresent ? '#16a34a' : '#ef4444'}; background: ${isPresent ? 'rgba(34,197,94,.1)' : 'rgba(239,68,68,.1)'};">
                        <i class="fas ${isPresent ? 'fa-check' : 'fa-times'}"></i>
                    </div>
                    <div>
                        <div style="font-weight:500;">${isPresent ? `يوم عمل - ${(item.dailyRate || 0).toLocaleString()} د.ج` : 'غياب'}</div>
                        <div style="font-size:13px; color:var(--muted);">${date}</div>
                    </div>
                </div>
                <button class="delete-activity" data-worker-id="${worker.id}" data-activity-id="${item.id}" data-type="attendance" title="حذف">&times;</button>
            </div>`
        } else { // Payment or Deduction
            const isDeduction = item.type === 'deduction';
            const title = `خصم / مصاريف: ${item.amount.toLocaleString()} د.ج`;
            const iconClass = isDeduction ? 'fa-hand-holding-usd' : 'fa-money-bill-wave';
            const iconColor = isDeduction ? '#8b5cf6' : '#f97316';
            const iconBg = isDeduction ? 'rgba(139,92,246,.1)' : 'rgba(249,115,22,.1)';

            if (item.type === 'bonus') {
                return `
                <div class="activity-log-item">
                    <div style="display:flex; align-items:center;">
                        <div class="icon" style="color: #3b82f6; background: rgba(59,130,246,.1);"><i class="fas fa-star"></i></div>
                        <div>
                            <div style="font-weight:500;">مكافأة: ${item.amount.toLocaleString()} د.ج</div>
                            <div style="font-size:13px; color:var(--muted);">${date}</div>
                            ${item.note ? `<div class="note"><i class="fas fa-quote-right" style="margin-left: 4px; opacity: 0.7;"></i> ${item.note}</div>` : ''}
                        </div>
                    </div>
                    <button class="delete-activity" data-worker-id="${worker.id}" data-activity-id="${item.id}" data-type="bonus" title="حذف">&times;</button>
                </div>`;
            }

            return `
            <div class="activity-log-item">
                <div style="display:flex; align-items:center;">
                    <div class="icon" style="color: ${iconColor}; background: ${iconBg};"><i class="fas ${iconClass}"></i></div>
                    <div>
                        <div style="font-weight:500;">${title}</div>
                        <div style="font-size:13px; color:var(--muted);">${date}</div>
                        ${item.note ? `<div class="note"><i class="fas fa-quote-right" style="margin-left: 4px; opacity: 0.7;"></i> ${item.note}</div>` : ''}
                    </div>
                </div>
                <button class="delete-activity" data-worker-id="${worker.id}" data-activity-id="${item.id}" data-type="${item.type}" title="حذف">&times;</button>
            </div>`;
        }
    }).join('');
  }

  function calculateWorkerFinancials(worker, year = null, month = null) {
    const filterByMonth = (item) => {
        // If year or month is null, we want the total, so we include all items.
        if (year === null || month === null) return true; 
        const itemDate = new Date(item.date);
        return itemDate.getFullYear() === year && itemDate.getMonth() === month;
    };

    // Use different variable names to avoid confusion
    const relevantAttendance = (worker.attendance || []).filter(filterByMonth);
    const relevantBonuses = (worker.bonuses || []).filter(filterByMonth);
    const relevantPayments = (worker.payments || []).filter(filterByMonth);

    const presentDays = relevantAttendance.filter(a => a.status === 'present').length;
    const absentDays = relevantAttendance.filter(a => a.status === 'absent').length;
    
    const earningsFromWork = relevantAttendance.filter(a => a.status === 'present').reduce((sum, day) => sum + (day.dailyRate || 0), 0);
    const totalBonuses = relevantBonuses.reduce((sum, b) => sum + b.amount, 0);
    const totalDue = earningsFromWork + totalBonuses;
    const totalPaid = relevantPayments.reduce((sum, p) => sum + p.amount, 0);

    return { totalDue, totalPaid, presentDays, absentDays };
  }

  function getProjectDetailsView(projectId) {
    const activeTab = state.currentView.params.tab || 'overview';
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return `<p>لم يتم العثور على المشروع.</p><button id="backToProjects">العودة</button>`;

    // Financial Calculations
    const clientPayments = state.projectPayments.filter(p => p.projectId === projectId);
    const totalReceived = clientPayments.reduce((sum, p) => sum + p.amount, 0);
    const projectExpenses = state.expenses.filter(e => e.projectId === projectId);
    // *** تحسين: حساب إجمالي النفقات المدفوعة فقط ***
    const totalExpenses = projectExpenses.filter(e => e.paymentStatus === 'paid').reduce((sum, e) => sum + e.amount, 0);
    // *** تحسين: تعديل الحسابات المالية حسب الطلب الجديد ***
    const budget = project.budget || 0;
    // *** إضافة: حساب "المتبقي على العميل" و "الرصيد الصافي" ***
    const remainingFromClient = budget - totalReceived;
    const netBalance = totalReceived - totalExpenses; // هذا هو الربح/الخسارة
    const budgetExceeded = totalExpenses > budget;

    // *** إضافة: إنشاء رسالة تحذير عند تجاوز الميزانية ***
    const budgetWarningHTML = budgetExceeded ? `
        <div style="background-color: rgba(239, 68, 68, 0.1); color: #dc2626; padding: 10px 15px; border-radius: 8px; text-align: center; font-weight: 700; margin-bottom: 16px;">
            <i class="fas fa-exclamation-triangle" style="margin-left: 8px;"></i>
            تحذير: تم تجاوز الميزانية بمبلغ ${(totalExpenses - budget).toLocaleString()} د.ج
        </div>
    ` : '';

    const overviewTabContent = `
        <!-- *** تحسين: إعادة تصميم بطاقات الملخص المالي لعرض 5 قيم *** -->
        <div class="grid-cards" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); margin-top:16px; margin-bottom: 20px;">
            <div class="card" style="cursor:default; transform:none; text-align:right; align-items:flex-start; padding:12px;">
                <div style="font-size:12px; color:var(--muted);">الميزانية</div>
                <div style="font-weight:800; font-size:16px; color:var(--primary);">${budget.toLocaleString()} د.ج</div>
            </div>
            <div class="card" style="cursor:default; transform:none; text-align:right; align-items:flex-start; padding:12px;">
                <div style="font-size:12px; color:var(--muted);">المستلم</div>
                <div style="font-weight:800; font-size:16px; color:#10b981;">${totalReceived.toLocaleString()} د.ج</div>
            </div>
            <div class="card" style="cursor:default; transform:none; text-align:right; align-items:flex-start; padding:12px;">
                <div style="font-size:12px; color:var(--muted);">إجمالي النفقات</div>
                <div style="font-weight:800; font-size:16px; color:${budgetExceeded ? '#ef4444' : '#f97316'};">${totalExpenses.toLocaleString()} د.ج</div>
            </div>
            <div class="card" style="cursor:default; transform:none; text-align:right; align-items:flex-start; padding:12px;">
                <div style="font-size:12px; color:var(--muted);">المتبقي على العميل</div>
                <div style="font-weight:800; font-size:16px; color:${remainingFromClient >= 0 ? 'var(--muted)' : '#ef4444'};">${remainingFromClient.toLocaleString()} د.ج</div>
            </div>
            <!-- *** إضافة: بطاقة جديدة لعرض الرصيد الصافي (الربح/الخسارة) *** -->
            <div class="card" style="cursor:default; transform:none; text-align:right; align-items:flex-start; padding:12px; background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(147, 51, 234, 0.1)); border-color: #a855f7;">
                <div style="font-size:12px; color:var(--muted);">الرصيد الصافي</div>
                <div style="font-weight:800; font-size:16px; color:${netBalance >= 0 ? '#a855f7' : '#ef4444'};">${netBalance.toLocaleString()} د.ج</div>
            </div>
        </div>
        <!-- *** إضافة: عرض معلومات صاحب المنزل وصاحب البناء *** -->
        <div class="card" style="cursor:default; transform:none; padding: 16px; align-items: stretch; text-align: right; margin-bottom: 16px;">
            <h4 style="margin: 0 0 12px; font-size: 14px; color: var(--muted);">معلومات إضافية</h4>
            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px;">
                <div style="font-size:14px; color:var(--muted);">صاحب المنزل:</div>
                <div style="font-weight:700; font-size:16px;">${project.homeownerName || 'غير محدد'}</div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: baseline;">
                <div style="font-size:14px; color:var(--muted);">صاحب البناء:</div>
                <div style="font-weight:700; font-size:16px;">${project.builderName || 'غير محدد'}</div>
            </div>
        </div>

        ${budgetWarningHTML}
    `;

    const paymentsListHTML = (limit) => clientPayments.slice(0, limit).map(p => `
        <!-- *** تحسين: عند الضغط يتم فتح نافذة التعديل/الحذف *** -->
        <div class="activity-log-item" style="cursor: pointer;" onclick="openProjectPaymentModal(${p.id}, ${projectId})">
            <div>
                <div style="font-weight: 700;">دفعة مستلمة من العميل</div>
                <div style="font-size: 13px; color: var(--muted);">${new Date(p.date).toLocaleDateString('ar-DZ')}</div>
            </div>
            <div style="font-weight: 700; font-size: 15px; color: #10b981;">+${p.amount.toLocaleString()} د.ج</div>
        </div>
    `).join('');

    const expensesListHTML = (limit) => projectExpenses.slice(0, limit).map(e => {
        const isMaterial = e.category === 'material';
        const icon = isMaterial ? 'fa-boxes' : 'fa-user-hard-hat';
        const linkedTo = e.supplierId ? state.suppliers.find(s => s.id === e.supplierId)?.name : (e.workerId ? state.workers.find(w => w.id === e.workerId)?.name : null);
        const paymentStatusHTML = isMaterial && e.paymentStatus === 'unpaid' ? `<span class="status-badge" style="background-color: #ef4444; font-size: 10px; margin-right: 8px;">غير مدفوع</span>` : '';

        return `
        <div class="activity-log-item">
            <div style="display:flex; align-items:center; gap: 12px; flex-grow: 1; cursor: pointer;" onclick="renderView('expense-details', {id: ${e.id}})">
                <div class="icon" style="width:36px; height:36px; font-size: 16px; margin:0; background: var(--bg); color: var(--muted);"><i class="fas ${icon}"></i></div>
                <div>
                    <div style="font-weight: 700; display: flex; align-items: center;">${paymentStatusHTML} ${e.description}</div>
                    ${linkedTo ? `<div style="font-size: 13px; color: var(--muted);"><i class="fas ${isMaterial ? 'fa-truck' : 'fa-user'}" style="margin-left: 4px;"></i> ${linkedTo}</div>` : ''}
                </div>
            </div>
            <div style="text-align: left; display: flex; align-items: center; gap: 8px;">
                <div style="font-weight: 700; font-size: 15px; color: #ef4444;">-${e.amount.toLocaleString()} د.ج</div>
                <!-- *** إضافة: زر تعديل النفقة مباشرة من القائمة *** -->
                <button class="btn ghost" data-action="edit-expense" data-id="${e.id}" data-context="project" style="padding: 4px 8px; font-size: 12px;">
                    <i class="fas fa-edit"></i>
                </button>
            </div>
        </div>`;}).join('');

    // *** تحسين: عرض آخر 3 دفعات فقط وإضافة زر "عرض المزيد" ***
    const limitedPaymentsHTML = clientPayments.length > 0
        ? paymentsListHTML(3) + (clientPayments.length > 3 ? `<button id="showAllPaymentsBtn" data-id="${projectId}" class="btn" style="width: 100%; margin-top: 12px; background: var(--bg); color: var(--text-primary); border: 1px solid var(--border-color);"><i class="fas fa-list-ul" style="margin-left: 8px;"></i> عرض الكل (${clientPayments.length})</button>` : '')
        : `<p style="text-align:center; color:var(--muted);">لم يتم تسجيل أي دفعات من العميل.</p>`;
    
    // *** تحسين: عرض آخر 3 نفقات فقط وإضافة زر "عرض المزيد" ***
    const limitedExpensesHTML = projectExpenses.length > 0
        // *** إضافة: زر "عرض الكل" للنفقات ***
        ? expensesListHTML(3) + (projectExpenses.length > 3 ? `<button id="showAllExpensesBtn" data-id="${projectId}" class="btn" style="width: 100%; margin-top: 12px; background: var(--bg); color: var(--text-primary); border: 1px solid var(--border-color);"><i class="fas fa-list-ul" style="margin-left: 8px;"></i> عرض الكل (${projectExpenses.length})</button>` : '')
        : `<p style="text-align:center; color:var(--muted);">لا توجد نفقات مسجلة لهذا المشروع.</p>`;

    const financeTabContent = ` 
        <div style="display:flex; justify-content:space-between; align-items:center; margin: 20px 0 12px;">
            <h4 style="margin:0; font-weight:700;">الدفعات المستلمة من العميل</h4>
            <button id="addProjectPaymentBtn" data-id="${project.id}" class="btn icon-btn" title="إضافة دفعة" style="background-color:#10b981;" ${!hasActiveSubscription() && auth.currentUser ? 'disabled' : ''}><i class="fas fa-plus"></i></button>
        </div>
        ${limitedPaymentsHTML}
        <div style="display:flex; justify-content:space-between; align-items:center; margin: 24px 0 12px;">
            <h4 style="margin:0; font-weight:700;">نفقات المشروع</h4>
            <button data-action="add-expense" data-project-id="${project.id}" class="btn icon-btn" title="إضافة نفقة" style="background-color:#ef4444;" ${!hasActiveSubscription() && auth.currentUser ? 'disabled' : ''}><i class="fas fa-plus"></i></button>
        </div>${limitedExpensesHTML} 
    `;

    // *** إضافة: زر "المشروع منتهي" يظهر فقط في حالة انتهاء المشروع ***
    const finishedProjectIndicatorHTML = project.status === 'finished'
        ? `<div class="card" style="cursor: pointer; transform: none; margin-top: 16px; background-color: rgba(34, 197, 94, 0.1);" id="reopenProjectBtn" data-id="${project.id}">
                <div style="color: #15803d; font-weight: 700; display: flex; align-items: center; gap: 8px;"><i class="fas fa-check-circle"></i> هذا المشروع منتهي (اضغط لإعادة التفعيل)</div>
           </div>` : '';

    // *** إضافة: إنشاء واجهة تبويب سجل الديون ***
    const unpaidExpenses = projectExpenses.filter(e => e.paymentStatus === 'unpaid');
    const debtsListHTML = unpaidExpenses.length > 0 ? unpaidExpenses.map(expense => {
        return `
            <!-- *** تحسين: عند الضغط يتم عرض تفاصيل النفقة (الدين) *** -->
            <div class="activity-log-item" style="cursor: pointer;" onclick="renderView('expense-details', {id: ${expense.id}})">
                <div>
                    <div style="font-weight: 700;">${expense.description}</div>
                    <div style="font-size: 13px; color: var(--muted);">${new Date(expense.date).toLocaleDateString('ar-DZ')}</div>
                </div>
                <div style="font-weight: 700; font-size: 15px; color: #ef4444;">-${expense.amount.toLocaleString()} د.ج</div>
            </div>
        `;
    }).join('') : `<p style="text-align:center; color:var(--muted);">لا توجد ديون مسجلة لهذا المشروع.</p>`;

    const debtsTabContent = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin: 20px 0 12px;">
            <h4 style="margin:0; font-weight:700;">سجل الديون (نفقات غير مدفوعة)</h4>
        </div>
        ${debtsListHTML}
    `;

    return `
        <!-- *** تحسين: نقل زر التعديل للأعلى وتغيير تصميمه *** -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button id="backToProjects" class="btn icon-btn" title="العودة للمشاريع"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; white-space: nowrap; text-align: right; flex-grow: 1;">${project.name}</h3>
            <div style="display: flex; flex-wrap: nowrap; gap: 8px; justify-content: flex-end;">
                <button id="analyzeProjectBtn" data-id="${project.id}" class="btn icon-btn ghost" title="تحليل بالذكاء الاصطناعي" style="color: #0ea5e9; border-color: #0ea5e9;" ${!hasActiveSubscription() && auth.currentUser ? 'disabled' : ''}><i class="fas fa-robot"></i></button>
                <button id="editProjectBtn" data-id="${project.id}" class="btn icon-btn ghost" title="تعديل المشروع" style="color: var(--primary); border-color: var(--primary);" ${!hasActiveSubscription() && auth.currentUser ? 'disabled' : ''}><i class="fas fa-edit"></i></button>
            </div>
        </div>

        <!-- *** تحسين: استخدام تصميم البطاقات الملونة للتبويبات *** -->
        <div class="tab-card-container">
            <div class="tab-card ${activeTab === 'overview' ? 'active' : ''}" data-tab="overview" style="background: linear-gradient(135deg, #64748b, #475569);"><i class="fas fa-chart-pie"></i><span>ملخص</span></div>
            <div class="tab-card ${activeTab === 'finance' ? 'active' : ''}" data-tab="finance" style="background: linear-gradient(135deg, #10b981, #059669);"><i class="fas fa-wallet"></i><span>المالية</span></div>
            <div class="tab-card ${activeTab === 'debts' ? 'active' : ''}" data-tab="debts" style="background: linear-gradient(135deg, #f97316, #ea580c);"><i class="fas fa-book"></i><span>سجل الديون</span></div>
        </div>

        <!-- Tab Content -->
        <div id="overviewTab" class="tab-content ${activeTab === 'overview' ? 'active' : ''}">${overviewTabContent}</div>
        <div id="financeTab" class="tab-content ${activeTab === 'finance' ? 'active' : ''}">${financeTabContent} ${finishedProjectIndicatorHTML}</div>
        <div id="debtsTab" class="tab-content ${activeTab === 'debts' ? 'active' : ''}">${debtsTabContent}</div>
    `;
}

  // *** إصلاح: تم نقل دوال المهام إلى هنا لضمان تعريفها قبل استخدامها ***
  function openTaskModal(taskId = null, projectId = null) {
      const modal = document.getElementById('taskModal');
      const form = document.getElementById('taskForm');
      const titleEl = document.getElementById('taskModalTitle');
      const deleteBtn = document.getElementById('deleteTaskBtn');
      const assignedToSelect = document.getElementById('taskAssignedTo');

      form.reset();
      deleteBtn.style.display = 'none';
      
      // If projectId is not passed, try to get it from the current view state
      const currentProjectId = projectId || state.currentView.params.id;
      document.getElementById('taskProjectId').value = currentProjectId;

      // تعبئة قائمة العمال
      assignedToSelect.innerHTML = state.workers.map(w => `<option value="${w.id}">${w.name}</option>`).join('');

      if (taskId) {
          const task = state.projectTasks.find(t => t.id === taskId);
          if (task) {
              titleEl.textContent = 'تعديل المهمة';
              document.getElementById('taskId').value = task.id;
              document.getElementById('taskTitle').value = task.title;
              document.getElementById('taskStatus').value = task.status;
              // تحديد العمال المسند إليهم
              (task.assignedTo || []).forEach(workerId => {
                  const option = assignedToSelect.querySelector(`option[value="${workerId}"]`);
                  if (option) option.selected = true;
              });
              deleteBtn.style.display = 'block';
          }
      } else {
          titleEl.textContent = 'إضافة مهمة جديدة';
          document.getElementById('taskId').value = '';
      }

      modal.style.display = 'flex';
  }

  function closeTaskModal() {
      document.getElementById('taskModal').style.display = 'none';
  }

  async function handleTaskFormSubmit(e) {
      e.preventDefault();
      try {
          const id = document.getElementById('taskId').value ? parseInt(document.getElementById('taskId').value) : null;
          const projectId = parseInt(document.getElementById('taskProjectId').value);
          
          const assignedTo = Array.from(document.getElementById('taskAssignedTo').selectedOptions).map(opt => parseInt(opt.value));

          const taskData = {
              projectId: projectId,
              title: document.getElementById('taskTitle').value,
              status: document.getElementById('taskStatus').value,
              assignedTo: assignedTo,
              createdAt: new Date().toISOString()
          };

          if (id) {
              await db.projectTasks.update(id, taskData);
          } else {
              await db.projectTasks.add(taskData);
          }
          closeTaskModal();
          await renderView('project-details', { id: projectId, tab: 'tasks' });
          showToast('تم حفظ المهمة بنجاح');
      } catch (error) {
          console.error('Error saving task:', error);
          showCustomToast('حدث خطأ أثناء حفظ المهمة', 'error');
      }
  }

  // *** إضافة: دالة لفتح نافذة عرض كل الدفعات ***
  function openAllPaymentsModal(projectId) {
      // إغلاق النوافذ الأخرى لتجنب التداخل 
    closeModal('allExpensesModal');

    const clientPayments = state.projectPayments.filter(p => p.projectId === projectId);

    // *** تحسين: استخدام جدول احترافي لعرض الدفعات ***
    const allPaymentsHTML = clientPayments.length > 0 ? `
        <table class="professional-table">
            <thead>
                <tr>
                    <th class="icon-cell"></th>
                    <th>التاريخ</th>
                    <th>الوصف</th>
                    <th class="amount-col">المبلغ</th>
                </tr>
            </thead>
            <tbody>
                ${clientPayments.map(p => `
                    <tr onclick="openProjectPaymentModal(${p.id}, ${projectId})">
                        <td class="icon-cell"><i class="fas fa-hand-holding-usd"></i></td>
                        <td>${new Date(p.date).toLocaleDateString('ar-DZ')}</td>
                        <td>${p.notes || 'دفعة مستلمة'}</td>
                        <td class="amount-col positive">+${p.amount.toLocaleString()} د.ج</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    ` : '<p style="text-align:center; color:var(--muted);">لا توجد دفعات مسجلة.</p>';

    document.getElementById('allPaymentsContent').innerHTML = allPaymentsHTML;
    openModal('allPaymentsModal');
  }

  // *** إضافة: دالة لفتح نافذة عرض كل النفقات ***
  function openAllExpensesModal(projectId) {
    // إغلاق النوافذ الأخرى لتجنب التداخل
    closeModal('allPaymentsModal');

    const projectExpenses = state.expenses.filter(e => e.projectId === projectId);

    // *** تحسين: استخدام جدول احترافي لعرض النفقات ***
    const allExpensesHTML = projectExpenses.length > 0 ? `
        <table class="professional-table">
            <thead><tr><th>التاريخ</th><th>الوصف</th><th class="amount-col">المبلغ</th></tr></thead>
            <tbody>
                ${projectExpenses.map(e => `
                    <!-- *** إصلاح: إضافة استدعاء لإغلاق النافذة عند النقر *** -->
                    <tr onclick="closeAllExpensesModal(); renderView('expense-details', {id: ${e.id}})">
                        <td>${new Date(e.date).toLocaleDateString('ar-DZ')}</td>
                        <td>${e.description}</td>
                        <td class="amount-col negative">-${e.amount.toLocaleString()} د.ج</td>
                    </tr>`).join('')}
            </tbody>
        </table>
    ` : '<p style="text-align:center; color:var(--muted);">لا توجد نفقات مسجلة.</p>';

    document.getElementById('allExpensesContent').innerHTML = allExpensesHTML;
    openModal('allExpensesModal');
  }
  
  // *** إضافة: دالة لإغلاق نافذة عرض كل النفقات ***
  function closeAllExpensesModal() {
      closeModal('allExpensesModal');
  }


  // *** إضافة: دالة لفتح نافذة السجل المالي الكامل ***
  function openProjectFullFinanceModal(projectId) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;

    const clientPayments = state.projectPayments.filter(p => p.projectId === projectId);
    const projectExpenses = state.expenses.filter(e => e.projectId === projectId);

    const paymentsHTML = clientPayments.length > 0 ? clientPayments.map(p => `
        <div class="activity-log-item" style="cursor: pointer;" onclick="openProjectPaymentModal(${p.id}, ${projectId})">
            <div>
                <div style="font-weight: 700;">دفعة مستلمة</div>
                <div style="font-size: 13px; color: var(--muted);">${new Date(p.date).toLocaleDateString('ar-DZ')}</div>
            </div>
            <div style="font-weight: 700; font-size: 15px; color: #10b981;">+${p.amount.toLocaleString()} د.ج</div>
        </div>`).join('') : '';

    const expensesHTML = projectExpenses.length > 0 ? projectExpenses.map(e => `
        <div class="activity-log-item" style="cursor: pointer;" onclick="renderView('expense-details', {id: ${e.id}})">
            <div>
                <div style="font-weight: 700;">${e.description}</div>
                <div style="font-size: 13px; color: var(--muted);">${new Date(e.date).toLocaleDateString('ar-DZ')}</div>
            </div>
            <div style="font-weight: 700; font-size: 15px; color: #ef4444;">-${e.amount.toLocaleString()} د.ج</div>
        </div>`).join('') : '';

    const fullLogHTML = `
        <h4 style="margin: 0 0 12px;">الدفعات المستلمة</h4>
        ${paymentsHTML || '<p style="text-align:center; color:var(--muted);">لا توجد دفعات.</p>'}
        <h4 style="margin: 24px 0 12px;">النفقات</h4>
        ${expensesHTML || '<p style="text-align:center; color:var(--muted);">لا توجد نفقات.</p>'}`;

    document.getElementById('projectFullFinanceContent').innerHTML = fullLogHTML;
    openModal('projectFullFinanceModal');

    // Attach listener to close other modals if they are open
    const allPaymentsModal = document.getElementById('allPaymentsModal');
    if (allPaymentsModal) closeModal('allPaymentsModal');
  }


  function getCalendarView() {
    const today = new Date();
    const currentMonth = state.currentView.params.month ?? today.getMonth();
    const currentYear = state.currentView.params.year ?? today.getFullYear();

    const prevMonth = new Date(currentYear, currentMonth - 1, 1);
    const nextMonth = new Date(currentYear, currentMonth + 1, 1);

    const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

    const eventTypes = {
        task: { text: 'مهمة', color: '#3b82f6' },
        appointment: { text: 'موعد', color: '#f59e0b' },
        delivery: { text: 'تسليم', color: '#10b981' },
        start_work: { text: 'بدء عمل', color: '#8b5cf6' }
    };

    let daysHTML = '';
    // Add empty cells for days before the 1st of the month
    for (let i = 0; i < firstDayOfMonth; i++) {
        daysHTML += `<div class="full-calendar-day not-in-month"></div>`;
    }

    // Add cells for each day of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const currentDate = new Date(currentYear, currentMonth, day);
        const dateStr = currentDate.toISOString().split('T')[0];

        // Find events that are active on this day
        const dayEvents = state.calendarEvents.filter(event => {
            const startDate = new Date(event.startDate);
            const endDate = new Date(event.endDate);
            // Normalize dates to ignore time part
            startDate.setHours(0, 0, 0, 0);
            endDate.setHours(0, 0, 0, 0);
            currentDate.setHours(0, 0, 0, 0);
            return currentDate >= startDate && currentDate <= endDate;
        });

        const eventsHTML = dayEvents.map(event => `
            <div class="calendar-event" data-action="view-event-details" data-id="${event.id}" style="background-color: ${eventTypes[event.type]?.color || '#64748b'};">
                ${event.title}
            </div>
        `).join('');

        daysHTML += `
            <div class="full-calendar-day">
                <div class="day-number">${day}</div>
                ${eventsHTML}
            </div>
        `;
    }

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button onclick="renderView('more_features')" class="btn icon-btn" title="العودة"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">الجدول الزمني</h3>
            <div style="display: flex; gap: 8px;">
                <button id="addEventBtn" class="btn icon-btn" title="إضافة حدث"><i class="fas fa-plus"></i></button>
            </div>
        </div>

        <div class="card" style="cursor:default; transform:none; padding: 16px; align-items: stretch;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; width:100%;">
                <button class="btn ghost" onclick="renderView('calendar', {month: ${prevMonth.getMonth()}, year: ${prevMonth.getFullYear()}})">‹ الشهر السابق</button>
                <h4 style="margin:0; font-weight:700;">${new Intl.DateTimeFormat('ar-DZ', { month: 'long', year: 'numeric' }).format(new Date(currentYear, currentMonth))}</h4>
                <button class="btn ghost" onclick="renderView('calendar', {month: ${nextMonth.getMonth()}, year: ${nextMonth.getFullYear()}})">الشهر التالي ›</button>
            </div>

            <div class="full-calendar-grid">
                <!-- Headers -->
                ${['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'].map(d => `<div class="full-calendar-header">${d}</div>`).join('')}
                
                <!-- Days -->
                ${daysHTML}
            </div>
        </div>
    `;
  }

  function getReportsView() { 
    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button onclick="renderView('home')" class="btn icon-btn" title="العودة للرئيسية"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">تقارير سريعة (قيد الإنشاء)</h3>
        </div>`; 
  }

  function getReportsDashboardView() {
    // *** تعديل: تصفية البلاغات لعرض فقط التي "قيد المراجعة" ***
    const pendingReports = state.reports ? state.reports.filter(r => r.status === 'pending') : [];

    const reportsListHTML = pendingReports.length > 0
        ? pendingReports.map(report => {
            const statusStyles = {
                pending: { text: 'قيد المراجعة', color: '#f59e0b' },
                approved: { text: 'تمت الموافقة', color: '#10b981' },
                rejected: { text: 'مرفوض', color: '#ef4444' }
            };
            const status = statusStyles[report.status] || { text: report.status, color: '#64748b' };
            return `
            <div class="report-card" data-id="${report.firestoreId}" style="border-right-color: ${status.color};">
                <div class="report-header">
                    <span class="report-worker-name">${report.workerName || 'عامل غير معروف'}</span>
                    <span class="status-badge" style="background-color: ${status.color};">${status.text}</span>
                </div>
                <p class="report-note">${report.note}</p>
                <div style="font-size: 12px; color: var(--muted); text-align: left; margin-top: 8px;">
                    ${new Date(normalizeTimestamp(report.date)).toLocaleDateString('ar-DZ')}
                </div>
            </div>
        `}).join('')
        : `<p style="text-align:center; color:var(--muted); padding: 20px;">لا توجد بلاغات جديدة للمراجعة.</p>`;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button onclick="renderView('home')" class="btn icon-btn" title="العودة للرئيسية"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">مراجعة بلاغات العمال</h3>
        </div>
        ${reportsListHTML}
    `;
  }
  
  function getExpensesView() {
    const today = new Date();
    const currentMonth = state.currentView.params.month === undefined ? today.getMonth() : state.currentView.params.month;
    const currentYear = state.currentView.params.year === undefined ? today.getFullYear() : state.currentView.params.year;
    const currentFilter = state.currentView.params.filter || 'all'; // 'all', 'paid', 'unpaid'

    const prevMonth = new Date(currentYear, currentMonth - 1, 1);
    const nextMonth = new Date(currentYear, currentMonth + 1, 1);

    const monthExpenses = state.expenses.filter(expense => {
        const expenseDate = new Date(expense.date);
        return expenseDate.getFullYear() === currentYear && expenseDate.getMonth() === currentMonth;
    });

    const filteredExpenses = monthExpenses.filter(e => currentFilter === 'all' || e.paymentStatus === currentFilter).sort((a, b) => new Date(b.date) - new Date(a.date));

    const totalMonthExpenses = filteredExpenses.reduce((sum, expense) => sum + expense.amount, 0);

    const filterButtonsHTML = `
        <div class="tab-card-container" style="margin-bottom: 20px;">
            <div class="tab-card ${currentFilter === 'all' ? 'active' : ''}" onclick="renderView('expenses', {filter: 'all', month: ${currentMonth}, year: ${currentYear}})" style="background: linear-gradient(135deg, #64748b, #475569);">
                <i class="fas fa-list"></i>
                <span>الكل</span>
            </div>
            <div class="tab-card ${currentFilter === 'paid' ? 'active' : ''}" onclick="renderView('expenses', {filter: 'paid', month: ${currentMonth}, year: ${currentYear}})" style="background: linear-gradient(135deg, #10b981, #059669);">
                <i class="fas fa-check-circle"></i>
                <span>المدفوعة</span>
            </div>
            <div class="tab-card ${currentFilter === 'unpaid' ? 'active' : ''}" onclick="renderView('expenses', {filter: 'unpaid', month: ${currentMonth}, year: ${currentYear}})" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                <i class="fas fa-exclamation-circle"></i>
                <span>غير المدفوعة</span>
            </div>
        </div>
    `;

    const expensesListHTML = filteredExpenses.length > 0
        ? filteredExpenses.map(expense => {
            const project = expense.projectId ? state.projects.find(p => p.id === expense.projectId) : null;
            const isUnpaid = expense.category === 'material' && expense.paymentStatus === 'unpaid';
            const supplier = expense.supplierId ? state.suppliers.find(s => s.id === expense.supplierId) : null;
            
            let linkedToHTML = project ? `<div style="font-size: 13px; color: var(--muted); margin-top: 4px;"><i class="fas fa-hard-hat" style="margin-left: 4px; opacity: 0.7;"></i> ${project.name}</div>` : '';
            const supplierHTML = supplier ? `<div style="font-size: 13px; color: var(--muted); margin-top: 4px;"><i class="fas fa-truck" style="margin-left: 4px; opacity: 0.7;"></i> ${supplier.name}</div>` : '';


            return `
                <div class="card" style="flex-direction: row; justify-content: space-between; align-items: center; text-align: right; margin-bottom: 12px; padding: 12px 16px;">
                    <div data-action="view-expense" data-id="${expense.id}" style="display:flex; align-items:center; gap: 12px; flex-grow: 1; cursor: pointer;">
                        ${expense.receiptUrl
                            ? `<img src="${expense.receiptUrl}" alt="إيصال" style="width:48px; height:48px; border-radius: 8px; object-fit: cover;">`
                            : `<div class="icon" style="width:48px; height:48px; background: linear-gradient(135deg,#ef4444,#dc2626); font-size: 20px; margin-bottom: 0;"><i class="fas fa-receipt"></i></div>`
                        }
                        <div style="flex-grow: 1;">
                            <div style="font-weight: 700;">${expense.description}</div>
                            ${linkedToHTML}
                            ${supplierHTML}
                        </div>
                    </div>
                    <div style="text-align: left; display: flex; align-items: center; gap: 8px;">
                        ${isUnpaid ? `<div class="status-badge" style="background-color: #ef4444; font-size: 10px; margin-bottom: 4px;">غير مدفوع</div>` : ''}
                        <div style="font-weight: 700; font-size: 15px; color: #ef4444;">${expense.amount.toLocaleString()} د.ج</div>
                        <!-- *** تحسين: إضافة سياق الزر ليعرف من أين تم النقر *** -->
                        <button class="btn ghost" data-action="edit-expense" data-id="${expense.id}" data-context="expenses" style="padding: 4px 8px; font-size: 12px;">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </div>`;
        }).join('')
        : `<p style="text-align:center; color:var(--muted); padding: 20px;">لا توجد مصاريف مسجلة لهذا الشهر.</p>`;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button onclick="renderView('home')" class="btn icon-btn" title="العودة للرئيسية"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">إدارة النفقات</h3>
            <div style="display: flex; gap: 8px;">
                <button data-action="add-expense" class="btn icon-btn" title="إضافة نفقة" ${!hasActiveSubscription() && auth.currentUser ? 'disabled' : ''}><i class="fas fa-plus"></i></button>
            </div>
        </div>

        <div class="card" style="cursor:default; transform:none; padding: 16px; margin-bottom: 20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; width:100%;">
                <button class="btn ghost" onclick="renderView('expenses', {month: ${prevMonth.getMonth()}, year: ${prevMonth.getFullYear()}})">‹</button>
                <h4 style="margin:0; font-weight:700;">${new Intl.DateTimeFormat('ar-DZ', { month: 'long', year: 'numeric' }).format(new Date(currentYear, currentMonth))}</h4>
                <button class="btn ghost" onclick="renderView('expenses', {month: ${nextMonth.getMonth()}, year: ${nextMonth.getFullYear()}})">›</button>
            </div>
            <div style="text-align: center; padding: 10px 0; border-top: 1px solid var(--border-color);">
                <div style="font-size: 14px; color: var(--muted);">إجمالي مصاريف الشهر</div>
                <div style="font-size: 22px; font-weight: 800; color: #ef4444;">${totalMonthExpenses.toLocaleString()} د.ج</div>
            </div>
        </div>

        <!-- أزرار التصفية -->
        <div class="filter-buttons" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px;">
            <div class="${currentFilter === 'all' ? 'active' : ''}" onclick="renderView('expenses', {month: ${currentMonth}, year: ${currentYear}, filter: 'all'})" 
                style="background: linear-gradient(135deg, #64748b, #475569); border-radius: 10px; padding: 8px; color: white; text-align: center; cursor: pointer; transition: transform 0.2s ease; display: flex; flex-direction: column; align-items: center; gap: 4px; box-shadow: ${currentFilter === 'all' ? '0 6px 12px rgba(0,0,0,0.1)' : 'none'}; transform: ${currentFilter === 'all' ? 'translateY(-3px)' : 'none'};">
                <i class="fas fa-list" style="font-size: 16px;"></i>
                <span style="font-weight: 700; font-size: 13px;">الكل</span>
            </div>
            <div class="${currentFilter === 'paid' ? 'active' : ''}" onclick="renderView('expenses', {month: ${currentMonth}, year: ${currentYear}, filter: 'paid'})" 
                style="background: linear-gradient(135deg, #10b981, #059669); border-radius: 10px; padding: 8px; color: white; text-align: center; cursor: pointer; transition: transform 0.2s ease; display: flex; flex-direction: column; align-items: center; gap: 4px; box-shadow: ${currentFilter === 'paid' ? '0 6px 12px rgba(0,0,0,0.1)' : 'none'}; transform: ${currentFilter === 'paid' ? 'translateY(-3px)' : 'none'};">
                <i class="fas fa-check-circle" style="font-size: 16px;"></i>
                <span style="font-weight: 700; font-size: 13px;">المدفوعة</span>
            </div>
            <div class="${currentFilter === 'unpaid' ? 'active' : ''}" onclick="renderView('expenses', {month: ${currentMonth}, year: ${currentYear}, filter: 'unpaid'})" 
                style="background: linear-gradient(135deg, #ef4444, #dc2626); border-radius: 10px; padding: 8px; color: white; text-align: center; cursor: pointer; transition: transform 0.2s ease; display: flex; flex-direction: column; align-items: center; gap: 4px; box-shadow: ${currentFilter === 'unpaid' ? '0 6px 12px rgba(0,0,0,0.1)' : 'none'}; transform: ${currentFilter === 'unpaid' ? 'translateY(-3px)' : 'none'};">
                <i class="fas fa-exclamation-circle" style="font-size: 16px;"></i>
                <span style="font-weight: 700; font-size: 13px;">غير المدفوعة</span>
            </div>
        </div>

        ${expensesListHTML}
    `;
  }

  function getExpenseDetailsView(expenseId) {
    const expense = state.expenses.find(e => e.id === expenseId);
    if (!expense) return `<p>لم يتم العثور على النفقة.</p><button id="backToExpenses">العودة</button>`;

    const project = expense.projectId ? state.projects.find(p => p.id === expense.projectId) : null;
    const supplier = expense.supplierId ? state.suppliers.find(s => s.id === expense.supplierId) : null;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <!-- *** تحسين: زر العودة الذكي *** -->
            <button onclick="goBackToPreviousView()" class="btn icon-btn" title="العودة"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">تفاصيل النفقة</h3>
            <div class="form-actions" style="margin: 0; padding: 0;">
                <!-- *** إصلاح: إضافة data-action ليعمل الزر مع Event Delegation وإزالة الـ ID غير الضروري *** -->
                <button data-action="edit-expense" data-id="${expense.id}" class="btn icon-btn ghost" title="تعديل"><i class="fas fa-edit"></i></button>
                <button id="analyzeExpenseBtn" data-id="${expense.id}" class="btn icon-btn ghost" title="تحليل" style="color: #0ea5e9; border-color: #0ea5e9;"><i class="fas fa-robot"></i></button>
                <button id="printExpenseBtn" data-id="${expense.id}" class="btn icon-btn ghost" title="طباعة"><i class="fas fa-print"></i></button>
            </div>
        </div>

        <div class="card" style="cursor:default; transform:none; padding: 20px; align-items: stretch; text-align: right;">
            
            ${expense.receiptUrl ? `
            <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
                <h4 style="margin: 0 0 12px; font-size: 14px; color: var(--muted);">صورة الإيصال</h4>
                <img src="${expense.receiptUrl}" alt="صورة الإيصال" style="width: 100%; max-width: 300px; border-radius: 12px; object-fit: cover; border: 1px solid var(--border-color); display: block; margin: 0 auto;">
            </div>
            ` : ''}

            <div style="margin-bottom: 12px;">
                <div style="font-size:14px; color:var(--muted);">وصف النفقة</div>
                <div style="font-weight:700; font-size:18px; margin-top: 4px;">${expense.description}</div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                <div style="font-size:14px; color:var(--muted);">المبلغ</div>
                <div style="font-weight:800; font-size:22px; color: #ef4444;">${expense.amount.toLocaleString()} د.ج</div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 12px;">
                <div style="font-size:14px; color:var(--muted);">التاريخ</div>
                <div style="font-weight:700; font-size:16px;">${new Date(expense.date).toLocaleDateString('ar-DZ', { dateStyle: 'long' })}</div>
            </div>

            ${project ? `
            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 12px;">
                <div style="font-size:14px; color:var(--muted);">المشروع المرتبط</div>
                <div style="font-weight:700; font-size:16px;"><i class="fas fa-hard-hat" style="margin-left: 6px; opacity: 0.7;"></i> ${project.name}</div>
            </div>
            ` : ''}

            ${expense.notes ? `
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                <div style="font-size:13px; color: var(--muted);">ملاحظات</div>
                <div style="font-weight:500; font-size:15px; margin-top: 4px; white-space: pre-wrap;">${expense.notes}</div>
            </div>` : ''}

            <!-- *** إضافة: عرض حالة الدفع في تفاصيل النفقة *** -->
            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 12px;">
                <div style="font-size:14px; color:var(--muted);">حالة الدفع</div>
                <div class="status-badge" style="background-color: ${expense.paymentStatus === 'paid' ? '#10b981' : '#ef4444'};">${expense.paymentStatus === 'paid' ? 'مدفوع' : 'غير مدفوع'}</div>
            </div>


        </div>
    `;
  }
  
  function getInventoryView() {
    const statusStyles = {
        available: { text: 'متوفر', bg: '#10b981' },
        in_use: { text: 'قيد الاستخدام', bg: '#f59e0b' },
        maintenance: { text: 'صيانة', bg: '#ef4444' },
    };

    const inventoryListHTML = state.inventory && state.inventory.length > 0
        ? state.inventory.map(item => `
            <div class="card" style="flex-direction: row; justify-content: space-between; align-items: center; text-align: right; margin-bottom: 12px; padding: 12px 16px; cursor: default; transform: none;">
                <div data-action="view-inventory-item" data-id="${item.id}" style="display:flex; align-items:center; gap: 12px; flex-grow: 1; cursor: pointer;">
                    ${item.imageUrl
                        ? `<img src="${item.imageUrl}" alt="${item.name}" style="width:48px; height:48px; border-radius: 50%; object-fit: cover;">`
                        : `<div class="icon" style="width:48px; height:48px; background: linear-gradient(135deg,#22c55e,#16a34a); font-size: 20px; margin-bottom: 0;"><i class="fas fa-toolbox"></i></div>`
                    }
                    <div>
                        <div style="font-weight: 700;">${item.name}</div>
                        <div style="font-size: 13px; color: var(--muted);">الكمية: ${item.quantity || 1}</div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
                    <button data-action="analyze-inventory-item" data-id="${item.id}" class="btn ghost" style="padding: 6px 10px; color: #0ea5e9; border-color: #0ea5e9;"><i class="fas fa-robot"></i></button>
                    <div class="status-badge" style="background-color: ${statusStyles[item.status]?.bg || '#64748b'};">
                        ${statusStyles[item.status]?.text || 'غير معروف'}
                    </div>
                </div>
            </div>
        `).join('')
        : `<p style="text-align:center; color:var(--muted); padding: 20px;">لا توجد أدوات في المخزون بعد.</p>`;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button onclick="renderView('more_features')" class="btn icon-btn" title="العودة"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">مخزون الأدوات</h3>
            <div style="display: flex; gap: 8px;">
                <button id="addInventoryBtn" class="btn icon-btn" title="إضافة أداة" ${!hasActiveSubscription() && auth.currentUser ? 'disabled' : ''}><i class="fas fa-plus"></i></button> 
            </div>
        </div>
        ${inventoryListHTML}
    `;
  }

  function getInventoryItemDetailsView(itemId) {
    const item = state.inventory.find(i => i.id === itemId);
    if (!item) return `<p>لم يتم العثور على الأداة.</p><button onclick="renderView('inventory')">العودة</button>`;

    const statusStyles = {
        available: { text: 'متوفر', bg: '#10b981' },
        in_use: { text: 'قيد الاستخدام', bg: '#f59e0b' },
        maintenance: { text: 'صيانة', bg: '#ef4444' },
    };

    let actionButtonHTML = '';
    if (item.status === 'available') {
        actionButtonHTML = `<button id="lendItemBtn" data-id="${item.id}" class="btn" style="width: 100%; background-color: #3b82f6; margin-top: 16px;" ${!hasActiveSubscription() && auth.currentUser ? 'disabled' : ''}><i class="fas fa-hand-holding" style="margin-left: 8px;"></i> إعارة الأداة</button>`;
    } else if (item.status === 'in_use') {
        actionButtonHTML = `<button id="returnItemBtn" data-id="${item.id}" class="btn" style="width: 100%; background-color: #10b981; margin-top: 16px;" ${!hasActiveSubscription() && auth.currentUser ? 'disabled' : ''}><i class="fas fa-undo" style="margin-left: 8px;"></i> تأكيد الاسترجاع</button>`;
    }

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button id="backToInventory" class="btn icon-btn" title="العودة للمخزون"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">تفاصيل الأداة</h3>
        </div>

        <div class="card" style="cursor:default; transform:none; padding: 20px; align-items: stretch; text-align: right;">
            <div style="display: flex; align-items: center; gap: 16px; padding-bottom: 16px; margin-bottom: 16px; border-bottom: 1px solid var(--border-color);">
                ${item.imageUrl
                    ? `<img src="${item.imageUrl}" alt="${item.name}" style="width:64px; height:64px; border-radius: 50%; object-fit: cover; flex-shrink: 0;">`
                    : `<div class="icon" style="width:64px; height:64px; background: linear-gradient(135deg,#22c55e,#16a34a); font-size: 28px; margin-bottom: 0; flex-shrink: 0;"><i class="fas fa-toolbox"></i></div>`
                }
                <div style="flex-grow: 1;">
                    <h2 style="margin: 0 0 4px; font-size: 20px;">${item.name}</h2>
                    <p style="margin: 0; color: var(--muted); font-size: 14px;">الكمية: ${item.quantity || 1}</p>
                </div>
                <div style="display: flex; gap: 8px; align-self: flex-start;">
                    <button id="analyzeInventoryBtn" data-id="${item.id}" class="btn icon-btn ghost" title="تحليل" style="color: #0ea5e9; border-color: #0ea5e9;" ${!hasActiveSubscription() && auth.currentUser ? 'disabled' : ''}><i class="fas fa-robot"></i></button>
                    <button id="editInventoryBtn" data-id="${item.id}" class="btn icon-btn ghost" title="تعديل" ${!hasActiveSubscription() && auth.currentUser ? 'disabled' : ''}><i class="fas fa-edit"></i></button>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <div style="font-size:14px; color:var(--muted);">الحالة الحالية:</div>
                <div class="status-badge" style="background-color: ${statusStyles[item.status]?.bg || '#64748b'};">${statusStyles[item.status]?.text || 'غير معروف'}</div>
            </div>

            ${item.status === 'in_use' && item.borrowerName ? `
            <div style="background: var(--bg); padding: 12px; border-radius: 8px; margin-top: 12px;">
                <div style="font-size:13px; color:var(--muted);">مُعارة إلى: <strong style="color: var(--text-primary);">${item.borrowerName}</strong></div>
                <div style="font-size:13px; color:var(--muted); margin-top: 4px;">تاريخ الإعارة: <strong style="color: var(--text-primary);">${new Date(item.borrowDate).toLocaleDateString('ar-DZ')}</strong></div>
            </div>` : ''}

            ${actionButtonHTML}
        </div>
    `;
  }
  
  function getNotesView() {
    // Sort notes by last updated time, descending
    const notesListHTML = state.notes && state.notes.length > 0
        ? state.notes.sort((a, b) => b.updatedAt - a.updatedAt).map(note => `
            <div class="note-card" data-id="${note.id}" style="border-top-color: ${note.color || 'var(--primary)'}; padding: 0;">
                <div data-action="view-note" style="padding: 16px; cursor: pointer;">
                    <h4 class="note-title">${note.title || 'ملاحظة بدون عنوان'}</h4>
                    <p class="note-content">${note.content ? note.content.replace(/\n/g, '<br>') : 'لا يوجد محتوى'}</p>
                </div>
                <div class="note-footer" style="padding: 8px 16px;">
                    <span style="font-size: 12px; color: var(--muted);">آخر تحديث: ${new Date(note.updatedAt).toLocaleDateString('ar-DZ')}</span>
                    <button data-action="analyze-note" data-id="${note.id}" class="btn ghost" style="padding: 4px 8px; font-size: 12px; color: #0ea5e9; border-color: #0ea5e9;"><i class="fas fa-robot"></i></button>
                </div>
            </div>
        `).join('')
        : ``;

    const emptyStateHTML = !notesListHTML ? `<p style="text-align:center; color:var(--muted); padding: 20px;">لا توجد ملاحظات. أضف ملاحظتك الأولى!</p>` : '';

    // Add a specific listener for the note content part to open the modal
    mainContent.querySelectorAll('[data-action="view-note"]').forEach(el => {
        el.addEventListener('click', (e) => {
            openNoteModal(parseInt(e.currentTarget.closest('.note-card').dataset.id));
        });
    });
    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button onclick="renderView('more_features')" class="btn icon-btn" title="العودة"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">ملاحظات سريعة</h3>
        </div>
        
        <!-- Inline Note Form -->
        <div id="addNoteFormContainer" class="add-note-container">
            <input type="text" id="newNoteTitle" placeholder="عنوان..." style="display: none;">
            <textarea id="newNoteContent" placeholder="اكتب ملاحظة..." rows="1"></textarea>
            <div id="newNoteActions" class="new-note-actions" style="display: none;">
                <div class="color-swatches">
                    <div class="swatch selected" data-color="#3b82f6" style="background: #3b82f6;"></div>
                    <div class="swatch" data-color="#10b981" style="background: #10b981;"></div>
                    <div class="swatch" data-color="#f59e0b" style="background: #f59e0b;"></div>
                    <div class="swatch" data-color="#ef4444" style="background: #ef4444;"></div>
                    <div class="swatch" data-color="#64748b" style="background: #64748b;"></div>
                </div>
                <button id="saveNewNoteBtn" class="btn">حفظ</button>
            </div>
        </div>

        <div class="notes-grid">
            ${notesListHTML}
        </div>
        ${emptyStateHTML}
    `;
  }

  
  function getSettingsView() {
    const isDark = document.body.classList.contains('dark');
    
    // *** إضافة: بناء واجهة عرض حالة الاشتراك ***
    // *** تحسين: إعادة تصميم بطاقة حالة الاشتراك لتكون أكثر احترافية ***
    let subscriptionStatusHTML = '';
    if (hasActiveSubscription()) {
        // --- الحالة: مشترك فعال ---
        const sub = state.subscription;
        const endDate = new Date(sub.endDate);
        const endDateFormatted = endDate.toLocaleDateString('ar-DZ', { day: 'numeric', month: 'long', year: 'numeric' });

        // حساب الأيام المتبقية
        const now = new Date();
        const remainingTime = endDate.getTime() - now.getTime();
        const remainingDays = Math.ceil(remainingTime / (1000 * 60 * 60 * 24));
        const remainingDaysText = remainingDays > 0 ? `${remainingDays} يوم` : 'أقل من يوم';

        subscriptionStatusHTML = `
            <div class="card" data-action="open-subscription-details" style="align-items:stretch; text-align:right; margin-bottom: 20px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(15, 118, 110, 0.1)); border-color: var(--primary);">
                <div style="display:flex; align-items:center; gap: 12px;">
                    <div class="icon" style="width:48px; height:48px; background: linear-gradient(135deg, #10b981, #059669); font-size: 20px; margin-bottom: 0;"><i class="fas fa-shield-alt"></i></div>
                    <div>
                        <div style="font-weight:800; font-size: 16px; color: #10b981;">أنت مشترك في النسخة الكاملة</div>
                        <div style="font-size:13px; color: var(--muted); margin-top: 4px;">ينتهي الاشتراك في: <strong>${endDateFormatted}</strong></div>
                    </div>
                    <i class="fas fa-chevron-left" style="color: var(--muted); align-self: center; margin-right: auto;"></i>
                </div>
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color); text-align: center; font-weight: 700; color: var(--primary);">
                    <i class="fas fa-hourglass-half" style="margin-left: 6px;"></i>الأيام المتبقية: ${remainingDaysText}
                </div>
            </div>
        `;
    } else if (state.subscription && state.subscription.endDate) {
        // الحالة: الاشتراك موجود ولكنه منتهي
        subscriptionStatusHTML = `
            <div class="card" style="cursor:default; transform:none; align-items:stretch; text-align:right; margin-bottom: 20px; background: rgba(245, 158, 11, 0.05); border-color: var(--accent);">
                <div style="display:flex; align-items:center; gap: 12px;">
                    <div class="icon" style="width:48px; height:48px; background: linear-gradient(135deg, #f59e0b, #d97706); font-size: 20px; margin-bottom: 0;"><i class="fas fa-exclamation-triangle"></i></div>
                    <div>
                        <div style="font-weight:800; font-size: 16px; color: var(--accent);">انتهت صلاحية اشتراكك</div>
                        <div style="font-size:13px; color: var(--muted); margin-top: 4px;">قم بتجديد اشتراكك للاستفادة من الميزات الكاملة.</div>
                    </div>
                </div>
            </div>
        `;
    } else {
        // الحالة: غير مشترك إطلاقاً
        subscriptionStatusHTML = `
            <div class="card" style="cursor:default; transform:none; align-items:stretch; text-align:right; margin-bottom: 20px; background: rgba(239, 68, 68, 0.05); border-color: #ef4444;">
                <div style="display:flex; align-items:center; gap: 12px;">
                    <div class="icon" style="width:48px; height:48px; background: linear-gradient(135deg, #ef4444, #b91c1c); font-size: 20px; margin-bottom: 0;"><i class="fas fa-lock"></i></div>
                    <div>
                        <div style="font-weight:800; font-size: 16px; color: #ef4444;">أنت تستخدم النسخة المجانية</div>
                        <div style="font-size:13px; color: var(--muted); margin-top: 4px;">قم بالترقية لفتح جميع الميزات الاحترافية.</div>
                    </div>
                </div>
            </div>
        `;
    }

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button onclick="renderView('home')" class="btn icon-btn" title="العودة للرئيسية"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">الإعدادات</h3>
        </div>

        <!-- *** إضافة: عرض حالة الاشتراك *** -->
        ${subscriptionStatusHTML}

        <!-- *** إضافة: بطاقة تفعيل الاشتراك *** -->
        <!-- *** تحسين: إعادة تصميم بطاقة تفعيل الاشتراك لتكون أكثر احترافية *** -->
        <div onclick="openModal('subscriptionModal')" class="card" style="align-items: stretch; text-align: right; flex-direction: column; margin-bottom: 12px; background: linear-gradient(135deg, #0f172a, #071026); color: white; padding: 20px; border: 1px solid var(--accent);">
            <div style="display:flex; align-items:center; gap: 16px;">
                <div class="icon" style="width:56px; height:56px; background: linear-gradient(135deg, #f59e0b, #d97706); font-size: 24px; margin-bottom: 0; flex-shrink: 0;">
                    <i class="fas fa-gem"></i>
                </div>
                <div style="flex-grow: 1;">
                    <div style="font-weight:800; font-size: 18px;">الترقية إلى النسخة الكاملة</div>
                    <div style="font-size:14px; color: #d1d5db; margin-top: 4px;">أدخل رمز التفعيل لفتح جميع الميزات الاحترافية.</div>
                </div>
            </div>
        </div>
        <div id="navigateToThemes" class="card" style="align-items:flex-start; text-align:right; flex-direction: row; justify-content: space-between; margin-bottom: 12px;">
            <div style="display:flex; justify-content:space-between; align-items:center; width: 100%;">
                <div style="display:flex; align-items:center; gap: 12px;">
                    <div class="icon" style="width:48px; height:48px; background: linear-gradient(135deg,#ec4899,#d946ef); font-size: 20px; margin-bottom: 0;"><i class="fas fa-palette"></i></div>
                    <div>
                        <div style="font-weight:700;">تخصيص الثيمات</div>
                        <div style="font-size:13px; color: var(--muted)">تغيير ألوان ومظهر التطبيق</div>
                    </div>
                </div>
                <i class="fas fa-chevron-left" style="color: var(--muted); align-self: center;"></i>
            </div>
        </div>

        <div id="navigateToApiSettings" class="card" style="align-items:flex-start; text-align:right; flex-direction: row; justify-content: space-between; margin-top: 12px;">
            <div style="display:flex; align-items:center; gap: 12px;">
                <div class="icon" style="width:48px; height:48px; background: linear-gradient(135deg,#0ea5e9,#0284c7); font-size: 20px; margin-bottom: 0;"><i class="fas fa-robot"></i></div>
                <div style="flex: 1 1 0%;">
                    <div style="font-weight:700;">إعدادات مساعد الذكاء الاصطناعي</div>
                    <div style="font-size:13px; color: var(--muted)">إدارة مفاتيح API الخاصة بك</div>
                </div>
            </div>
            <i class="fas fa-chevron-left" style="color: var(--muted); align-self: center;"></i>
        </div>

        <!-- *** إضافة: بطاقة النسخ الاحتياطي والاستعادة *** -->
        <div id="navigateToBackupRestore" class="card" style="align-items:flex-start; text-align:right; flex-direction: row; justify-content: space-between; margin-top: 12px;">
            <div style="display:flex; align-items:center; gap: 12px;">
                <div class="icon" style="width:48px; height:48px; background: linear-gradient(135deg,#3b82f6,#2563eb); font-size: 20px; margin-bottom: 0; position: relative;">
                    <i class="fas fa-database"></i>
                    <span class="notification-dot" id="backupRestoreCardDot" style="top: -2px; right: -2px;"></span>
                </div>
                <div>
                    <div style="font-weight:700;">النسخ الاحتياطي والاستعادة</div>
                    <div style="font-size:13px; color: var(--muted)">حفظ نسخة من بياناتك أو استعادتها</div>
                </div>
            </div>
            <i class="fas fa-chevron-left" style="color: var(--muted); align-self: center;"></i>
        </div>

        <!-- *** تعديل: تحويل الرابط إلى زر يفتح نافذة منبثقة *** -->
        <div id="managePinsBtn" class="card" style="align-items:flex-start; text-align:right; flex-direction: row; justify-content: space-between; margin-top: 12px;">
            <div style="display:flex; align-items:center; gap: 12px;">
                <div class="icon" style="width:48px; height:48px; background: linear-gradient(135deg,#f97316,#f59e0b); font-size: 20px; margin-bottom: 0;"><i class="fas fa-key"></i></div>
                <div>
                    <div style="font-weight:700;">إدارة رموز PIN للعمال</div>
                    <div style="font-size:13px; color: var(--muted)">تعيين أو مسح رموز الدخول للعمال</div>
                </div>
            </div>
            <i class="fas fa-chevron-left" style="color: var(--muted); align-self: center;"></i>
        </div>

        <!-- *** إضافة: بطاقة مسح ذاكرة التخزين المؤقت (تم نقلها إلى هنا) *** -->
        <div id="navigateToClearCache" class="card" style="align-items:flex-start; text-align:right; flex-direction: row; justify-content: space-between; margin-top: 12px; margin-bottom: 12px;">
            <div style="display:flex; align-items:center; gap: 12px;">
                <div class="icon" style="width:48px; height:48px; background: linear-gradient(135deg,#f43f5e,#be123c); font-size: 20px; margin-bottom: 0;"><i class="fas fa-broom"></i></div>
                <div>
                    <div style="font-weight:700;">مسح ذاكرة التخزين المؤقت</div>
                    <div style="font-size:13px; color: var(--muted)">حل المشاكل وإعادة تحميل البيانات</div>
                </div>
            </div>
            <i class="fas fa-chevron-left" style="color: var(--muted); align-self: center;"></i>
        </div>


        <div id="navigateToFactoryReset" class="card" style="align-items:flex-start; text-align:right; flex-direction: row; justify-content: space-between; margin-top: 12px; border-top: 2px solid #ef4444;">
            <div style="display:flex; align-items:center; gap: 12px;">
                <div class="icon" style="width:48px; height:48px; background: linear-gradient(135deg,#ef4444,#b91c1c); font-size: 20px; margin-bottom: 0;"><i class="fas fa-power-off"></i></div>
                <div>
                    <div style="font-weight:700; color: #ef4444;">إعادة ضبط المصنع</div>
                    <div style="font-size:13px; color: var(--muted)">حذف جميع البيانات والعودة للحالة الأولية</div>
                </div>
            </div>
            <i class="fas fa-chevron-left" style="color: var(--muted); align-self: center;"></i>
        </div>
    `;
  }

  // *** إضافة: دالة لإنشاء واجهة مسح الكاش ***
  function getClearCacheView() {
    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button onclick="renderView('settings')" class="btn icon-btn" title="العودة للإعدادات"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; color: #f43f5e; text-align: right; flex-grow: 1;">مسح ذاكرة التخزين المؤقت</h3>
        </div>

        <div class="card" style="cursor:default; transform:none; padding: 20px; align-items: center; text-align: center; border-color: #f43f5e;">
            <div style="font-size: 48px; color: #f43f5e; margin-bottom: 16px;"><i class="fas fa-exclamation-triangle"></i></div>
            <h4 style="margin: 0 0 8px; font-size: 18px;">إجراء مهم</h4>
            <p style="color: var(--muted); line-height: 1.7; max-width: 400px; margin-bottom: 24px;">
                <strong>نصيحة:</strong> استخدم هذه الميزة إذا واجهت مشاكل في عرض البيانات أو سلوكاً غير متوقع في التطبيق.
                سيؤدي مسح الكاش إلى حذف البيانات المؤقتة وإجبار التطبيق على إعادة تحميل أحدث المعلومات من السحابة عند التحديث.
                <strong>لن يتم حذف بياناتك الأساسية.</strong>
            </p>
            <button id="clearCacheBtn" class="btn" style="background-color: #f43f5e; padding: 10px 24px; font-size: 16px; gap: 8px;">
                <i class="fas fa-broom" style="margin-left: 8px;"></i> نعم، أفهم وأريد مسح الكاش
            </button>
        </div>
    `;
  }

  // *** إضافة: دالة لتنفيذ مسح الكاش ***
  function handleClearCache() {
      openConfirmModal('هل أنت متأكد من رغبتك في مسح ذاكرة التخزين المؤقت؟', () => {
          closeConfirmModal();
          showToast('جاري مسح الكاش...');
          // حذف البيانات المؤقتة من localStorage
          localStorage.removeItem('lastBackupSyncTime');
          localStorage.removeItem('rememberedPins');
          localStorage.removeItem('lastCheckedPurchasesTimestamp');
          localStorage.removeItem('lastCalendarViewDate');
          // لا نحذف deviceId لأنه يجب أن يكون دائماً
          
          setTimeout(() => { location.reload(); }, 1500);
      });
  }

  async function refreshDebtsView() {
    // Refresh the state data
    state.debts = await db.debts.toArray();
    // Re-render the view
    renderView('debts_feature');
  }

  function getDebtsView() {
    const debts = state.debts || [];
    const totalDebts = debts.reduce((sum, debt) => sum + (debt.remaining || 0), 0);
    const totalOriginal = debts.reduce((sum, debt) => sum + (debt.amount || 0), 0);

    const debtRows = debts.map(debt => {
        const progress = debt.amount > 0 ? ((debt.amount - debt.remaining) / debt.amount) * 100 : 0;
        return `
            <tr onclick="renderView('debt-details', { id: ${debt.id} })" style="cursor:pointer;">
                <td>
                    <div style="font-weight: 700;">${debt.person}</div>
                    <div style="font-size: 12px; color: var(--muted);">${debt.notes || 'لا توجد ملاحظات'}</div>
                </td>
                <td class="amount-col negative">
                    ${debt.remaining.toLocaleString()}&nbsp;د.ج
                </td>
                <td class="hide-on-mobile">
                    <div style="width: 100%; background: var(--bg); border-radius: 4px; overflow: hidden;">
                        <div style="width: ${progress}%; background: var(--primary); height: 8px;"></div>
                    </div>
                    <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">${Math.round(progress)}% مسدد</div>
                </td>
                <td class="icon-cell">
                    <button onclick="event.stopPropagation(); openDebtPaymentModal(${debt.id});" class="btn ghost" title="تسجيل دفعة" style="padding: 4px 8px; font-size: 12px; color: #10b981; border-color: #10b981;">
                        <i class="fas fa-money-bill-wave"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');

    const debtsTable = debts.length > 0 ? `
        <div class="card" style="cursor:default; transform:none; padding: 8px; align-items: stretch;">
            <table class="professional-table">
                <thead>
                    <tr>
                        <th>الشخص</th>
                        <th style="text-align: left;">المبلغ المتبقي</th>
                        <th class="hide-on-mobile" style="width: 120px;">التقدم</th>
                        <th class="icon-cell"></th>
                    </tr>
                </thead>
                <tbody>
                    ${debtRows}
                </tbody>
            </table>
        </div>
    ` : `
        <div class="card" style="cursor:default; transform:none; padding: 40px 20px; align-items: center; text-align: center;">
            <div style="font-size: 40px; color: var(--primary); margin-bottom: 16px;"><i class="fas fa-file-invoice-dollar"></i></div>
            <h3 style="margin:0 0 8px;">لا توجد ديون مسجلة</h3>
            <p style="color:var(--muted); margin:0;">اضغط على "دين جديد" لإضافة قرض أو دين جديد.</p>
        </div>
    `;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button onclick="renderView('more_features')" class="btn icon-btn" title="العودة"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">سجل الديون والأقساط</h3>
            <div style="display: flex; gap: 8px;">
                <button onclick="if (hasActiveSubscription()) openDebtModal(); else openModal('subscriptionModal');" class="btn icon-btn" title="إضافة دين جديد"><i class="fas fa-plus"></i></button>
            </div>
        </div>

        <!-- Financial Summary -->
        <div class="grid-cards" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 20px;">
            <div class="card" style="cursor:default; transform:none; text-align:right; align-items:flex-start; padding:12px; border-left: 4px solid #ef4444;">
                <div style="font-size:13px; color:var(--muted);">إجمالي الديون المتبقية</div>
                <div style="font-weight:800; font-size:20px; color:#ef4444;">${totalDebts.toLocaleString()} د.ج</div>
            </div>
            <div class="card" style="cursor:default; transform:none; text-align:right; align-items:flex-start; padding:12px; border-left: 4px solid var(--muted);">
                <div style="font-size:13px; color:var(--muted);">إجمالي الديون الأصلية</div>
                <div style="font-weight:800; font-size:20px; color:var(--muted);">${totalOriginal.toLocaleString()} د.ج</div>
            </div>
        </div>

        ${debtsTable}
    `;
}

  // *** إضافة: دالة لإنشاء واجهة تفاصيل الدين ***
  function getDebtDetailsView(debtId) {
    const debt = state.debts.find(d => d.id === debtId);
    if (!debt) return `<p>لم يتم العثور على الدين.</p><button id="backToDebts">العودة</button>`;

    const amount = debt.amount || 0;
    const remaining = debt.remaining || 0;
    const paid = amount - remaining;
    const progress = amount > 0 ? (paid / amount) * 100 : 0;

    const paymentsHTML = (debt.payments && debt.payments.length > 0)
        ? debt.payments.sort((a, b) => new Date(b.date) - new Date(a.date)).map(p => `
            <div class="activity-log-item">
                <div style="display:flex; align-items:center;">
                    <div class="icon" style="color: #10b981; background: rgba(16,185,129,.1);"><i class="fas fa-money-bill-wave"></i></div>
                    <div>
                        <div style="font-weight:500;">دفعة مسددة: ${p.amount.toLocaleString()} د.ج</div>
                        <div style="font-size:13px; color:var(--muted);">${new Date(p.date).toLocaleDateString('ar-DZ')}</div>
                        ${p.notes ? `<div class="note"><i class="fas fa-quote-right" style="margin-left: 4px; opacity: 0.7;"></i> ${p.notes}</div>` : ''}
                    </div>
                </div>
            </div>
        `).join('')
        : `<p style="text-align:center; color:var(--muted); padding: 20px;">لا توجد دفعات مسجلة لهذا الدين.</p>`;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button id="backToDebts" class="btn icon-btn" title="العودة للديون"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">دين: ${debt.person}</h3> 
            <div style="display: flex; gap: 8px;">
                <button id="analyzeDebtBtn" data-id="${debt.id}" class="btn icon-btn ghost" title="تحليل" style="color: #0ea5e9; border-color: #0ea5e9;" ${!hasActiveSubscription() && auth.currentUser ? 'disabled' : ''}><i class="fas fa-robot"></i></button>
                <button id="editDebtBtn" data-id="${debt.id}" class="btn icon-btn ghost" title="تعديل" ${!hasActiveSubscription() && auth.currentUser ? 'disabled' : ''}><i class="fas fa-edit"></i></button>
            </div>
        </div>

        <!-- Financial Summary -->
        <div class="grid-cards" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); margin-top:0; margin-bottom: 20px;">
            <div class="card" style="cursor:default; transform:none; text-align:right; align-items:flex-start; padding:12px;">
                <div style="font-size:13px; color:var(--muted);">المبلغ الإجمالي</div>
                <div style="font-weight:800; font-size:18px; color:var(--primary);">${amount.toLocaleString()} د.ج</div>
            </div>
            <div class="card" style="cursor:default; transform:none; text-align:right; align-items:flex-start; padding:12px;">
                <div style="font-size:13px; color:var(--muted);">المبلغ المدفوع</div>
                <div style="font-weight:800; font-size:18px; color:#10b981;">${paid.toLocaleString()} د.ج</div>
            </div>
            <div class="card" style="cursor:default; transform:none; text-align:right; align-items:flex-start; padding:12px;">
                <div style="font-size:13px; color:var(--muted);">المبلغ المتبقي</div>
                <div style="font-weight:800; font-size:18px; color:#ef4444;">${remaining.toLocaleString()} د.ج</div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="card" style="cursor:default; transform:none; padding: 16px; margin-bottom: 20px; align-items: stretch;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px; width:100%;">
                <h4 style="margin:0; font-weight:700; font-size: 14px;">نسبة السداد</h4>
                <span style="font-weight: 700; color: var(--primary);">${Math.round(progress)}%</span>
            </div>
            <div style="width: 100%; background: var(--bg); border-radius: 8px; overflow: hidden; height: 12px;">
                <div style="width: ${progress}%; background: var(--primary); height: 100%; border-radius: 8px;"></div>
            </div>
        </div>

        <!-- Actions & Activity Log -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 12px;">
            <h4 style="margin:0; font-weight:700;">سجل الدفعات</h4>
            <button id="addDebtPaymentBtn" data-id="${debt.id}" class="btn icon-btn" title="تسجيل دفعة" style="background-color:#10b981;" ${!hasActiveSubscription() && auth.currentUser ? 'disabled' : ''}><i class="fas fa-plus"></i></button>
        </div>
        <div id="debtPaymentsLog">
            ${paymentsHTML}
        </div>
  `;
  }

  // *** إضافة: واجهة مبدئية لسجل المشتريات ***
  function getPurchasesView() { 
        // Defensive dedupe
        const seen = new Set();
        const clean = (Array.isArray(state.purchases) ? state.purchases : []).filter(p => {
            const key = p && (p.firestoreId || p.id || `${p.description}-${p.amount}-${p.date}`);
            if (seen.has(key)) return false;
            seen.add(key);
            return true;
        });

        const pendingPurchases = clean.filter(p => p.status === 'pending').sort((a, b) => {
            const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(0);
            const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(0);
            return dateB - dateA;
        });

    const purchasesListHTML = pendingPurchases.length > 0 ? pendingPurchases.map(purchase => `
        <div class="card" style="flex-direction: column; align-items: stretch; text-align: right; margin-bottom: 12px; padding: 16px; cursor: default; transform: none; border-top: 4px solid var(--accent);">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                <div>
                    <div style="font-weight: 700;">${purchase.description}</div>
                    <div style="font-size: 13px; color: var(--muted); margin-top: 4px;">
                        <i class="fas fa-user" style="margin-left: 4px;"></i> ${purchase.workerName || 'عامل غير معروف'} &bull;
                        <span style="font-weight: 500;">${new Date(purchase.date).toLocaleDateString('ar-DZ')}</span>
                    </div>
                </div>
                <div style="font-weight: 800; font-size: 18px; color: #ef4444; flex-shrink: 0;">${purchase.amount.toLocaleString()} د.ج</div>
            </div>
            ${purchase.notes ? `<div style="background: var(--bg); padding: 8px 12px; border-radius: 8px; font-size: 14px; margin-bottom: 16px; white-space: pre-wrap;">${purchase.notes}</div>` : ''}
            <div style="display: flex; gap: 10px; justify-content: flex-end; border-top: 1px solid var(--border-color); padding-top: 16px; margin-top: 8px;">
                <button class="btn ghost" onclick="handlePurchaseReview('${purchase.firestoreId}', 'rejected')" style="color: #ef4444; border-color: #ef4444;">رفض</button>
                <button class="btn" onclick="handlePurchaseReview('${purchase.firestoreId}', 'approved')" style="background-color: #10b981;">تأكيد وإضافة كنفقة</button>
            </div>
        </div>
    `).join('') : `
        <div class="card" style="cursor:default; transform:none; padding: 40px 20px; align-items: center; text-align: center;">
            <div style="font-size: 40px; color: var(--primary); margin-bottom: 16px;"><i class="fas fa-check-circle"></i></div>
            <h3 style="margin:0 0 8px;">لا توجد مشتريات للمراجعة</h3>
            <p style="color:var(--muted); margin:0;">كل شيء محدّث!</p>
        </div>
    `;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button onclick="renderView('home')" class="btn icon-btn" title="العودة للرئيسية"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">مراجعة المشتريات</h3>
        </div>
        ${purchasesListHTML}
    `;
  }

  // *** إضافة: دالة لإخفاء إشعار المشتريات وتحديث الوقت ***
  function hidePurchasesNotification() {
      if (state.hasNewPurchases) {
          state.hasNewPurchases = false;
          // تحديث الواجهة الرئيسية إذا كانت معروضة لإخفاء النقطة فوراً
          if (state.currentView.name === 'home') renderView('home');
      }
      localStorage.setItem('lastCheckedPurchasesTimestamp', new Date().getTime().toString());
  }

  async function handlePurchaseReview(firestoreId, newStatus) {
      try {
          if (!firestoreId) {
              throw new Error("معرّف الشراء مفقود.");
          }
          // *** إضافة: التحقق من تسجيل دخول المستخدم قبل تنفيذ العملية ***
          const user = auth.currentUser;
          if (!user) {
              showCustomToast('يجب تسجيل الدخول لتنفيذ هذه العملية.', 'error');
              return;
          }
          // *** تعديل: استخدام المسار الصحيح المتوافق مع قواعد Firestore ***
          const purchaseRef = firestore.collection('users').doc(user.uid).collection('purchases').doc(firestoreId);
          await purchaseRef.update({ status: newStatus });

          if (newStatus === 'approved') {
              // *** تعديل: جلب بيانات الشراء المحدثة مباشرة من Firestore لضمان الدقة ***
              const updatedPurchaseDoc = await purchaseRef.get();
              if (updatedPurchaseDoc.exists) {
                  const purchaseData = updatedPurchaseDoc.data();
                  // إنشاء سجل نفقة جديد من بيانات الشراء المؤكدة
                  await db.expenses.add({ ...purchaseData, paymentStatus: 'paid' });
                  showToast('تم تأكيد الشراء وإضافته للنفقات.');
              } else {
                  throw new Error('لم يتم العثور على بيانات الشراء بعد التحديث.');
              }
          } else {
              showToast('تم رفض طلب الشراء.');
          }
          // *** تعديل: حذف الطلب من قاعدة البيانات المحلية والحالة بعد المراجعة ***
          await db.purchases.delete(firestoreId);
          state.purchases = state.purchases.filter(p => p.firestoreId !== firestoreId);
          await renderView('purchases');
      } catch (error) {
          console.error("Error reviewing purchase:", error);
          showCustomToast('حدث خطأ أثناء مراجعة الطلب.', 'error');
      }
  }

  function getApiSettingsView() {
    const activeApiId = state.active_api_id;
    const apiListHTML = state.api_configs && state.api_configs.length > 0
      ? state.api_configs.map(config => {
        const isActive = config.id === activeApiId;
        return `
            <div class="card" style="cursor:default; transform:none; align-items:flex-start; text-align:right; margin-bottom: 12px;">
                <div style="display:flex; justify-content:space-between; align-items:center; width: 100%; margin-bottom: 12px;">
                    <h5 style="margin:0; font-weight:700;">${config.name}</h5>
                    <label class="switch">
                        <input type="checkbox" data-action="toggle-api-active" data-id="${config.id}" ${isActive ? 'checked' : ''}>
                        <span class="slider"></span>
                    </label>
                </div>
                <div style="font-size: 13px; color: var(--muted); width: 100%; padding-bottom: 12px; border-bottom: 1px solid var(--border-color);">
                    المزود: ${config.provider} | النموذج: ${config.model}
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; width: 100%; margin-top: 12px;">
                    <span style="font-size: 13px; color: #10b981; font-weight: 700;"><i class="fas fa-check-circle" style="margin-left: 4px;"></i> صالح</span>
                    <button onclick="deleteApiConfig(${config.id})" class="btn ghost" style="color: #ef4444; border-color: transparent;"><i class="fas fa-trash-alt"></i></button>
                </div>
            </div>`;
      }).join('')
      : `<p style="text-align:center; color:var(--muted); padding: 20px;">لم تقم بإضافة أي إعدادات API بعد.</p>`;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button onclick="renderView('settings')" class="btn icon-btn" title="العودة للإعدادات"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">إعدادات الذكاء الاصطناعي</h3>
            <div style="display: flex; gap: 8px;">
                <button id="addApiConfigBtn" class="btn icon-btn" title="إضافة API"><i class="fas fa-plus"></i></button>
            </div>
        </div>
        ${apiListHTML}
    `;
  }

  function getThemesView() {
    const currentThemeName = state.selected_theme || 'default-light';
    
    const createThemeCard = (themeKey) => {
        const theme = themes[themeKey];
        const isActive = themeKey === currentThemeName;
        return `
            <div class="card theme-card" data-theme="${themeKey}" style="padding: 12px; border-color: ${isActive ? 'var(--primary)' : 'transparent'};">
                <div style="display: flex; gap: 8px; width: 100%; height: 60px; margin-bottom: 12px;">
                    <div style="flex: 1; background-color: ${theme.colors['--bg']}; border-radius: 6px;"></div>
                    <div style="flex: 2; background-color: ${theme.colors['--card']}; border-radius: 6px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <div style="width: 20px; height: 20px; border-radius: 50%; background-color: ${theme.colors['--primary']};"></div>
                        <div style="width: 20px; height: 20px; border-radius: 50%; background-color: ${theme.colors['--accent']};"></div>
                    </div>
                </div>
                <div style="font-weight: 700; font-size: 14px;">${theme.name}</div>
                ${isActive ? `<div style="position: absolute; top: 8px; left: 8px; color: var(--primary); font-size: 18px;"><i class="fas fa-check-circle"></i></div>` : ''}
            </div>
        `;
    };

    const lightThemesHTML = Object.keys(themes).filter(key => themes[key].type === 'light').map(createThemeCard).join('');
    const darkThemesHTML = Object.keys(themes).filter(key => themes[key].type === 'dark').map(createThemeCard).join('');

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button onclick="renderView('settings')" class="btn icon-btn" title="العودة للإعدادات"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">تخصيص الثيمات</h3>
        </div>

        <h4 style="margin: 24px 0 12px; font-weight:700;">الثيمات الفاتحة</h4>
        <div class="grid-cards" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); margin-top: 0;">
            ${lightThemesHTML}
        </div>

        <h4 style="margin: 24px 0 12px; font-weight:700;">الثيمات الداكنة</h4>
        <div class="grid-cards" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); margin-top: 0;">
            ${darkThemesHTML}
        </div>
    `;
  }

  // *** إضافة: واجهة النسخ الاحتياطي والاستعادة ***
  function getBackupRestoreView() {
    // We will fetch the last backup date later and update the DOM
    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button onclick="renderView('settings')" class="btn icon-btn" title="العودة للإعدادات"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">النسخ الاحتياطي والاستعادة</h3>
        </div>

        <div class="card" style="cursor:default; transform:none; padding: 20px; align-items: stretch; text-align: right; margin-bottom: 20px; border-top: 2px solid var(--primary);">
            <h4 style="margin: 0 0 8px; font-size: 16px;">حفظ نسخة احتياطية في السحابة</h4>
            <p style="color: var(--muted); line-height: 1.6; margin: 0 0 16px;">
                حفظ جميع بياناتك (المشاريع، العمال، إلخ) بأمان في حسابك على Firebase. يمكنك استعادتها في أي وقت وعلى أي جهاز.
            </p>
            <button onclick="handleCloudBackup()" class="btn" style="background-color: #10b981; width: 100%;"><i class="fas fa-cloud-upload-alt" style="margin-left: 8px;"></i> حفظ البيانات الآن</button>
        </div>

        <div class="card" style="cursor:default; transform:none; padding: 20px; align-items: stretch; text-align: right; border-top: 2px solid #f59e0b;">
            <h4 style="margin: 0 0 8px; font-size: 16px;">استعادة البيانات من السحابة</h4>
            <p style="color: var(--muted); line-height: 1.6; margin: 0 0 16px;">
                سيتم دمج آخر نسخة احتياطية محفوظة مع بياناتك الحالية. السجلات الجديدة ستُضاف والسجلات القديمة ستُحدّث.
            </p>
            <div id="lastBackupInfo" style="font-size: 13px; color: var(--muted); text-align: center; margin-bottom: 12px; background: var(--bg); padding: 8px; border-radius: 6px;">
                جاري البحث عن نسخة احتياطية...
            </div>
            <button id="restoreBtn" onclick="handleCloudRestore()" class="btn" style="background-color: #f59e0b; width: 100%;" disabled><i class="fas fa-cloud-download-alt" style="margin-left: 8px;"></i> استعادة البيانات الآن</button>
        </div>
    `;
  }

  // *** تعديل: منطق النسخ الاحتياطي للسحابة ***
  async function handleCloudBackup() {
    const user = auth.currentUser;
    if (!user) {
        showCustomToast('يجب أن تكون مسجلاً للدخول.', 'error');
        return;
    }

    openConfirmModal('هل تريد حفظ نسخة احتياطية من بياناتك الحالية في السحابة؟', async () => {
        closeConfirmModal();
        showToast('جاري حفظ النسخة الاحتياطية...');
        try {
            const backupData = {
                backupTimestamp: firebase.firestore.FieldValue.serverTimestamp(), // *** تعديل: استخدام معرّف الجهاز الدائم
                lastUpdatedBy: deviceIdentifier
            };
            // Iterate over all tables in the database
            for (const table of db.tables) {
                // We don't backup settings or image data
                // *** تعديل: التأكد من أن اسم الجدول ليس 'purchases' لأنه يُدار بشكل منفصل ***
                if (table.name !== 'app_settings') {
                    let tableData = await table.toArray();

                    // *** إضافة: استثناء حقول الصور من النسخ الاحتياطي ***
                    const imageFieldsToExclude = {
                        workers: 'imageUrl',
                        suppliers: 'imageUrl',
                        inventory: 'imageUrl',
                        companyProfiles: 'logoUrl',
                        expenses: 'receiptUrl'
                    };

                    const fieldToExclude = imageFieldsToExclude[table.name];
                    if (fieldToExclude) {
                        // إنشاء نسخة جديدة من البيانات بدون حقل الصورة
                        tableData = tableData.map(item => {
                            const { [fieldToExclude]: _, ...rest } = item; // استثناء الحقل المحدد
                            return rest;
                        });
                    }
                    backupData[table.name] = tableData;
                }
            }

            // *** تعديل: حفظ النسخة الاحتياطية داخل مستند المستخدم وليس في collection منفصل ***
            // استخدام merge: true للحفاظ على بيانات المستخدم الأخرى مثل الاسم والبريد الإلكتروني
            await firestore.collection('users').doc(user.uid).set({ backup: backupData }, { merge: true });
            showToast('تم حفظ النسخة الاحتياطية بنجاح.');
            // Refresh the view to show the new backup date
            renderView('backup_restore');

        } catch (error) {
            console.error("Cloud backup failed:", error);
            showCustomToast('فشل حفظ النسخة الاحتياطية.', 'error');
        }
    });
  }

  // *** تعديل: منطق الاستعادة من السحابة ***
  async function handleCloudRestore() {
    const user = auth.currentUser;
    if (!user) return;

    openConfirmModal('هل أنت متأكد من استعادة البيانات؟ سيتم دمج البيانات من السحابة مع بياناتك الحالية.', async () => {
        closeConfirmModal();
        showToast('جاري استعادة البيانات...');
    try {
            const userDoc = await firestore.collection('users').doc(user.uid).get();
            if (!userDoc.exists || !userDoc.data().backup) {
                showCustomToast('لا توجد نسخة احتياطية لك في السحابة.', 'error');
                return;
            }

            // *** تعديل: قراءة النسخة الاحتياطية من داخل حقل backup ***
            const backupData = userDoc.data().backup;

            // Use a transaction to write all data
            await db.transaction('rw', db.tables, async () => {
                for (const table of db.tables) {
                    // Check if the backup contains data for this table and it's an array
                    if (backupData[table.name] && Array.isArray(backupData[table.name])) {
                        // bulkPut is perfect for "merge and update"
                        await table.bulkPut(backupData[table.name]);
                    }
                }
            });

            showToast('تم استعادة البيانات بنجاح!');
            // *** إضافة: إخفاء الإشعار وحفظ وقت المزامنة بعد الاستعادة الناجحة ***
            hideBackupNotification();
            localStorage.setItem('lastBackupSyncTime', Date.now());

            // Reload the app to apply all changes from the restored data
            setTimeout(() => location.reload(), 1500);

        } catch (error) {
            console.error("Cloud restore failed:", error);
            showCustomToast('فشل استعادة البيانات.', 'error');
        }
    });
  }

  function getAiAssistantView() {
    if (!state.active_api_id) {
        return `
            <div style="text-align: center; padding: 40px 20px;">
                <div style="font-size: 48px; color: var(--accent); margin-bottom: 16px;"><i class="fas fa-robot"></i></div>
                <h3 style="margin:0 0 8px;">مساعد الذكاء الاصطناعي غير نشط</h3>
                <p style="color: var(--muted); line-height: 1.6;">
                    لاستخدام هذه الميزة، يرجى الذهاب إلى الإعدادات وتفعيل أحد مفاتيح الـ API.
                </p>
                <button onclick="renderView('api_settings')" class="btn" style="margin-top: 16px;">الذهاب إلى الإعدادات</button>
            </div>
        `;
    }

    // Reset history and add the initial assistant message
    const welcomeMessage = "مرحباً! أنا مساعدك الذكي، والآن يمكنني الوصول إلى بيانات تطبيقك. اسألني عن عمالك، مشاريعك، أو أي شيء آخر!";
    state.aiChatHistory = [
        { role: 'model', content: welcomeMessage }
    ];

    const suggestions = [
        'ما هو رصيد العامل "عامل تجريبي"؟',
        'كم عدد أيام عمل بلال في شهر يونيو؟',
        'لخص لي مصاريف شراء الدهانات',
        'ما هي الأدوات المعارة حالياً؟'
    ];

    const suggestionsHTML = suggestions.map(s => `<button class="btn ghost suggestion-btn" style="font-size: 13px; padding: 6px 10px;">${s}</button>`).join('');

    return `
        <h3 style="margin:0 0 16px;font-weight:800">مساعد الذكاء الاصطناعي</h3>
        <div class="ai-chat-container card" style="padding: 0; align-items: stretch; height: calc(100vh - 220px);">
            <div id="aiChatHistory" class="ai-chat-history">
                <div class="ai-chat-bubble model">
                    <p>${welcomeMessage}</p>
                    <p>يمكنك طرح أسئلة عامة عن الديكور أو أسئلة محددة حول بياناتك. جرب أحد الاقتراحات التالية:</p>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px;">
                        ${suggestionsHTML}
                    </div>
                </div>
            </div>
            <div class="ai-chat-input-area">
                <textarea id="aiPromptInput" placeholder="اكتب سؤالك هنا..." rows="1"></textarea>
                <button id="sendAiPromptBtn" class="btn" disabled><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    `;
  }
  
  function getFactoryResetView() {
    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button onclick="renderView('settings')" class="btn icon-btn" title="العودة للإعدادات"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; color: #ef4444; text-align: right; flex-grow: 1;">إعادة ضبط المصنع</h3>
        </div>

        <div class="card" style="cursor:default; transform:none; padding: 20px; align-items: center; text-align: center; border-color: #ef4444;">
            <div style="font-size: 48px; color: #ef4444; margin-bottom: 16px;"><i class="fas fa-exclamation-triangle"></i></div>
            <h4 style="margin: 0 0 8px; font-size: 18px;">تحذير: إجراء لا يمكن التراجع عنه</h4>
            <p style="color: var(--muted); line-height: 1.7; max-width: 400px; margin-bottom: 24px;">
                أنت على وشك حذف جميع البيانات المخزنة في التطبيق بشكل نهائي، بما في ذلك العمال، المشاريع، الملاحظات، وجميع الإعدادات الأخرى.
                لا يمكن استرجاع هذه البيانات بعد الحذف.
            </p>
            <button id="factoryResetBtn" class="btn" style="background-color: #ef4444; padding: 10px 24px; font-size: 16px; gap: 8px;">
                <i class="fas fa-trash-alt" style="margin-left: 8px;"></i> نعم، أفهم وأريد الحذف
            </button>
        </div>
    `;
  }

  function getAboutView() {
    const appInfo = `
        <div class="card" style="cursor:default; transform:none; align-items:flex-start; text-align:right;">
            <h4 style="margin:0 0 12px; font-weight:800;">عن التطبيق</h4>
            <p style="margin:0; line-height:1.7;">
                <strong>My Decor Manager</strong> هو مساعدك الرقمي الشامل لإدارة أعمال الديكور والبناء. مصمم لتبسيط مهامك اليومية، من تتبع العمال والمشاريع إلى إدارة النفقات والموردين، كل ذلك في مكان واحد سهل الاستخدام.
            </p>
        </div>
    `;

    const devInfo = `
        <div class="card" style="cursor:default; transform:none; align-items:flex-start; text-align:right; margin-top: 20px;">
            <div style="display: flex; align-items: center; gap: 16px; width: 100%;">
                <img src="images/billel.png" alt="بلال بورابعة" style="width:80px; height:80px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 2px solid var(--border-color);">
                <div style="flex-grow: 1;">
                    <h4 style="margin: 0 0 4px; font-weight:800; font-size: 18px;">بلال بورابعة</h4>
                    <p style="margin: 0; color: var(--primary); font-size: 14px; font-weight: 700;">مطور برمجيات</p>
                </div>
            </div>
            <p style="margin:16px 0 0; line-height:1.7; border-top: 1px solid var(--border-color); padding-top: 16px; width: 100%;">👨‍💻 مطور برمجيات منذ 2014، شغوف بالذكاء الاصطناعي وهندسة البرمجيات. صاحب مدونة تقنية ومؤلف كتاب حول نظام أندرويد يصدر في 2025. معروف بلقب إمبراطور التقنية، بخبرة في تطوير التطبيقات عبر Android Studio وVisual Studio Code، مع مشاريع تعليمية وإبداعية لمشاركة المعرفة ودعم المطورين.</p>
            
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color); width: 100%;">
                <h5 style="margin: 0 0 12px; font-size: 14px; color: var(--muted);">تواصل معي</h5>
                <div style="display: flex; gap: 20px; font-size: 24px;">
                    <a href="https://www.facebook.com/billel.bouraba" target="_blank" style="color: var(--muted); text-decoration: none;"><i class="fab fa-facebook"></i></a>
                    <a href="https://www.instagram.com/billel_bouraba/?hl=fr" target="_blank" style="color: var(--muted); text-decoration: none;"><i class="fab fa-instagram"></i></a>
                    <a href="mailto:billel.dadi123@gmail.com" style="color: var(--muted); text-decoration: none;"><i class="fas fa-envelope"></i></a>
                </div>
            </div>
        </div>
    `;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button onclick="renderView('home')" class="btn icon-btn" title="العودة للرئيسية"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">حول التطبيق</h3>
        </div>
        ${appInfo}${devInfo}`;
  }

  function getMyInfoView() {
    const profilesListHTML = state.companyProfiles && state.companyProfiles.length > 0
        ? state.companyProfiles.map(profile => `
            <div class="card" data-action="view-profile" data-id="${profile.id}" style="flex-direction: row; justify-content: space-between; align-items: center; text-align: right; margin-bottom: 12px; padding: 12px 16px;">
                <div style="display:flex; align-items:center; gap: 12px;">
                    ${profile.logoUrl
                        ? `<img src="${profile.logoUrl}" alt="${profile.profileName}" style="width:48px; height:48px; border-radius: 50%; object-fit: cover;">`
                        : `<div class="icon" style="width:48px; height:48px; background: linear-gradient(135deg,#a855f7,#9333ea); font-size: 20px; margin-bottom: 0;"><i class="fas fa-id-card"></i></div>`
                    }
                    <div>
                        <div style="font-weight: 700;">${profile.profileName}</div>
                        <div style="font-size: 13px; color: var(--muted);">${profile.profession || 'ملف شخصي'}</div>
                    </div>
                </div>
                <i class="fas fa-chevron-left" style="color: var(--muted);"></i>
            </div>
        `).join('')
        : `<p style="text-align:center; color:var(--muted); padding: 20px;">لم تقم بإنشاء أي ملفات تعريفية بعد.</p>`;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button onclick="renderView('more_features')" class="btn icon-btn" title="العودة"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">ملفاتي التعريفية</h3>
            <div style="display: flex; gap: 8px;">
                <button id="addProfileBtn" class="btn icon-btn" title="إضافة ملف" ${!hasActiveSubscription() && auth.currentUser ? 'disabled' : ''}><i class="fas fa-plus"></i></button>
            </div>
        </div>
        ${profilesListHTML}
    `;
  }

  function getProfileDetailsView(profileId) {
    const profile = state.companyProfiles.find(p => p.id === profileId);
    if (!profile) return `<p>لم يتم العثور على الملف التعريفي.</p><button id="backToProfiles">العودة</button>`;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button id="backToProfiles" class="btn icon-btn" title="العودة للملفات"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">تفاصيل الملف</h3>
            <div style="display: flex; gap: 8px;">
                <button id="analyzeProfileBtn" data-id="${profile.id}" class="btn icon-btn ghost" title="تحليل" style="color: #0ea5e9; border-color: #0ea5e9;" ${!hasActiveSubscription() && auth.currentUser ? 'disabled' : ''}><i class="fas fa-robot"></i></button>
                <button id="editProfileBtn" data-id="${profile.id}" class="btn icon-btn ghost" title="تعديل" ${!hasActiveSubscription() && auth.currentUser ? 'disabled' : ''}><i class="fas fa-edit"></i></button>
                <button id="saveProfileAsImageBtn" data-id="${profile.id}" class="btn icon-btn ghost" title="حفظ كصورة"><i class="fas fa-camera"></i></button>
            </div>
        </div>

        <div id="profileCardToSave" style="background: linear-gradient(135deg, #0b1220, #071026); color: #f1f5f9; border-radius: 12px; padding: 20px; text-align: right; position: relative; overflow: hidden;">
            <div style="position: absolute; top: 12px; left: 12px; font-size: 12px; font-weight: 700; color: rgba(255,255,255,0.3);">My Decor Manager</div>
            
            <div style="display: flex; align-items: center; gap: 16px; padding-bottom: 16px; margin-bottom: 16px; border-bottom: 1px solid var(--border-color);">
                ${profile.logoUrl
                    ? `<img src="${profile.logoUrl}" alt="${profile.profileName}" style="width:80px; height:80px; border-radius: 16px; object-fit: cover; flex-shrink: 0; border: 2px solid var(--border-color);">`
                    : `<div class="icon" style="width:80px; height:80px; background: linear-gradient(135deg,#a855f7,#9333ea); font-size: 36px; margin-bottom: 0; flex-shrink: 0; border-radius: 16px; color: white;"><i class="fas fa-id-card"></i></div>`
                }
                <div style="flex-grow: 1;">
                    <h2 style="margin: 0 0 4px; font-size: 22px; font-weight: 800; color: white;">${profile.ownerName || profile.profileName}</h2>
                    <p style="margin: 0; color: #c084fc; font-size: 16px; font-weight: 700;">${profile.profession || 'مهنة غير محددة'}</p>
                </div>
            </div>

            <h4 style="margin: 16px 0 10px; font-size: 14px; color: rgba(255,255,255,0.5);">معلومات الدفع</h4>

            ${profile.ccp ? `
            <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 10px 12px; border-radius: 8px; margin-bottom: 10px;">
                <div>
                    <div style="font-size:13px; color: rgba(255,255,255,0.5);">CCP</div>
                    <div style="font-weight:700; font-size:18px; direction: ltr; margin-top: 4px; color: white; letter-spacing: 1px;">${profile.ccp}</div>
                </div>
                <button onclick="navigator.clipboard.writeText('${profile.ccp}'); showToast('تم نسخ رقم CCP بنجاح!');" class="btn ghost" style="padding: 6px 10px; border: none; background: transparent;"><i class="fas fa-copy" style="color: rgba(255,255,255,0.4);"></i></button>
            </div>
            ` : ''}

            ${profile.rip ? `
            <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 10px 12px; border-radius: 8px; margin-bottom: 10px;">
                <div>
                    <div style="font-size:13px; color: rgba(255,255,255,0.5);">RIP / BaridiMob</div>
                    <div style="font-weight:700; font-size:16px; direction: ltr; margin-top: 4px; word-break: break-all; color: white;">${profile.rip}</div>
                </div>
                <button onclick="navigator.clipboard.writeText('${profile.rip}'); showToast('تم نسخ رقم RIP بنجاح!');" class="btn ghost" style="padding: 6px 10px; border: none; background: transparent;"><i class="fas fa-copy" style="color: rgba(255,255,255,0.4);"></i></button>
            </div>
            ` : ''}

            ${profile.phone1 ? `
            <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 10px 12px; border-radius: 8px; margin-bottom: 10px;">
                <div>
                    <div style="font-size:13px; color: rgba(255,255,255,0.5);">رقم الهاتف 1</div>
                    <div style="font-weight:700; font-size:18px; direction: ltr; margin-top: 4px; color: white;">${profile.phone1}</div>
                </div>
                <button onclick="navigator.clipboard.writeText('${profile.phone1}'); showToast('تم نسخ رقم الهاتف بنجاح!');" class="btn ghost" style="padding: 6px 10px; border: none; background: transparent;"><i class="fas fa-copy" style="color: rgba(255,255,255,0.4);"></i></button>
            </div>
            ` : ''}

            ${profile.phone2 ? `
            <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 10px 12px; border-radius: 8px; margin-bottom: 10px;">
                <div>
                    <div style="font-size:13px; color: rgba(255,255,255,0.5);">رقم الهاتف 2</div>
                    <div style="font-weight:700; font-size:18px; direction: ltr; margin-top: 4px; color: white;">${profile.phone2}</div>
                </div>
                <button onclick="navigator.clipboard.writeText('${profile.phone2}'); showToast('تم نسخ رقم الهاتف بنجاح!');" class="btn ghost" style="padding: 6px 10px; border: none; background: transparent;"><i class="fas fa-copy" style="color: rgba(255,255,255,0.4);"></i></button>
            </div>
            ` : ''}

            ${profile.address ? `
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
                <div style="font-size:13px; color: rgba(255,255,255,0.5);">العنوان</div>
                <div style="font-weight:500; font-size:15px; margin-top: 4px; line-height: 1.6; color: white;">${profile.address}</div>
            </div>
            ` : ''}

            ${profile.privateNotes ? `
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
                <div style="font-size:13px; color: rgba(255,255,255,0.5);">معلومات إضافية</div>
                <div style="font-weight:500; font-size:15px; margin-top: 4px; line-height: 1.6; color: white; white-space: pre-wrap;">${profile.privateNotes}</div>
            </div>
            ` : ''}
        </div>
    `;
  }

  async function saveProfileAsImage(profileId) {
    const cardElement = document.getElementById('profileCardToSave');
    if (!cardElement) return;

    const profile = state.companyProfiles.find(p => p.id === profileId);
    const fileName = `info-${(profile.profileName || 'profile').replace(/\s+/g, '-').toLowerCase()}.png`;

    try {
        const canvas = await html2canvas(cardElement, {
            scale: 2, // Higher scale for better quality
            backgroundColor: null, // Use the element's actual background
            useCORS: true, // Important for external images/logos
        });
        const imageURL = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.href = imageURL;
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } catch (error) {
        console.error('Oops, something went wrong!', error);
        alert('حدث خطأ أثناء إنشاء الصورة.');
    }
  }

  // *** إضافة: دوال خاصة بنافذة الرسائل ***
  function openMessageModal() {
      const user = auth.currentUser;
      if (!user) {
          showCustomToast('يجب تسجيل الدخول لإرسال رسالة.', 'error');
          return;
      }
      // *** إضافة: التحقق من الاشتراك قبل فتح نافذة الرسائل ***
      if (!hasActiveSubscription()) {
          openModal('subscriptionModal');
          return;
      }

      const form = document.getElementById('messageForm');
      if (form) {
          form.reset();
      }
      openModal('messageModal');
  }

  /**
   * *** تعديل: إرسال الرسالة إلى نفس هوية المستخدم (UID) ***
   * العامل المسجل بنفس الحساب سيستقبل الرسالة.
   */
  async function handleMessageFormSubmit(e) {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) {
          showCustomToast('يجب تسجيل الدخول لإرسال رسالة.', 'error');
          return;
      }
      // *** إضافة: التحقق من الاشتراك قبل إرسال الرسالة ***
      if (!hasActiveSubscription()) {
          showCustomToast('هذه الميزة تتطلب اشتراكاً فعالاً.', 'error');
          closeModal('messageModal');
          openModal('subscriptionModal');
          return;
      }
      openModal('messageModal');
  }

  /**
   * *** تعديل: إرسال الرسالة إلى نفس هوية المستخدم (UID) ***
   * العامل المسجل بنفس الحساب سيستقبل الرسالة.
   */
  async function handleMessageFormSubmit(e) {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) {
          showCustomToast('يجب تسجيل الدخول لإرسال رسالة.', 'error');
          return;
      }

      // *** تعديل: تحديد المستلم ليكون هوية المستخدم الحالي (المدير/العامل) ***
      const messageData = {
          text: document.getElementById('messageText').value,
          receiverUid: user.uid, 
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
          await firestore.collection('users').doc(user.uid).collection('messages').add(messageData);
          showToast('تم إرسال الرسالة بنجاح.');
          closeModal('messageModal');
      } catch (error) {
          console.error("Error sending message:", error);
          showCustomToast('فشل إرسال الرسالة.', 'error');
      }
  }

  // *** إضافة: دالة للعودة إلى الواجهة السابقة ***
  function goBackToPreviousView() {
    if (state.previousView && state.previousView.name) {
        renderView(state.previousView.name, state.previousView.params);
    } else {
        // Fallback to a default view if no previous view is stored
        renderView('home');
    }
  }

  // --- Expense Modal ---
  function closeAllExpenseModals() {
      closeModal('allExpensesModal');
      closeModal('projectFullFinanceModal');
      closeModal('expenseModal');
  }

  function openExpenseModal(expenseId = null, prefill = {}) {
      // إغلاق جميع النوافذ المنبثقة المتعلقة بالنفقات أولاً
      closeAllExpenseModals();

      // Get elements each time the modal is opened to ensure they exist.
      const expenseModal = document.getElementById('expenseModal');
      const expenseForm = document.getElementById('expenseForm');
      const expenseModalTitle = document.getElementById('expenseModalTitle');
      const expenseIdInput = document.getElementById('expenseId');
      const expenseDescriptionInput = document.getElementById('expenseDescription');
      const expenseAmountInput = document.getElementById('expenseAmount');
      const expenseDateInput = document.getElementById('expenseDate');
      const expenseProjectInput = document.getElementById('expenseProjectName');
      const expenseWorkerInput = document.getElementById('expenseWorker');
      const expenseSupplierInput = document.getElementById('expenseSupplier');
      const expenseCategoryInput = document.getElementById('expenseCategory');
      const expensePaymentStatusInput = document.getElementById('expensePaymentStatus');
      const deleteExpenseBtn = document.getElementById('deleteExpenseBtn');
      const expenseImageDataBase64 = document.getElementById('expenseImageDataBase64');
      // *** إصلاح: تعريف المتغير الذي كان يسبب الخطأ ***
      const expenseModalContextInput = document.getElementById('expenseModalContext');
      const expenseImagePreview = document.getElementById('expenseImagePreview');

      if (!expenseForm) return; // Safety check

      // *** إضافة: تخزين السياق الحالي لتحديد وجهة العودة بعد الحفظ ***
      const currentContext = state.currentView.name;
      expenseModalContextInput.value = currentContext;

      expenseForm.reset();
      resetExpenseImagePreview();
      // Populate project datalist and worker dropdown
      const projectDatalist = document.getElementById('project-list');
      projectDatalist.innerHTML = state.projects.map(p => `<option value="${p.name}"></option>`).join('');
      // Removed worker and supplier dropdown population

      if (expenseId) {
          const expense = state.expenses.find(e => e.id === expenseId);
          if (expense) {
              expenseModalTitle.textContent = 'تعديل النفقة';
              expenseIdInput.value = expense.id;
              expenseDescriptionInput.value = expense.description;
              expenseAmountInput.value = expense.amount;
              expenseDateInput.value = expense.date;
              // Find project name from ID and set it to the input
              if (expense.projectId) {
                  const project = state.projects.find(p => p.id === expense.projectId);
                  expenseProjectInput.value = project ? project.name : '';
              }
              document.querySelector(`input[name="expensePaymentStatus"][value="${expense.paymentStatus || 'paid'}"]`).checked = true;
              if (expense.receiptUrl) {
                  expenseImageDataBase64.value = expense.receiptUrl;
                  expenseImagePreview.src = expense.receiptUrl;
                  showExpenseImagePreview(true);
              }
              deleteExpenseBtn.style.display = 'inline-block';
          }
      } else {
          expenseModalTitle.textContent = 'إضافة نفقة جديدة';
          expenseIdInput.value = '';
          expenseDateInput.valueAsDate = new Date();
          deleteExpenseBtn.style.display = 'none';
          // Handle pre-filling from project details view
          if (prefill.projectId) {
              const project = state.projects.find(p => p.id === prefill.projectId);
              if (project) expenseProjectInput.value = project.name;
          }
      }
      
      openModal('expenseModal');
  }

  function closeExpenseModal() {
      closeAllExpenseModals();
  }

  function resetExpenseImagePreview() {
      document.getElementById('expenseImageDataBase64').value = '';
      document.getElementById('expenseImageInput').value = '';
      const expenseImagePreview = document.getElementById('expenseImagePreview');
      expenseImagePreview.src = '';
      expenseImagePreview.style.display = 'none';
      expenseImagePlaceholder.style.display = 'flex';
      expenseImageRemoveBtn.style.display = 'none';
  }

  function showExpenseImagePreview(show) {
      const expenseImagePreview = document.getElementById('expenseImagePreview');
      const expenseImagePlaceholder = document.getElementById('expenseImagePlaceholder');
      const expenseImageRemoveBtn = document.getElementById('expenseImageRemoveBtn');
      expenseImagePreview.style.display = show ? 'block' : 'none';
      expenseImagePlaceholder.style.display = show ? 'none' : 'flex';
      expenseImageRemoveBtn.style.display = show ? 'inline-block' : 'none';
  }

  async function handleExpenseFormSubmit(e) {
      e.preventDefault();
      const expenseIdInput = document.getElementById('expenseId');
      const expenseDescriptionInput = document.getElementById('expenseDescription');
      const expenseAmountInput = document.getElementById('expenseAmount');
      const expenseDateInput = document.getElementById('expenseDate');
      const expenseProjectNameInput = document.getElementById('expenseProjectName');
      const expenseImageDataBase64 = document.getElementById('expenseImageDataBase64');

      const id = expenseIdInput.value ? parseInt(expenseIdInput.value) : null;
      let projectId = null;
      const projectName = expenseProjectNameInput.value.trim();

      if (projectName) {
          let project = state.projects.find(p => p.name.toLowerCase() === projectName.toLowerCase());
          if (project) {
              projectId = project.id;
          } else {
              // Project doesn't exist, create it
              projectId = await db.projects.add({ name: projectName, budget: 0, expenses: 0 });
          }
      }

      const paymentStatus = document.querySelector('input[name="expensePaymentStatus"]:checked').value;
      const expenseData = {
          description: expenseDescriptionInput.value,
          amount: parseFloat(expenseAmountInput.value) || 0,
          date: expenseDateInput.value,
          projectId: projectId,
          paymentStatus: paymentStatus,
          receiptUrl: expenseImageDataBase64.value,
          notes: document.getElementById('expenseNotes').value,
      };

      if (id) {
          await db.expenses.update(id, expenseData);
      } else {
          await db.expenses.add(expenseData);
      }
      // *** تحسين: توجيه ذكي بعد الحفظ بناءً على السياق ***
      const context = document.getElementById('expenseModalContext').value;
      if (context === 'project-details' && projectId) {
          renderView('project-details', { id: projectId, tab: 'finance' });
      } else if (context === 'expense-details') {
          // إذا كنا في صفحة التفاصيل، نعود خطوة للوراء
          goBackToPreviousView();
      } else {
          renderView('expenses', state.currentView.params);
      }
      closeExpenseModal();
  }

  // --- Worker Modal Functions ---
  const workerModal = document.getElementById('workerModal');
  const workerForm = document.getElementById('workerForm');
  const workerModalTitle = document.getElementById('workerModalTitle');
  const workerIdInput = document.getElementById('workerId');
  const workerNameInput = document.getElementById('workerName');
  const workerPhoneInput = document.getElementById('workerPhone');
  const workerDailyRateInput = document.getElementById('workerDailyRate');
  const deleteWorkerBtn = document.getElementById('deleteWorkerBtn');
  const workerPinInput = document.getElementById('workerPin');
  // Worker Image Elements
  const workerImageInput = document.getElementById('workerImageInput');
  const workerImagePreview = document.getElementById('workerImagePreview');
  const workerImagePlaceholder = document.getElementById('workerImagePlaceholder');
  const workerImageUploadBtn = document.getElementById('workerImageUploadBtn');
  const workerImageRemoveBtn = document.getElementById('workerImageRemoveBtn');
  const workerImageDataBase64 = document.getElementById('workerImageDataBase64');
  
  // Activity Modal Elements
  const activityModal = document.getElementById('activityModal');
  const activityForm = document.getElementById('activityForm');

  // --- Supplier Modal Functions ---
  const supplierModal = document.getElementById('supplierModal');
  const supplierForm = document.getElementById('supplierForm');
  const supplierModalTitle = document.getElementById('supplierModalTitle');
  const supplierIdInput = document.getElementById('supplierId');
  const supplierNameInput = document.getElementById('supplierName');
  const supplierPhoneInput = document.getElementById('supplierPhone');
  const supplierSpecialtyInput = document.getElementById('supplierSpecialty');
  const deleteSupplierBtn = document.getElementById('deleteSupplierBtn');
  // Supplier Image Elements
  const supplierImageInput = document.getElementById('supplierImageInput');
  const supplierImagePreview = document.getElementById('supplierImagePreview');
  const supplierImagePlaceholder = document.getElementById('supplierImagePlaceholder');
  const supplierImageUploadBtn = document.getElementById('supplierImageUploadBtn');
  const supplierImageRemoveBtn = document.getElementById('supplierImageRemoveBtn');
  const supplierImageDataBase64 = document.getElementById('supplierImageDataBase64');

  // --- Generic Confirmation Modal ---
  const confirmModal = document.getElementById('confirmModal');
  const confirmModalMessage = document.getElementById('confirmModalMessage');
  const confirmModalConfirmBtn = document.getElementById('confirmModalConfirmBtn');
  const confirmModalCancelBtn = document.getElementById('confirmModalCancelBtn');
  let onConfirmCallback = null;

  function openConfirmModal(message, onConfirm) {
      onConfirmCallback = onConfirm;
      confirmModalMessage.innerHTML = message;
      openModal('confirmModal');
  }

  function closeConfirmModal() {
      closeModal('confirmModal');
      onConfirmCallback = null;
  }

  // *** إضافة: دوال موحدة لفتح وإغلاق النوافذ المنبثقة ***
  function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('modal-hidden');
        document.body.style.overflow = 'hidden';
    }
  }

  function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('modal-hidden');
        document.body.style.overflow = '';
    }
  }

  // --- Event Details Modal ---
  const eventDetailsModal = document.getElementById('eventDetailsModal');
  function openEventDetailsModal(eventId) {
      const event = state.calendarEvents.find(e => e.id === eventId);
      if (!event) return;

      const eventTypes = {
          task: { text: 'مهمة', color: '#3b82f6' },
          appointment: { text: 'موعد', color: '#f59e0b' },
          delivery: { text: 'تسليم', color: '#10b981' },
          start_work: { text: 'بدء عمل', color: '#8b5cf6' }
      };

      document.getElementById('eventDetailsTitle').textContent = event.title;
      const typeBadge = document.getElementById('eventDetailsType');
      typeBadge.textContent = eventTypes[event.type]?.text || 'غير معروف';
      typeBadge.style.backgroundColor = eventTypes[event.type]?.color || '#64748b';
      document.getElementById('eventDetailsStartDate').textContent = new Intl.DateTimeFormat('ar-DZ', { dateStyle: 'full' }).format(new Date(event.startDate));
      document.getElementById('eventDetailsEndDate').textContent = new Intl.DateTimeFormat('ar-DZ', { dateStyle: 'full' }).format(new Date(event.endDate));

      document.getElementById('editEventDetailsBtn').onclick = () => {
          closeEventDetailsModal();
          openEventModal(eventId);
      };
      document.getElementById('deleteEventDetailsBtn').onclick = () => {
          // We can reuse the delete button logic from the edit modal
          deleteEventBtn.dataset.id = eventId; // Temporarily set id
          deleteEventBtn.click();
      };
      document.getElementById('analyzeEventDetailsBtn').onclick = () => {
          // We can close the details modal before showing the analysis modal for a cleaner UI
          closeEventDetailsModal();
          handleAnalysisRequest('event', eventId);
      };

      openModal('eventDetailsModal');
  }
  function closeEventDetailsModal() {
      closeModal('eventDetailsModal');
  }

  // --- Calendar Event Modal Functions ---
  const eventModal = document.getElementById('eventModal');
  const eventForm = document.getElementById('eventForm');
  const eventModalTitle = document.getElementById('eventModalTitle');
  const eventIdInput = document.getElementById('eventId');
  const eventTitleInput = document.getElementById('eventTitle');
  const eventStartDateInput = document.getElementById('eventStartDate');
  const eventEndDateInput = document.getElementById('eventEndDate');
  const eventTypeInput = document.getElementById('eventType');
  const deleteEventBtn = document.getElementById('deleteEventBtn');

  function openEventModal(eventId = null) {
      eventForm.reset();
      if (eventId) {
          const event = state.calendarEvents.find(e => e.id === eventId);
          if (event) {
              eventModalTitle.textContent = 'تعديل الحدث';
              eventIdInput.value = event.id;
              eventTitleInput.value = event.title;
              eventStartDateInput.value = event.startDate;
              eventEndDateInput.value = event.endDate;
              eventTypeInput.value = event.type;
              deleteEventBtn.style.display = 'inline-block';
          }
      } else {
          eventModalTitle.textContent = 'إضافة حدث جديد';
          eventIdInput.value = '';
          eventStartDateInput.valueAsDate = new Date();
          eventEndDateInput.valueAsDate = new Date();
          deleteEventBtn.style.display = 'none';
      }
      openModal('eventModal');
  }

  function closeEventModal() {
      closeModal('eventModal');
  }

  async function handleEventFormSubmit(e) {
      e.preventDefault();
      const id = eventIdInput.value ? parseInt(eventIdInput.value) : null;
      
      // Basic validation to ensure end date is not before start date
      if (eventEndDateInput.value < eventStartDateInput.value) {
          alert('تاريخ الانتهاء لا يمكن أن يكون قبل تاريخ البدء.');
          return;
      }

      const eventData = {
          title: eventTitleInput.value,
          startDate: eventStartDateInput.value,
          endDate: eventEndDateInput.value,
          type: eventTypeInput.value,
      };

      if (id) {
          await db.calendarEvents.update(id, eventData);
      } else {
          await db.calendarEvents.add(eventData);
      }
      renderView('calendar');
      closeEventModal();
  }

  // --- Lend Item Modal Functions ---
  const lendItemModal = document.getElementById('lendItemModal');
  const lendItemForm = document.getElementById('lendItemForm');

  // Lend Item Modal Listeners
  lendItemForm.addEventListener('submit', handleLendFormSubmit);
  lendItemModal.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeLendModal();
      }
  });

  function openLendModal(itemId) {
      lendItemForm.reset();
      document.getElementById('lendItemId').value = itemId;
      document.getElementById('borrowDate').valueAsDate = new Date();
      openModal('lendItemModal');
  }

  function closeLendModal() {
      closeModal('lendItemModal');
  }

  async function handleLendFormSubmit(e) {
      e.preventDefault();
      const itemId = parseInt(document.getElementById('lendItemId').value);
      const borrowerName = document.getElementById('borrowerName').value;
      const borrowDate = document.getElementById('borrowDate').value;

      await db.inventory.update(itemId, {
          status: 'in_use',
          borrowerName: borrowerName,
          borrowDate: borrowDate
      });
      closeLendModal();
      // *** إصلاح: تحديث الواجهة مباشرة بعد تأكيد الإعارة لعرض التغييرات ***
      renderView('inventory-details', { id: itemId });
  }

  async function handleReturnItem(itemId) {
      await db.inventory.update(itemId, { status: 'available', borrowerName: '', borrowDate: '' });
      renderView('inventory-details', { id: itemId });
  }

  // --- Inventory Modal Functions ---
  const inventoryModal = document.getElementById('inventoryModal');
  const inventoryForm = document.getElementById('inventoryForm');
  const inventoryModalTitle = document.getElementById('inventoryModalTitle');
  const inventoryIdInput = document.getElementById('inventoryId');
  const inventoryNameInput = document.getElementById('inventoryName');
  const inventoryQuantityInput = document.getElementById('inventoryQuantity');
  const inventoryStatusInput = document.getElementById('inventoryStatus');
  const deleteInventoryBtn = document.getElementById('deleteInventoryBtn');
  const inventoryImageInput = document.getElementById('inventoryImageInput');
  const inventoryImagePreview = document.getElementById('inventoryImagePreview');
  const inventoryImagePlaceholder = document.getElementById('inventoryImagePlaceholder');
  const inventoryImageUploadBtn = document.getElementById('inventoryImageUploadBtn');
  const inventoryImageRemoveBtn = document.getElementById('inventoryImageRemoveBtn');
  const inventoryImageDataBase64 = document.getElementById('inventoryImageDataBase64');

  function openInventoryModal(itemId = null) {
      inventoryForm.reset();
      resetInventoryImagePreview();
      if (itemId) {
          const item = state.inventory.find(i => i.id === itemId);
          if (item) {
              inventoryModalTitle.textContent = 'تعديل الأداة';
              inventoryIdInput.value = item.id;
              inventoryNameInput.value = item.name;
              inventoryQuantityInput.value = item.quantity;
              inventoryStatusInput.value = item.status;
              if (item.imageUrl) {
                  inventoryImageDataBase64.value = item.imageUrl;
                  inventoryImagePreview.src = item.imageUrl;
                  showInventoryImagePreview(true);
              }
              deleteInventoryBtn.style.display = 'inline-block';
          }
      } else {
          inventoryModalTitle.textContent = 'إضافة أداة جديدة';
          inventoryIdInput.value = '';
          deleteInventoryBtn.style.display = 'none';
      }
      openModal('inventoryModal');
  }

  function closeInventoryModal() {
      closeModal('inventoryModal');
  }

  function resetInventoryImagePreview() {
      inventoryImageDataBase64.value = '';
      inventoryImageInput.value = '';
      inventoryImagePreview.src = '';
      inventoryImagePreview.style.display = 'none';
      inventoryImagePlaceholder.style.display = 'flex';
      inventoryImageRemoveBtn.style.display = 'none';
  }

  function showInventoryImagePreview(show) {
      inventoryImagePreview.style.display = show ? 'block' : 'none';
      inventoryImagePlaceholder.style.display = show ? 'none' : 'flex';
      inventoryImageRemoveBtn.style.display = show ? 'inline-block' : 'none';
  }


  // --- Inline Note Form Logic ---
  function setupInlineNoteForm() {
      const container = document.getElementById('addNoteFormContainer');
      const titleInput = document.getElementById('newNoteTitle');
      const contentTextarea = document.getElementById('newNoteContent');
      const actionsDiv = document.getElementById('newNoteActions');
      const saveBtn = document.getElementById('saveNewNoteBtn');
      let selectedColor = '#3b82f6';

      const expandForm = () => {
          titleInput.style.display = 'block';
          if (!hasActiveSubscription()) {
              openModal('subscriptionModal');
              return;
          }
          actionsDiv.style.display = 'flex'; // Only show actions if subscribed
          contentTextarea.rows = 3;
      };

      const collapseForm = () => {
          titleInput.style.display = 'none';
          actionsDiv.style.display = 'none';
          contentTextarea.rows = 1;
          titleInput.value = '';
          contentTextarea.value = '';
      };

      contentTextarea.addEventListener('focus', expandForm);

      actionsDiv.querySelectorAll('.swatch').forEach(swatch => {
          swatch.addEventListener('click', () => {
              actionsDiv.querySelectorAll('.swatch').forEach(s => s.classList.remove('selected'));
              swatch.classList.add('selected');
              selectedColor = swatch.dataset.color;
          });
      });

      saveBtn.addEventListener('click', async () => {
          if (!hasActiveSubscription()) {
              openModal('subscriptionModal');
              return;
          }
          if (contentTextarea.value.trim() === '' && titleInput.value.trim() === '') {
              collapseForm();
              return;
          }
          await db.notes.add({ title: titleInput.value, content: contentTextarea.value, color: selectedColor, updatedAt: Date.now() });
          collapseForm();
          renderView('notes');
      });
  }

  // --- Note Modal Functions ---
  const noteModal = document.getElementById('noteModal');
  const noteForm = document.getElementById('noteForm');
  const noteModalTitle = document.getElementById('noteModalTitle');
  const noteIdInput = document.getElementById('noteId');
  const noteTitleInput = document.getElementById('noteTitle');
  const noteContentInput = document.getElementById('noteContent');
  const noteColorInput = document.getElementById('noteColor');
  const deleteNoteBtn = document.getElementById('deleteNoteBtn');

  // This function is now only for EDITING existing notes
  function openNoteModal(noteId = null) {
      noteForm.reset();
      // Reset color swatches
      document.querySelectorAll('.swatch').forEach(s => s.classList.remove('selected'));
      const defaultSwatch = document.querySelector('.swatch[data-color="#3b82f6"]');
      defaultSwatch.classList.add('selected');
      noteColorInput.value = '#3b82f6';

      if (noteId) { // Only proceed if it's an existing note
          const note = state.notes.find(n => n.id === noteId);
          if (note) {
              noteModalTitle.textContent = 'تعديل الملاحظة';
              noteIdInput.value = note.id;
              noteTitleInput.value = note.title;
              noteContentInput.value = note.content;
              noteColorInput.value = note.color;
              const currentSwatch = document.querySelector(`.swatch[data-color="${note.color}"]`);
              if (currentSwatch) {
                  document.querySelectorAll('.swatch').forEach(s => s.classList.remove('selected'));
                  currentSwatch.classList.add('selected');
              }
              deleteNoteBtn.style.display = 'inline-block';
          }
          openModal('noteModal');
      }
  }

  function closeNoteModal() {
      closeModal('noteModal');
  }

  async function handleNoteFormSubmit(e) {
      e.preventDefault();
      const id = noteIdInput.value ? parseInt(noteIdInput.value) : null;
      const noteData = {
          title: noteTitleInput.value,
          content: noteContentInput.value,
          color: noteColorInput.value,
          updatedAt: Date.now(),
      };

      if (id) {
          await db.notes.update(id, noteData);
      } else {
          await db.notes.add(noteData);
      }
      renderView('notes');
      closeNoteModal();
  }

  async function handleInventoryFormSubmit(e) {
      e.preventDefault();
      const id = inventoryIdInput.value ? parseInt(inventoryIdInput.value) : null;
      const itemData = {
          name: inventoryNameInput.value,
          quantity: parseInt(inventoryQuantityInput.value) || 1,
          status: inventoryStatusInput.value,
          imageUrl: inventoryImageDataBase64.value,
      };

      if (id) {
          await db.inventory.update(id, itemData);
      } else {
          await db.inventory.add(itemData);
      }
      renderView('inventory');
      closeInventoryModal();
  }

  // *** إضافة: دوال خاصة بنافذة الديون ***
  function openDebtModal(debtId = null) {
      const modal = document.getElementById('debtModal');
      const form = document.getElementById('debtForm');
      const titleEl = document.getElementById('debtModalTitle');
      const deleteBtn = document.getElementById('deleteDebtBtn');

      form.reset();
      deleteBtn.style.display = 'none';

      if (debtId) {
          const debt = state.debts.find(d => d.id === debtId);
          if (debt) {
              titleEl.textContent = 'تعديل الدين';
              document.getElementById('debtId').value = debt.id;
              document.getElementById('debtPerson').value = debt.person;
              document.getElementById('debtAmount').value = debt.amount;
              document.getElementById('debtDueDate').value = debt.dueDate || '';
              document.getElementById('debtNotes').value = debt.notes || '';
              deleteBtn.style.display = 'inline-block';
          }
      } else {
          titleEl.textContent = 'إضافة دين جديد';
          document.getElementById('debtId').value = '';
          // *** إصلاح: تعيين تاريخ الاستحقاق إلى تاريخ اليوم تلقائياً ***
          document.getElementById('debtDueDate').valueAsDate = new Date();
      }

      openModal('debtModal');
  }

  function closeDebtModal() {
      closeModal('debtModal');
  }

  async function handleDebtFormSubmit(e) {
      e.preventDefault();
      const id = document.getElementById('debtId').value ? parseInt(document.getElementById('debtId').value) : null;
      const amount = parseFloat(document.getElementById('debtAmount').value) || 0;

      const debtData = {
          person: document.getElementById('debtPerson').value,
          amount: amount,
          dueDate: document.getElementById('debtDueDate').value,
          notes: document.getElementById('debtNotes').value,
      };

      if (id) {
          // عند التحديث، لا نغير المبلغ المتبقي أو الدفعات، فقط المعلومات الأساسية
          // *** إصلاح: الحفاظ على البيانات الموجودة عند التحديث ***
          const existingDebt = await db.debts.get(id);
          if (existingDebt) {
              // دمج البيانات الجديدة مع القديمة
              const updatedDebt = { ...existingDebt, ...debtData };
              await db.debts.update(id, updatedDebt);
          } else {
              await db.debts.update(id, debtData); // Fallback
          }
      } else {
          // عند الإضافة، نهيئ المبلغ المتبقي والدفعات
          debtData.remaining = amount;
          debtData.payments = [];
          await db.debts.add(debtData);
      }
      closeDebtModal();
      renderView('debts_feature');
  }


  function openSupplierModal(supplierId = null) {
      resetSupplierImagePreview();
      if (supplierId) {
          const supplier = state.suppliers.find(s => s.id === supplierId);
          if (supplier) {
              supplierModalTitle.textContent = 'تعديل بيانات المورد';
              supplierIdInput.value = supplier.id;
              supplierNameInput.value = supplier.name;
              supplierPhoneInput.value = supplier.phone;
              supplierSpecialtyInput.value = supplier.specialty;
              document.getElementById('supplierNotes').value = supplier.notes || '';
              if (supplier.imageUrl) {
                  supplierImageDataBase64.value = supplier.imageUrl;
                  supplierImagePreview.src = supplier.imageUrl;
                  showSupplierImagePreview(true);
              }
              deleteSupplierBtn.style.display = 'inline-block';
          }
      } else {
          supplierModalTitle.textContent = 'إضافة مورد جديد';
          supplierIdInput.value = '';
          deleteSupplierBtn.style.display = 'none';
      }
      openModal('supplierModal');
  }

  function closeSupplierModal() {
      closeModal('supplierModal');
  }

  function resetSupplierImagePreview() {
      supplierImageDataBase64.value = '';
      supplierImageInput.value = '';
      supplierImagePreview.src = '';
      supplierImagePreview.style.display = 'none';
      supplierImagePlaceholder.style.display = 'flex';
      supplierImageRemoveBtn.style.display = 'none';
  }

  function showSupplierImagePreview(show) {
      supplierImagePreview.style.display = show ? 'block' : 'none';
      supplierImagePlaceholder.style.display = show ? 'none' : 'flex';
      supplierImageRemoveBtn.style.display = show ? 'inline-block' : 'none';
  }

  async function handleSupplierFormSubmit(e) {
      e.preventDefault();
      const id = supplierIdInput.value ? parseInt(supplierIdInput.value) : null;
      const supplierData = {
          name: supplierNameInput.value,
          phone: supplierPhoneInput.value,
          specialty: supplierSpecialtyInput.value,
          imageUrl: supplierImageDataBase64.value,
          notes: document.getElementById('supplierNotes').value,
      };

      if (id) {
          await db.suppliers.update(id, supplierData);
      } else {
          await db.suppliers.add(supplierData);
      }
      renderView('suppliers');
      closeSupplierModal();
  }


  function openWorkerModal(workerId = null) {
      workerForm.reset(); 
      resetImagePreview();
      if (workerId) {
          const worker = state.workers.find(w => w.id === workerId);
          if (worker) {
              workerModalTitle.textContent = 'تعديل بيانات العامل';
              workerIdInput.value = worker.id; 
              workerNameInput.value = worker.name;
              workerPhoneInput.value = worker.phone;
              workerDailyRateInput.value = worker.dailyRate;
              workerPinInput.value = worker.pin || '';
              if (worker.imageUrl) {
                  workerImageDataBase64.value = worker.imageUrl;
                  workerImagePreview.src = worker.imageUrl;
                  showImagePreview(true);
              }
              deleteWorkerBtn.style.display = 'inline-block';
          }
      } else {
          workerModalTitle.textContent = 'إضافة عامل جديد';
          workerIdInput.value = '';
          deleteWorkerBtn.style.display = 'none';
      }
      openModal('workerModal');
  }

  function openWorkerPinModal(workerId) {
    const worker = state.workers.find(w => w.id === workerId);
    if (!worker) return;

    document.getElementById('pinWorkerName').textContent = worker.name;
    document.getElementById('pinWorkerId').value = workerId;
    document.getElementById('workerPinForm').reset();
    openModal('workerPinModal');
  }

  function closeWorkerPinModal() {
    closeModal('workerPinModal');
  }

  async function handleWorkerPinSubmit(e) {
    e.preventDefault();
    const workerId = parseInt(document.getElementById('pinWorkerId').value);
    const enteredPin = document.getElementById('pinInput').value;
    const rememberPin = document.getElementById('rememberPinCheckbox').checked;

    const worker = await db.workers.get(workerId);

    if (worker && worker.pin === enteredPin) {
        // *** إضافة: منطق حفظ PIN في localStorage ***
        // *** تعديل: تخزين الـ PIN لكل عامل على حدة ***
        const rememberedPins = JSON.parse(localStorage.getItem('rememberedPins') || '{}');
        if (rememberPin) {
            // ملاحظة: حفظ PIN في localStorage ليس آمناً 100% ولكنه مناسب للراحة في هذا التطبيق.
            rememberedPins[workerId] = enteredPin;
            localStorage.setItem('rememberedPins', JSON.stringify(rememberedPins));
            showCustomToast('تم حفظ رمز PIN لهذا الجهاز.');
        } else {
            // إذا لم يتم تحديد "تذكرني"، قم بإزالة رمز هذا العامل فقط
            delete rememberedPins[workerId];
            localStorage.setItem('rememberedPins', JSON.stringify(rememberedPins));
        }

        closeWorkerPinModal();
        renderView('worker-details', { id: workerId });
        // إعادة تعيين مربع الاختيار بعد الاستخدام
        document.getElementById('rememberPinCheckbox').checked = false;
    } else {
        showCustomToast('رمز PIN غير صحيح!', 'error');
        const pinInput = document.getElementById('pinInput');
        pinInput.style.animation = 'shake 0.5s';
        setTimeout(() => { pinInput.style.animation = ''; }, 500);
        pinInput.value = '';
    }
  }

  // =================================================================
  // *** إضافة: دوال إدارة PIN (مدمجة من pin.html) ***
  // =================================================================

  async function renderPinManagementView() {
    const container = document.getElementById('pinManagementContent');
    if (!container) return;

    // جلب أحدث بيانات العمال
    const workers = await db.workers.toArray();

    const workersListHTML = workers && workers.length > 0
        ? workers.map(worker => {
            const hasPin = worker.pin && worker.pin.length > 0;
            return `
            <div class="card" style="flex-direction: row; justify-content: space-between; align-items: center; text-align: right; margin-bottom: 12px; padding: 12px 16px; cursor: default; transform: none;">
                <div style="display:flex; align-items:center; gap: 12px;">
                    <div class="icon" style="width:48px; height:48px; background: linear-gradient(135deg,#f97316,#f59e0b); font-size: 20px; margin-bottom: 0;">
                        <i class="fas ${hasPin ? 'fa-lock' : 'fa-user'}"></i>
                    </div>
                    <div>
                        <div style="font-weight: 700;">${worker.name}</div>
                        <div style="font-size: 13px; color: var(--muted);">${hasPin ? 'معين له رمز PIN' : 'بدون رمز PIN'}</div>
                    </div>
                </div>
                <button class="btn" 
                        data-action="${hasPin ? 'clear-pin' : 'set-pin'}" 
                        data-id="${worker.id}" 
                        style="background-color: ${hasPin ? '#ef4444' : '#10b981'};">
                    <i class="fas ${hasPin ? 'fa-trash-alt' : 'fa-key'}" style="margin-left: 6px;"></i> 
                    ${hasPin ? 'مسح PIN' : 'تعيين PIN'}
                </button>
            </div>
        `}).join('')
        : `<p style="text-align:center; color:var(--muted); padding: 20px;">لم يتم إضافة أي عمال بعد.</p>`;

    container.innerHTML = workersListHTML;
  }

  async function openPinManagementModal() {
    openModal('pinManagementModal');
    await renderPinManagementView();
  }

  async function handlePinManagementClick(e) {
    const button = e.target.closest('button[data-action]');
    if (!button) return;

    const action = button.dataset.action;
    const workerId = parseInt(button.dataset.id);

    if (action === 'set-pin') {
        openPinEditModal(workerId);
    } else if (action === 'clear-pin') {
        openConfirmModal('هل أنت متأكد من مسح رمز PIN لهذا العامل؟', async () => {
            try {
                await db.workers.update(workerId, { pin: null });
                const rememberedPinData = JSON.parse(localStorage.getItem('rememberedPin'));
                if (rememberedPinData && rememberedPinData.workerId === workerId) {
                    localStorage.removeItem('rememberedPin');
                }
                showToast('تم مسح رمز PIN بنجاح.');
                closeConfirmModal();
                await renderPinManagementView(); // تحديث الواجهة داخل النافذة
            } catch (error) {
                console.error("Failed to clear PIN:", error);
                showCustomToast('فشل مسح رمز PIN.', 'error');
            }
        });
    }
  }

  function openPinEditModal(workerId) {
    const worker = state.workers.find(w => w.id === workerId);
    if (!worker) return;

    document.getElementById('pinEditForm').reset();
    document.getElementById('pinEditWorkerId').value = workerId;
    document.getElementById('newPin').value = worker.pin || '';
    document.getElementById('pinEditModalTitle').textContent = `تعديل PIN للعامل: ${worker.name}`;
    openModal('pinEditModal');
  }

  async function handlePinEditFormSubmit(e) {
    e.preventDefault();
    const workerId = parseInt(document.getElementById('pinEditWorkerId').value);
    const newPin = document.getElementById('newPin').value;

    if (newPin && !/^\d{4}$/.test(newPin)) {
        showCustomToast('رمز PIN يجب أن يتكون من 4 أرقام بالضبط.', 'error');
        return;
    }

    try {
        await db.workers.update(workerId, { pin: newPin || null });
        showToast('تم تحديث رمز PIN بنجاح!');
        closeModal('pinEditModal');
        await renderPinManagementView(); // تحديث الواجهة داخل النافذة
    } catch (error) {
        showCustomToast('فشل تحديث رمز PIN.', 'error');
    }
  }

  function openAttendanceConfirmModal(data) {
      tempAttendanceData = data;
      const date = new Intl.DateTimeFormat('ar-DZ', { day: '2-digit', month: 'long', year: 'numeric' }).format(new Date(data.date));
      document.getElementById('confirmDate').textContent = date;
      openModal('attendanceConfirmModal');
  }

  function closeAttendanceConfirmModal() { 
      closeModal('attendanceConfirmModal');
  }

  async function saveAttendance(status) {
      const { worker, date, dailyRate } = tempAttendanceData;
      worker.attendance.push({ id: Date.now(), date, status, dailyRate });
      await db.workers.update(worker.id, { attendance: worker.attendance });
      renderView('worker-details', { id: worker.id, month: new Date(date).getMonth(), year: new Date(date).getFullYear() });
      closeAttendanceConfirmModal();
      closeActivityModal();
  }

  async function handleSettleMonth(workerId, year, month) {
      const worker = state.workers.find(w => w.id === workerId);
      if (!worker) return;

      const { totalDue, totalPaid } = calculateWorkerFinancials(worker, year, month);
      const balance = totalDue - totalPaid;

      if (balance > 0) {
          const settlementKey = `${year}-${month}`;
          const monthName = new Intl.DateTimeFormat('ar-DZ', { month: 'long' }).format(new Date(year, month));

          if (!worker.payments) worker.payments = [];
          worker.payments.push({ id: Date.now(), date: new Date(year, month, new Date(year, month + 1, 0).getDate()).toISOString().split('T')[0], amount: balance, note: `تسوية راتب شهر ${monthName}`, type: 'deduction' });
          
          if (!worker.settlements) worker.settlements = [];
          worker.settlements.push(settlementKey);

          await db.workers.update(workerId, { payments: worker.payments, settlements: worker.settlements });
      }
  }

  async function openFullActivityLog(workerId) {
      const worker = state.workers.find(w => w.id == workerId);
      if (!worker) return;

      const fullLogHTML = generateActivityLog(worker); // No limit
      const logModalContent = document.getElementById('fullActivityLogContent');
      logModalContent.innerHTML = fullLogHTML;
      
      // Re-attach event listeners for delete buttons inside the modal
      logModalContent.querySelectorAll('.delete-activity').forEach(btn => btn.addEventListener('click', handleDeleteActivity));

      openModal('activityLogModal');
  }

  function closeFullActivityLog() {
      closeModal('activityLogModal');
  }

  function resetImagePreview() {
      workerImageDataBase64.value = '';
      workerImageInput.value = ''; // Reset file input
      workerImagePreview.src = '';
      workerImagePreview.style.display = 'none';
      workerImagePlaceholder.style.display = 'flex';
      workerImageRemoveBtn.style.display = 'none';
  }

  function closeWorkerModal() {
      closeModal('workerModal');
  }

  function showImagePreview(show) {
      workerImagePreview.style.display = show ? 'block' : 'none';
      workerImagePlaceholder.style.display = show ? 'none' : 'flex';
      workerImageRemoveBtn.style.display = show ? 'inline-block' : 'none';
  }

  function openActivityModal(type) {
      const workerId = state.currentView.params.id;
      if (!workerId) return;

      activityForm.reset();
      document.getElementById('activityWorkerId').value = workerId;
      document.getElementById('activityType').value = type;
      document.getElementById('activityDate').valueAsDate = new Date();
      
      const worker = state.workers.find(w => w.id == workerId);

      const isFinancial = type === 'deduction' || type === 'bonus';
      const paymentGroup = document.getElementById('paymentAmountGroup');
      const noteGroup = document.getElementById('activityNoteGroup');
      const attendanceRateGroup = document.getElementById('attendanceRateGroup');

      paymentGroup.style.display = isFinancial ? 'block' : 'none';
      noteGroup.style.display = isFinancial ? 'block' : 'none';
      document.getElementById('paymentAmount').required = isFinancial;
      
      attendanceRateGroup.style.display = type === 'attendance' ? 'block' : 'none';
      if (type === 'attendance' && worker) {
          document.getElementById('attendanceDailyRate').value = worker.dailyRate || '';
      }

      let title = 'تسجيل يوم عمل';
      if (type === 'deduction') title = 'تسجيل خصم / مصاريف';
      if (type === 'bonus') title = 'تسجيل مكافأة (منحة)';
      document.getElementById('activityModalTitle').textContent = title;
      
      openModal('activityModal');
  }

  function closeActivityModal() {
      closeModal('activityModal');
  }

  async function handleWorkerFormSubmit(e) {
      e.preventDefault();
      const id = workerIdInput.value ? parseInt(workerIdInput.value) : null;
      const workerData = {
          name: workerNameInput.value,
          phone: workerPhoneInput.value,
          imageUrl: workerImageDataBase64.value,
          dailyRate: parseFloat(workerDailyRateInput.value) || 0,
          pin: workerPinInput.value || null, // Store PIN or null
      };

      if (id) { // Update existing worker
          await db.workers.update(id, workerData);
      } else { // Add new worker
          workerData.attendance = [];
          workerData.bonuses = [];
          workerData.payments = [];
          workerData.settlements = [];
          await db.workers.add(workerData);
      }
      renderView(id ? state.currentView.name : 'workers', id ? { id: id } : {});
      closeWorkerModal();
  }

  async function handleActivityFormSubmit(e) {
      e.preventDefault();
      const workerId = parseInt(document.getElementById('activityWorkerId').value);
      const type = document.getElementById('activityType').value;
      const date = document.getElementById('activityDate').value;

      const worker = state.workers.find(w => w.id == workerId);
      if (!worker) return;

      // Remove any existing attendance record for this date to avoid duplicates
      if (type === 'attendance' && worker.attendance) { 
          worker.attendance = worker.attendance.filter(a => a.date !== date);
      }

      if (type === 'deduction') {
          const amount = parseFloat(document.getElementById('paymentAmount').value);
          const note = document.getElementById('activityNote').value;
          if (!amount || amount <= 0) return;
          if (!worker.payments) worker.payments = []; 
          // Save with type and note
          worker.payments.push({ id: Date.now(), date, amount, note, type }); 
          await db.workers.update(workerId, { payments: worker.payments });
      } else if (type === 'bonus') {
          const amount = parseFloat(document.getElementById('paymentAmount').value);
          const note = document.getElementById('activityNote').value;
          if (!amount || amount <= 0) return;
          if (!worker.bonuses) worker.bonuses = [];
          worker.bonuses.push({ id: Date.now(), date, amount, note }); 
          await db.workers.update(workerId, { bonuses: worker.bonuses });
      } else { // attendance
          if (!worker.attendance) worker.attendance = [];
          const dailyRate = parseFloat(document.getElementById('attendanceDailyRate').value) || worker.dailyRate || 0;
          // Open confirmation modal instead of saving directly
          openAttendanceConfirmModal({ worker, date, dailyRate });
          return; // Stop execution here, will be continued by saveAttendance()
      }
      
      renderView('worker-details', { id: workerId, month: new Date(date).getMonth(), year: new Date(date).getFullYear() });
      closeActivityModal();
  }

  // *** إضافة: دالة مزامنة بيانات العمال إلى Firestore ***
  async function syncWorkLogs() {
      const user = auth.currentUser;
      if (!user) {
          showCustomToast('يجب تسجيل الدخول لتنفيذ المزامنة.', 'error');
          return;
      }

      const syncBtn = document.getElementById('syncWorkersBtn');
      syncBtn.disabled = true;
      syncBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i>';

      try {
          // 1. جمع كل بيانات العمال من Dexie
          let workersData = await db.workers.toArray();

          // *** إصلاح: التأكد من أن كل عامل لديه حقل `uid` قبل المزامنة ***
          // هذا الحقل ضروري لتطبيق العامل ليعرف هويته.
          workersData = workersData.map(worker => {
              if (worker.id && !worker.uid) worker.uid = worker.id.toString();
              return worker;
          });

          // 2. تجهيز البيانات للإرسال مع طابع زمني
          const syncData = {
              workers: workersData,
              timestamp: firebase.firestore.FieldValue.serverTimestamp()
          };

          // 3. إرسال البيانات إلى Firestore (استخدام set للكتابة فوق السجل القديم)
          // *** تعديل: استخدام المسار الصحيح المتوافق مع قواعد Firestore ***
          await firestore.collection('users').doc(user.uid).collection('workLogs').doc('latest').set(syncData);

          // *** تعديل: تحديث مستند الـ metadata لتفعيل الإشعارات لدى العمال ***
          // *** تعديل: استخدام المسار الصحيح المتوافق مع قواعد Firestore ***
          await firestore.collection('users').doc(user.uid).collection('metadata').doc('workLogsMeta').set({
              lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
              updatedBy: user.uid,
              updaterDevice: deviceIdentifier
          });

          // 4. إظهار رسالة نجاح
          // *** تعديل: استخدام showToast بدلاً من showCustomToast للرسائل الإيجابية ***
          showToast('تمت المزامنة بنجاح');

      } catch (error) {
          console.error("Sync failed:", error);
          showCustomToast('فشل المزامنة. تحقق من اتصالك بالإنترنت.', 'error');
      } finally {
          syncBtn.disabled = false;
          syncBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
      }
  }

  function setupAiAssistantListeners() {
    const input = document.getElementById('aiPromptInput');
    const sendBtn = document.getElementById('sendAiPromptBtn');
    const history = document.getElementById('aiChatHistory');

    if (!input || !sendBtn || !history) return;

    const toggleSendButton = () => {
        sendBtn.disabled = input.value.trim() === '';
    };

    input.addEventListener('input', toggleSendButton);
    sendBtn.addEventListener('click', handleSendAiPrompt);
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!sendBtn.disabled) handleSendAiPrompt();
        }
    });
    history.addEventListener('click', (e) => {
        if (e.target.classList.contains('suggestion-btn')) {
            input.value = e.target.textContent;
            toggleSendButton();
            handleSendAiPrompt();
        }
    });
  }

  function handleFactoryReset() {
      openConfirmModal('هل أنت متأكد تماماً من رغبتك في حذف جميع البيانات؟ هذا الإجراء نهائي ولا يمكن التراجع عنه.', async () => {
          closeConfirmModal();
          showToast('جاري إعادة الضبط...');
          await db.delete(); // Deletes the entire database
          // Wait a moment for the toast to be visible, then reload
          setTimeout(() => { location.reload(); }, 1500);
      });
  }

  async function handleDeleteActivity(e) {
      const btn = e.currentTarget;
      const workerId = parseInt(btn.dataset.workerId);
      openConfirmModal('هل أنت متأكد من حذف هذا النشاط؟', async () => {
          const { activityId, type } = btn.dataset;
          const worker = state.workers.find(w => w.id == workerId);
          if (!worker) return;
  
          if (type === 'attendance' && worker.attendance) {
              worker.attendance = worker.attendance.filter(a => a.id != activityId);
              await db.workers.update(workerId, { attendance: worker.attendance });
          } else if (type === 'deduction' && worker.payments) {
              worker.payments = worker.payments.filter(p => p.id != activityId);
              await db.workers.update(workerId, { payments: worker.payments });
          } else if (type === 'bonus' && worker.bonuses) {
              worker.bonuses = worker.bonuses.filter(b => b.id != activityId);
              await db.workers.update(workerId, { bonuses: worker.bonuses });
          }
          
          closeConfirmModal();
          await renderView('worker-details', { id: workerId });
          if (!document.getElementById('activityLogModal').classList.contains('modal-hidden')) {
              openFullActivityLog(workerId); // Refresh the full log modal if it's open
          }
      });
  }
  


  function openDebtPaymentModal(debtId) {
      const modal = document.getElementById('debtPaymentModal');
      const form = document.getElementById('debtPaymentForm');
      
      form.reset();
      document.getElementById('paymentDebtId').value = debtId;
      document.getElementById('debtPaymentDate').valueAsDate = new Date();
      
      const debt = state.debts.find(d => d.id === debtId);
      if (debt) {
          document.getElementById('debtPaymentAmount').max = debt.remaining;
      }
      
      openModal('debtPaymentModal');
  }

  function closeDebtPaymentModal() {
      closeModal('debtPaymentModal');
  }

  async function handleDebtPaymentFormSubmit(e) {
      e.preventDefault();
      
      const debtId = parseInt(document.getElementById('paymentDebtId').value);
      const payment = {
          amount: parseFloat(document.getElementById('debtPaymentAmount').value),
          date: document.getElementById('debtPaymentDate').value,
          notes: document.getElementById('debtPaymentNotes').value
      };
      
      try {
          const debt = await db.debts.get(debtId);
          if (!debt) throw new Error('الدين غير موجود');
          
          // Check if payment amount is valid
          if (payment.amount <= 0 || payment.amount > debt.remaining) {
              showCustomToast('مبلغ الدفع غير صالح', 'error');
              return;
          }
          
          // Update debt
          debt.payments = debt.payments || [];
          debt.payments.push(payment);
          debt.remaining -= payment.amount;
          debt.lastPaymentDate = payment.date;

          await db.debts.update(debtId, debt);

          showToast('تم تسجيل الدفعة بنجاح');
          closeDebtPaymentModal();
          // *** إصلاح: تحديث واجهة تفاصيل الدين الحالية بدلاً من العودة للقائمة الرئيسية ***
          renderView('debt-details', { id: debtId });
      } catch (error) {
          console.error('Error saving payment:', error);
          showCustomToast('حدث خطأ أثناء حفظ الدفعة', 'error');
      }
  }

  // *** إضافة: دالة لحذف الدين ***
  function handleDeleteDebt(debtId) {
      openConfirmModal('هل أنت متأكد من حذف هذا الدين؟', async () => {
          await db.debts.delete(debtId);
          closeConfirmModal();
          renderView('debts_feature');
          showToast('تم حذف الدين بنجاح.');
      });
  }

  async function printWorkerReport(workerId) {
    const worker = state.workers.find(w => w.id == workerId);
    if (!worker) return;

    const { totalDue, totalPaid, presentDays } = calculateWorkerFinancials(worker, -1, -1); // Get total financials for report
    const balance = totalDue - totalPaid;
    const activityLogHTML = generateActivityLog(worker);

    const printContent = `
        <div style="font-family: 'Tajawal', sans-serif; direction: rtl; padding: 20px;">
            <h1 style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px;">تقرير العامل</h1>
            
            <h2 style="margin-top: 30px;">بيانات العامل</h2>
            <p><strong>الاسم:</strong> ${worker.name}</p>
            <p><strong>رقم الهاتف:</strong> ${worker.phone || 'غير متوفر'}</p>
            <p><strong>الأجرة اليومية:</strong> ${worker.dailyRate.toLocaleString()} د.ج</p>

            <h2 style="margin-top: 30px;">ملخص مالي</h2>
            <table style="width: 100%; border-collapse: collapse; text-align: right;">
                <tr style="background-color: #f2f2f2;">
                    <th style="padding: 8px; border: 1px solid #ddd;">الوصف</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">القيمة</th>
                </tr>
                <tr><td style="padding: 8px; border: 1px solid #ddd;">إجمالي أيام الحضور</td><td style="padding: 8px; border: 1px solid #ddd;">${presentDays} يوم</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ddd;">إجمالي المستحقات</td><td style="padding: 8px; border: 1px solid #ddd;">${totalDue.toLocaleString()} د.ج</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ddd;">اجمالي الخصومات</td><td style="padding: 8px; border: 1px solid #ddd;">${totalPaid.toLocaleString()} د.ج</td></tr>
                <tr style="font-weight: bold;">
                    <td style="padding: 8px; border: 1px solid #ddd;">الرصيد المتبقي</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${balance.toLocaleString()} د.ج</td>
                </tr>
            </table>

            <h2 style="margin-top: 30px;">سجل الأنشطة</h2>
            <div class="activity-log-print-container">
                ${activityLogHTML.replace(/class="delete-activity".*?<\/button>/g, '')}
            </div>
        </div>
    `;

    document.getElementById('printContainer').innerHTML = printContent;
    window.print();
  }

  async function printExpenseReport(expenseId) {
    const expense = state.expenses.find(e => e.id === expenseId);
    if (!expense) return;

    const worker = expense.workerId ? state.workers.find(w => w.id === expense.workerId) : null;
    const project = expense.projectId ? state.projects.find(p => p.id === expense.projectId) : null;

    const printContent = `
        <div style="font-family: 'Tajawal', sans-serif; direction: rtl; padding: 20px; max-width: 800px; margin: auto;">
            <header style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px;">
                <h1 style="margin: 0; font-size: 24px;">وصل مصروفات</h1>
                <div style="text-align: left;">
                    <div style="font-size: 14px;">My Decor Manager</div>
                    <div style="font-size: 12px; color: #555;">تاريخ الطباعة: ${new Date().toLocaleDateString('ar-DZ')}</div>
                </div>
            </header>
            
            <h2 style="margin-top: 30px; font-size: 18px; border-bottom: 1px solid #eee; padding-bottom: 8px;">تفاصيل المعاملة</h2>
            <table style="width: 100%; border-collapse: collapse; text-align: right; font-size: 15px; margin-top: 15px;">
                <tr style="line-height: 2;"><td style="padding: 8px; width: 30%; color: #555;">الوصف:</td><td style="padding: 8px; font-weight: bold;">${expense.description}</td></tr>
                <tr style="line-height: 2;"><td style="padding: 8px; color: #555;">التاريخ:</td><td style="padding: 8px; font-weight: bold;">${new Date(expense.date).toLocaleDateString('ar-DZ', { dateStyle: 'long' })}</td></tr>
                ${project ? `<tr style="line-height: 2;"><td style="padding: 8px; color: #555;">المشروع:</td><td style="padding: 8px; font-weight: bold;">${project.name}</td></tr>` : ''}
                ${worker ? `<tr style="line-height: 2;"><td style="padding: 8px; color: #555;">الشخص:</td><td style="padding: 8px; font-weight: bold;">${worker.name}</td></tr>` : ''}
                <tr style="line-height: 2; font-size: 18px; background: #f9f9f9;">
                    <td style="padding: 12px; color: #555;">المبلغ الإجمالي:</td>
                    <td style="padding: 12px; font-weight: 800; color: #d9534f; text-align: left;">${expense.amount.toLocaleString()} د.ج</td>
                </tr>
            </table>

            ${expense.receiptUrl ? `
            <div style="margin-top: 30px;">
                <h2 style="font-size: 18px; border-bottom: 1px solid #eee; padding-bottom: 8px;">صورة الإيصال المرفقة</h2>
                <img src="${expense.receiptUrl}" alt="صورة الإيصال" style="width: 100%; max-width: 400px; border-radius: 8px; border: 1px solid #ddd; display: block; margin: 15px auto;">
            </div>
            ` : ''}
        </div>
    `;

    document.getElementById('printContainer').innerHTML = printContent;
    window.print();
  }



  // HTML for the Debt Payment Modal
  document.body.insertAdjacentHTML('beforeend', `
    <div id="debtPaymentModal" class="modal-container modal-hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="debtPaymentModalTitle">تسجيل دفعة</h3>
                <button class="close-btn" data-action="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="debtPaymentForm">
                    <input type="hidden" id="debtPaymentId">
                    <input type="hidden" id="paymentDebtId">
                    
                    <div class="form-group">
                        <label for="debtPaymentAmount">المبلغ المدفوع (د.ج)</label>
                        <input type="number" id="debtPaymentAmount" required min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="debtPaymentDate">تاريخ الدفع</label>
                        <input type="date" id="debtPaymentDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="debtPaymentNotes">ملاحظات (اختياري)</label>
                        <textarea id="debtPaymentNotes" rows="3" placeholder="مثال: دفعة القسط الشهري..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn">حفظ الدفعة</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
  `);

  // HTML for the new Project Modal
  document.body.insertAdjacentHTML('beforeend', ` 
    <div id="projectModal" class="modal-container modal-hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="projectModalTitle">إضافة مشروع جديد</h3>
                <button class="close-btn" data-action="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="projectForm">
                    <input type="hidden" id="projectId">
                    <div class="form-group">
                        <label for="projectName">اسم المشروع</label>
                        <input type="text" id="projectName" required>
                    </div>
                    <!-- *** إضافة: حقل جديد لاسم صاحب المنزل *** -->
                    <div class="form-group">
                        <label for="homeownerName">اسم صاحب المنزل (اختياري)</label>
                        <input type="text" id="homeownerName" placeholder="مثال: السيد أحمد">
                    </div>
                    <!-- *** إضافة: حقل جديد لاسم صاحب البناء *** -->
                    <div class="form-group">
                        <label for="builderName">اسم صاحب البناء (اختياري)</label>
                        <input type="text" id="builderName" placeholder="مثال: شركة البناء الحديث">
                    </div>
                    <div class="form-group">
                        <label for="projectBudget">الميزانية التقديرية (د.ج)</label>
                        <input type="number" id="projectBudget">
                    </div>
                    <!-- *** إضافة: عرض حالة المشروع داخل نافذة التعديل *** -->
                    <div class="form-group" id="projectStatusContainer" style="display: none;">
                        <label>حالة المشروع الحالية</label>
                        <span id="projectStatusBadge" class="status-badge"></span>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn">حفظ التعديلات</button>
                        <!-- *** تحسين: زر إنهاء المشروع يظهر هنا فقط إذا كان المشروع نشطاً *** -->
                        <button type="button" class="btn" id="finishProjectBtn" style="display: none; background-color: #f97316; margin-left: auto; margin-right: 0;">إنهاء المشروع</button>
                        <button type="button" class="btn" id="deleteProjectBtn" style="display: none; background-color: #ef4444;">حذف المشروع</button>
                    </div>
                </form>
            </div>
        </div>
    </div>`);


  // HTML for the new API Config Modal
  document.body.insertAdjacentHTML('beforeend', ` 
    <div id="apiConfigModal" class="modal-container modal-hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="apiConfigModalTitle">إضافة مفتاح API جديد</h3>
                <button class="close-btn" data-action="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="apiConfigForm">
                    <div class="form-group">
                        <label for="apiConfigProvider">مزود الخدمة</label> 
                        <select id="apiConfigProvider" class="form-group input" style="padding: 10px; width: 100%;"><option value="openrouter">OpenRouter</option></select>
                    </div>
                    <div class="form-group">
                        <label for="apiConfigModel">النموذج</label>
                        <select id="apiConfigModel" class="form-group input" style="padding: 10px; width: 100%;">
                            <!-- سيتم ملء الخيارات هنا بواسطة JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="apiConfigKey">مفتاح API</label>
                        <input type="password" id="apiConfigKey" required placeholder="أدخل مفتاح الـ API هنا">
                    </div>
                    <div class="form-actions"><button type="submit" class="btn">حفظ</button></div>
                </form>
            </div>
        </div>
    </div>`);

  // HTML for the new Profile Modal
  document.body.insertAdjacentHTML('beforeend', ` 
    <div id="profileModal" class="modal-container modal-hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="profileModalTitle">إضافة ملف تعريفي</h3>
                <button class="close-btn" data-action="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="profileForm">
                    <input type="hidden" id="profileId">
                    <input type="hidden" id="profileLogoDataBase64">

                    <div class="form-group" style="text-align: center; position: relative;">
                        <img id="profileLogoPreview" src="" alt="الشعار" style="width: 100px; height: 100px; border-radius: 16px; object-fit: cover; border: 3px solid var(--border-color); display: none; margin: 0 auto 10px;">
                        <button type="button" id="profileLogoRemoveBtn" title="إزالة الشعار" style="position: absolute; top: -5px; left: 50%; transform: translateX(40px); width: 28px; height: 28px; border-radius: 50%; background: #ef4444; color: white; border: 2px solid var(--card); font-size: 14px; display: none; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
                        <div id="profileLogoPlaceholder" class="icon" style="width: 100px; height: 100px; border-radius: 16px; background: linear-gradient(135deg,#a855f7,#9333ea); font-size: 40px; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                            <i class="fas fa-id-card"></i>
                        </div>
                        <input type="file" id="profileLogoInput" accept="image/*" style="display: none;">
                        <button type="button" id="profileLogoUploadBtn" class="btn ghost" style="padding: 6px 12px; font-size: 13px;">إرفاق شعار</button>

                    <div class="form-group">
                        <label for="profileName">اسم الملف (للتنظيم الداخلي)</label>
                        <input type="text" id="profileName" required placeholder="مثال: حسابي الشخصي">
                    </div>
                    <div class="form-group">
                        <label for="ownerName">اسم صاحب الحساب (اختياري)</label>
                        <input type="text" id="ownerName" placeholder="الاسم الكامل كما يظهر للعميل">
                    </div>
                    <div class="form-group">
                        <label for="profession">المهنة / الصفة</label>
                        <input type="text" id="profession" placeholder="مثال: مصمم ديكور">
                    </div>
                    <div class="form-group">
                        <label for="profilePhone1">رقم الهاتف 1 </label>
                        <input type="tel" id="profilePhone1" placeholder="رقم الهاتف الأساسي">
                    </div>
                    <div class="form-group">
                        <label for="profilePhone2">رقم الهاتف 2</label>
                        <input type="tel" id="profilePhone2" placeholder="رقم هاتف إضافي">
                    </div>
                    <div class="form-group">
                        <label for="profileCcp">حساب CCP</label>
                        <input type="text" id="profileCcp" placeholder="رقم الحساب البريدي الجاري">
                    </div>
                    <div class="form-group">
                        <label for="profileRip">حساب RIP / BaridiMob</label>
                        <input type="text" id="profileRip" placeholder="مفتاح الحساب البنكي">
                    </div>
                    <div class="form-group">
                        <label for="profileAddress">العنوان</label>
                        <input type="text" id="profileAddress" placeholder="عنوان السكن أو العمل">
                    </div>
                    <div class="form-group">
                        <label for="privateNotes">معلومات إضافية (اختياري)</label>
                        <textarea id="privateNotes" rows="3" placeholder="أي معلومات إضافية تود ظهورها في البطاقة..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn">حفظ الملف</button>
                        <button type="button" class="btn" id="deleteProfileBtn" style="display: none; background-color: #ef4444;">حذف</button>
                    </div>
                </form>
            </div>
        </div>
    </div>`);

  // HTML for the new Expense Modal
  document.body.insertAdjacentHTML('beforeend', ` 
    <div id="expenseModal" class="modal-container modal-hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="expenseModalTitle">إضافة نفقة جديدة</h3>
                <button class="close-btn" data-action="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="expenseForm">
                    <input type="hidden" id="expenseId">
                    <input type="hidden" id="expenseModalContext"> <!-- *** إضافة: حقل لتخزين سياق الفتح *** -->
                    <input type="hidden" id="expenseImageDataBase64">

                    <div class="form-group" style="text-align: center; position: relative;">
                        <img id="expenseImagePreview" src="" alt="صورة الإيصال" style="width: 100px; height: 100px; border-radius: 12px; object-fit: cover; border: 3px solid var(--border-color); display: none; margin: 0 auto 10px;">
                        <button type="button" id="expenseImageRemoveBtn" title="إزالة الصورة" style="position: absolute; top: -5px; left: 50%; transform: translateX(40px); width: 28px; height: 28px; border-radius: 50%; background: #ef4444; color: white; border: 2px solid var(--card); font-size: 14px; display: none; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
                        <div id="expenseImagePlaceholder" class="icon" style="width: 100px; height: 100px; border-radius: 12px; background: linear-gradient(135deg,#ef4444,#dc2626); font-size: 40px; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <input type="file" id="expenseImageInput" accept="image/*" style="display: none;">
                        <button type="button" id="expenseImageUploadBtn" class="btn ghost" style="padding: 6px 12px; font-size: 13px;">إرفاق إيصال</button>

                    <div class="form-group">
                        <label for="expenseDescription">وصف النفقة</label>
                        <input type="text" id="expenseDescription" required placeholder="مثال: شراء دهانات">
                    </div>
                    <div class="form-group">
                        <label for="expenseAmount">المبلغ (د.ج)</label>
                        <input type="number" id="expenseAmount" required>
                    </div>
                    <div class="form-group">
                        <label for="expenseDate">التاريخ</label>
                        <input type="date" id="expenseDate" required style="background: var(--card); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; width: 100%;">
                    </div>
                    <div class="form-group">
                        <label for="expenseProjectName">ربط بمشروع (اكتب للاختيار أو للإضافة)</label>
                        <input type="text" id="expenseProjectName" list="project-list" placeholder="مثال: فيلا بودواو" style="background: var(--card); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; width: 100%;">
                        <datalist id="project-list"></datalist>
                    </div>
                    <!-- *** إضافة: حقل جديد للملاحظات *** -->
                    <div class="form-group">
                        <label for="expenseNotes">ملاحظات (اختياري)</label>
                        <textarea id="expenseNotes" rows="3" placeholder="أضف أي تفاصيل إضافية هنا..."></textarea>
                    </div>
                    <div class="form-group payment-status-group" style="background: var(--card); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px;">
                        <label style="margin-bottom: 10px; display: block;">حالة الدفع</label>
                        <div style="display: flex; gap: 10px;">
                            <label style="flex: 1; cursor: pointer;">
                                <input type="radio" name="expensePaymentStatus" value="paid" checked style="margin-left: 5px;">مدفوع
                            </label>
                            <label style="flex: 1; cursor: pointer;">
                                <input type="radio" name="expensePaymentStatus" value="unpaid" style="margin-left: 5px;">غير مدفوع
                            </label>
                        </div>
                    </div>
                    <div class="form-actions"><button type="submit" class="btn">حفظ</button><button type="button" class="btn" id="deleteExpenseBtn" style="display: none; background-color: #ef4444;">حذف</button></div>
                </form>
            </div>
        </div>
    </div>`);

  // HTML for the new Project Payment Modal
  document.body.insertAdjacentHTML('beforeend', ` 
    <div id="projectPaymentModal" class="modal-container modal-hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="projectPaymentModalTitle">إضافة دفعة من العميل</h3>
                <button class="close-btn" data-action="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="projectPaymentForm">
                    <input type="hidden" id="projectPaymentId">
                    <input type="hidden" id="paymentProjectId">
                    <div class="form-group">
                        <!-- *** إصلاح: تم تغيير id ليكون فريداً وتجنب التعارض مع النماذج الأخرى *** -->
                        <label for="projectPaymentAmount">المبلغ المستلم (د.ج)</label>
                        <input type="number" id="projectPaymentAmount" required>
                    </div>
                    <div class="form-group">
                        <label for="paymentDate">تاريخ الاستلام</label>
                        <input type="date" id="paymentDate" required>
                    </div>
                    <!-- *** إضافة: حقل جديد لإضافة ملاحظات على الدفعة *** -->
                    <div class="form-group">
                        <label for="projectPaymentNotes">ملاحظات (اختياري)</label>
                        <textarea id="projectPaymentNotes" rows="3" placeholder="مثال: دفعة أولى حسب العقد..."></textarea>
                    </div>
                  <div class="form-actions"><button type="submit" class="btn">حفظ الدفعة</button><button type="button" class="btn" id="deleteProjectPaymentBtn" style="display: none; background-color: #ef4444;">حذف</button></div>
                </form>
            </div>
        </div>
    </div>`);

  // HTML for the new AI Analysis Modal
  document.body.insertAdjacentHTML('beforeend', ` 
    <div id="aiAnalysisModal" class="modal-container modal-hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="aiAnalysisModalTitle">تحليل بالذكاء الاصطناعي</h3>
                <button class="close-btn" data-action="close-modal">&times;</button>
            </div>
            <div class="modal-body" id="aiAnalysisModalBody" style="min-height: 150px; line-height: 1.7;">
                <!-- AI response will be injected here -->
            </div>
        </div>
    </div>`);



  // Project Modal Functions
  function openProjectModal(projectId = null) {
      const modal = document.getElementById('projectModal');
      const titleEl = document.getElementById('projectModalTitle');
      const form = document.getElementById('projectForm');
      const deleteBtn = document.getElementById('deleteProjectBtn');
      const idInput = document.getElementById('projectId');
      // *** إضافة: جلب زر إنهاء المشروع من نافذة التعديل ***
      const finishBtn = document.getElementById('finishProjectBtn');
      // *** إضافة: جلب حاوية وشارة الحالة ***
      const statusContainer = document.getElementById('projectStatusContainer');
      const statusBadge = document.getElementById('projectStatusBadge');

      form.reset();
      deleteBtn.style.display = 'none';
      finishBtn.style.display = 'none'; // إخفاؤه افتراضياً
      statusContainer.style.display = 'none'; // إخفاء حاوية الحالة افتراضياً

      if (projectId) {
          const project = state.projects.find(p => p.id === projectId);
          if (project) {
              titleEl.textContent = 'تعديل المشروع';
              document.getElementById('projectName').value = project.name;
              // *** إضافة: تعبئة الحقول الجديدة عند التعديل ***
              document.getElementById('homeownerName').value = project.homeownerName || '';
              document.getElementById('builderName').value = project.builderName || '';
              document.getElementById('projectBudget').value = project.budget || '';
              idInput.value = project.id;
              deleteBtn.style.display = 'block';

              // *** تحسين: عرض الحالة داخل نافذة التعديل ***
              statusContainer.style.display = 'block';
              statusBadge.textContent = project.status === 'finished' ? 'منتهي' : 'نشط';
              statusBadge.style.backgroundColor = project.status === 'finished' ? 'var(--muted)' : '#10b981';

              // *** تحسين: إظهار زر الإنهاء فقط إذا كان المشروع نشطاً ***
              if (project.status !== 'finished') {
                  finishBtn.style.display = 'block';
              }
          }
      } else {
          titleEl.textContent = 'إضافة مشروع جديد';
          idInput.value = '';
      }

      openModal('projectModal');
  }
  // *** تحسين: دالة موحدة لتغيير حالة المشروع مع معالجة الأخطاء ***
  async function toggleProjectStatus(projectId, newStatus) {
      try {
          await db.projects.update(projectId, { status: newStatus });
          console.log(`Project ${projectId} status successfully updated to '${newStatus}'`);
          // لا تقم بإعادة العرض هنا، سيتم التحكم به من الخارج
      } catch (error) {
          console.error("Failed to update project status:", error);
          alert("حدث خطأ أثناء تحديث حالة المشروع. يرجى المحاولة مرة أخرى.");
          // Re-throw the error to stop the calling function's flow if needed
          throw error;
      }
  }

  // *** إضافة: ربط أزرار حالة المشروع (إنهاء وإعادة فتح) ***
  mainContent.addEventListener('click', async (e) => {
      const reopenBtn = e.target.closest('#reopenProjectBtn');
      if (reopenBtn) {
          const id = parseInt(reopenBtn.dataset.id);
          // التأكيد قبل إعادة تفعيل المشروع
          openConfirmModal('هل تريد إعادة تفعيل هذا المشروع؟', async () => {
              try {
                  await toggleProjectStatus(id, 'active'); // تحديث الحالة
                  renderView('project-details', { id: id });
                  showToast('تمت إعادة تفعيل المشروع.');
                  closeConfirmModal();
              } catch (error) {
                  showCustomToast('حدث خطأ أثناء إعادة تفعيل المشروع', 'error');
              }
          });
      }
  });

  function closeProjectModal() {
      closeModal('projectModal');
  }

  async function handleProjectFormSubmit(e) {
      e.preventDefault();
      
      const projectData = {
          name: document.getElementById('projectName').value,
          // *** إضافة: حفظ القيم الجديدة في قاعدة البيانات ***
          homeownerName: document.getElementById('homeownerName').value,
          builderName: document.getElementById('builderName').value,
          budget: parseFloat(document.getElementById('projectBudget').value) || 0
      };

      const projectId = document.getElementById('projectId').value;
      
      try {
          if (projectId) {
              await db.projects.update(parseInt(projectId), projectData);
              showToast('تم تحديث المشروع بنجاح');
          } else {
              // *** إضافة: تحديد الحالة الافتراضية للمشروع الجديد ***
              projectData.status = 'active';
              await db.projects.add(projectData);
              showToast('تم إضافة المشروع بنجاح');
          }
          closeProjectModal();
          // *** تحسين: الانتقال إلى تفاصيل المشروع بعد الحفظ أو التعديل ***
          renderView(projectId ? 'project-details' : 'projects', projectId ? { id: parseInt(projectId) } : {});
      } catch (error) {
          console.error('Error saving project:', error);
          showCustomToast('حدث خطأ أثناء حفظ المشروع', 'error');
      }
  }

  // Project Payment Modal Functions
  function openProjectPaymentModal(paymentId = null, projectId) {
      const modal = document.getElementById('projectPaymentModal');
      const form = document.getElementById('projectPaymentForm');
      const titleEl = document.getElementById('projectPaymentModalTitle');
      const deleteBtn = document.getElementById('deleteProjectPaymentBtn');
      
      form.reset();
      document.getElementById('paymentProjectId').value = projectId;
      deleteBtn.style.display = 'none';

      if (paymentId) {
          const payment = state.projectPayments.find(p => p.id === paymentId);
          if (payment) {
              titleEl.textContent = 'تعديل دفعة العميل';
              document.getElementById('projectPaymentId').value = payment.id; 
              // *** إصلاح: استخدام الـ id الجديد للحقل ***
              document.getElementById('projectPaymentAmount').value = payment.amount;
              document.getElementById('paymentDate').value = payment.date;
              // *** إضافة: تعبئة حقل الملاحظات عند التعديل ***
              document.getElementById('projectPaymentNotes').value = payment.notes || '';
              deleteBtn.style.display = 'block';
          }
      } else {
          titleEl.textContent = 'إضافة دفعة من العميل';
          document.getElementById('projectPaymentId').value = '';
          document.getElementById('paymentDate').valueAsDate = new Date();
      }

      openModal('projectPaymentModal');
  }

  function closeProjectPaymentModal() {
      closeModal('projectPaymentModal');
  }

  async function handleProjectPaymentFormSubmit(e) {
      e.preventDefault();
      if (!e.target.checkValidity()) return; // Prevent submission if form is invalid
      const paymentId = document.getElementById('projectPaymentId').value;
      const projectId = parseInt(document.getElementById('paymentProjectId').value);
      const paymentData = {
          projectId: projectId,
          // *** إصلاح: القراءة من الـ id الصحيح وتحويل القيمة إلى رقم ***
          amount: parseFloat(document.getElementById('projectPaymentAmount').value) || 0,
          date: document.getElementById('paymentDate').value,
          // *** إضافة: حفظ قيمة الملاحظات في قاعدة البيانات ***
          notes: document.getElementById('projectPaymentNotes').value,
      };

      if (paymentId) {
          await db.projectPayments.update(parseInt(paymentId), paymentData);
          showToast('تم تحديث الدفعة بنجاح');
      } else {
          await db.projectPayments.add(paymentData);
          showToast('تم إضافة الدفعة بنجاح');
      }
      closeProjectPaymentModal();
      renderView('project-details', { id: projectId, tab: 'finance' });
  }

  // *** إصلاح: إضافة معالج حدث لزر حذف الدفعة ***
  document.getElementById('deleteProjectPaymentBtn').addEventListener('click', () => {
      // فتح نافذة التأكيد قبل الحذف
      openConfirmModal('هل أنت متأكد من حذف هذه الدفعة؟', async () => {
          const paymentId = parseInt(document.getElementById('projectPaymentId').value);
          const projectId = parseInt(document.getElementById('paymentProjectId').value);
          if (paymentId) {
              // تنفيذ عملية الحذف من قاعدة البيانات
              await db.projectPayments.delete(paymentId);
              showToast('تم حذف الدفعة بنجاح');
              closeProjectPaymentModal();
              closeConfirmModal();
              // تحديث الواجهة مباشرة لإظهار التغيير
              renderView('project-details', { id: projectId, tab: 'finance' });
          }
      });
  });

  function deleteWorker() {
      // Implementation for deleting a worker will be added in the next step
  }

  // *** إضافة: دالة لإظهار رسالة منبثقة مع زر تراجع ***
  function showUndoToast(message, onUndo) {
      const container = document.getElementById('toastContainer');
      if (!container) return;

      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.style.backgroundColor = '#f97316'; // Orange color for this special toast

      const messageSpan = document.createElement('span');
      messageSpan.innerHTML = message;

      const undoButton = document.createElement('button');
      undoButton.textContent = onUndo.name === 'reopenProject' ? 'إعادة تفعيل' : 'تراجع'; // *** تحسين: تغيير نص الزر حسب السياق ***
      undoButton.style.cssText = 'background: rgba(255,255,255,0.2); color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; margin-right: 15px; font-weight: 700;';
      
      undoButton.onclick = () => {
          onUndo();
          toast.remove();
      };

      toast.appendChild(messageSpan);
      toast.appendChild(undoButton);
      container.appendChild(toast);

      setTimeout(() => { toast.remove(); }, 6000); // Remove after 6 seconds if not undone
  }

  function switchProjectTab(tabId) {
    // Update URL without reloading to remember the tab
    const projectId = state.currentView.params.id;
    state.currentView.params.tab = tabId;

    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    // Deactivate all tab buttons
    document.querySelectorAll('.tab-card').forEach(button => button.classList.remove('active'));
    // Show the selected tab content
    document.getElementById(`${tabId}Tab`).classList.add('active');
    // Activate the selected tab button
    document.querySelector(`.tab-card[data-tab="${tabId}"]`).classList.add('active');
  }

  // =================================================================
  // 4. EVENT LISTENERS & INITIALIZATION
  // =================================================================
  window.addEventListener('load', () => {
    setTimeout(() => {
      splash.classList.add('hidden');
      const appElement = document.getElementById('app');
      appElement.setAttribute('aria-hidden', 'false');
      appElement.style.visibility = 'visible';
    }, 1500);
  });
  
  mainNav.addEventListener('click', (e) => {
    const navItem = e.target.closest('.nav-item[data-view]');
    if (navItem) {
        const currentActive = mainNav.querySelector('.nav-item.active');
        if (!currentActive || currentActive.dataset.view !== navItem.dataset.view) {
            renderView(navItem.dataset.view, {});
        }
    }
  });

  // *** إضافة: دالة لتنظيف جميع مستمعي Firestore ***
  function cleanupFirestoreListeners() {
    firestoreUnsubscribeFunctions.forEach(unsubscribe => unsubscribe());
    firestoreUnsubscribeFunctions = [];
  }

  // *** تعديل: ربط زر تسجيل الخروج بعد التأكد من وجوده ***
  document.getElementById('logoutBtn')?.addEventListener('click', async () => {
    try {
      await auth.signOut();
      showToast('تم تسجيل الخروج بنجاح.');
      // *** إصلاح: إعادة تحميل الصفحة لتنظيف الحالة وضمان عمل تسجيل الدخول مرة أخرى ***
      window.location.reload();
      // *** إضافة: تنظيف المستمعين عند تسجيل الخروج ***
      cleanupFirestoreListeners();
    } catch (error) {
        console.error("Logout Error:", error);
        showCustomToast('حدث خطأ أثناء تسجيل الخروج.', 'error');
    }
  });


  // Worker Modal Listeners
  workerForm.addEventListener('submit', handleWorkerFormSubmit);
  workerModal.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeWorkerModal();
      }
  });
  deleteWorkerBtn.addEventListener('click', () => {
      openConfirmModal('هل أنت متأكد من حذف هذا العامل؟<br>سيتم حذف جميع بياناته بشكل نهائي.', async () => {
          const id = parseInt(workerIdInput.value);
          await db.workers.delete(id);
          renderView('workers');
          closeWorkerModal();
          closeConfirmModal();
      });
  });

  // *** إضافة: معالجات أحداث نوافذ إدارة PIN ***
  document.getElementById('pinManagementModal').addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeModal('pinManagementModal');
      }
      // معالجة الأزرار داخل النافذة
      handlePinManagementClick(e);
  });
  document.getElementById('pinEditModal').addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeModal('pinEditModal');
      }
  });
  document.getElementById('pinEditForm').addEventListener('submit', handlePinEditFormSubmit);

  // Worker PIN Modal Listeners
  document.getElementById('workerPinForm').addEventListener('submit', handleWorkerPinSubmit);
  document.getElementById('workerPinModal').addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeWorkerPinModal();
      }
  });

  // Supplier Modal Listeners
  supplierForm.addEventListener('submit', handleSupplierFormSubmit);
  supplierModal.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeSupplierModal();
      }
  });
  deleteSupplierBtn.addEventListener('click', () => {
      openConfirmModal('هل أنت متأكد من حذف هذا المورد؟', async () => {
          const id = parseInt(supplierIdInput.value);
          await db.suppliers.delete(id);
          renderView('suppliers');
          closeSupplierModal();
          closeConfirmModal();
      });
  });

  document.getElementById('deleteProjectBtn')?.addEventListener('click', () => {
      openConfirmModal('هل أنت متأكد من حذف هذا المشروع؟ سيتم أيضاً حذف جميع النفقات المرتبطة به.', async () => {
          const id = parseInt(document.getElementById('projectId').value);
          await db.projects.delete(id);
          renderView('projects');
          closeProjectModal();
          closeConfirmModal();
      });
  });

  // *** إضافة: معالج حدث لزر إنهاء المشروع ***
  document.getElementById('finishProjectBtn')?.addEventListener('click', () => {
      const projectId = parseInt(document.getElementById('projectId').value);
      if (projectId) {
          openConfirmModal('هل أنت متأكد من إنهاء هذا المشروع؟', async () => {
              try {
                  await toggleProjectStatus(projectId, 'finished');
                  showToast('تم إنهاء المشروع بنجاح');
                  closeProjectModal();
                  closeConfirmModal();
                  // تحديث العرض مع الانتقال مباشرة إلى تبويب الملخص
                  renderView('project-details', { id: projectId, tab: 'summary' });
              } catch (error) {
                  showCustomToast('حدث خطأ أثناء إنهاء المشروع', 'error');
              }
          });
      }
  });

  // *** إصلاح: ربط الأحداث لنافذة المشروع المنبثقة (Modal) ***
  document.getElementById('projectModal')?.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeProjectModal();
      }
  });


  // Supplier Image Listeners
  supplierImageUploadBtn.addEventListener('click', () => supplierImageInput.click());
  supplierImagePlaceholder.addEventListener('click', () => supplierImageInput.click());
  supplierImagePreview.addEventListener('click', () => supplierImageInput.click());
  supplierImageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
          compressImage(file, 512, 0.75, (compressedDataUrl) => {
              supplierImageDataBase64.value = compressedDataUrl;
              supplierImagePreview.src = compressedDataUrl;
              showSupplierImagePreview(true);
          });
      }
  });
  supplierImageRemoveBtn.addEventListener('click', () => resetSupplierImagePreview());



  // Worker Image Listeners
  workerImageUploadBtn.addEventListener('click', () => workerImageInput.click());
  workerImagePlaceholder.addEventListener('click', () => workerImageInput.click());
  workerImagePreview.addEventListener('click', () => workerImageInput.click());

  workerImageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
          compressImage(file, 512, 0.75, (compressedDataUrl) => {
              workerImageDataBase64.value = compressedDataUrl;
              workerImagePreview.src = compressedDataUrl;
              showImagePreview(true);
          });
      }
  });

  workerImageRemoveBtn.addEventListener('click', () => resetImagePreview());

  /**
   * Compresses an image file using a canvas.
   * @param {File} file The image file to compress.
   * @param {number} maxSize The maximum width or height of the output image.
   * @param {number} quality A number between 0 and 1 indicating the image quality.
   * @param {function(string): void} callback The function to call with the compressed base64 data URL.
   */
  function compressImage(file, maxSize, quality, callback) {
      const reader = new FileReader();
      reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
              const canvas = document.createElement('canvas');
              let width = img.width;
              let height = img.height;

              if (width > height) {
                  if (width > maxSize) { height *= maxSize / width; width = maxSize; }
              } else {
                  if (height > maxSize) { width *= maxSize / height; height = maxSize; }
              }
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);
              callback(canvas.toDataURL('image/jpeg', quality));
          };
          img.src = event.target.result;
      };
      reader.readAsDataURL(file);
  }

  // Activity Modal Listeners
  activityForm.addEventListener('submit', handleActivityFormSubmit);
  activityModal.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeActivityModal();
      }
  });

  // Attendance Confirmation Modal Listeners
  const attendanceConfirmModal = document.getElementById('attendanceConfirmModal');
  document.getElementById('confirmPresentBtn').addEventListener('click', () => saveAttendance('present'));
  document.getElementById('confirmAbsentBtn').addEventListener('click', () => saveAttendance('absent'));
  attendanceConfirmModal.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeAttendanceConfirmModal();
      }
  });

  // Full Activity Log Modal Listeners
  const activityLogModal = document.getElementById('activityLogModal');
  activityLogModal.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeFullActivityLog();
      }
  });

  // Generic Confirm Modal Listeners
  confirmModalCancelBtn.addEventListener('click', closeConfirmModal);
  confirmModal.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeConfirmModal();
      }
  });
  confirmModalConfirmBtn.addEventListener('click', () => {
      if (typeof onConfirmCallback === 'function') {
          onConfirmCallback();
      }
  });

  // *** إضافة: ربط النافذة المنبثقة لجميع الدفعات ***
  document.getElementById('allPaymentsModal').addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeModal('allPaymentsModal');
      }
  });

  // *** إضافة: ربط النافذة المنبثقة لجميع النفقات ***
  document.getElementById('allExpensesModal').addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeAllExpensesModal();
      }
  });

  // *** إضافة: ربط النافذة المنبثقة للسجل المالي الكامل ***
  document.getElementById('projectFullFinanceModal').addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeModal('projectFullFinanceModal');
      }
  });


  // *** إصلاح: ربط الأحداث للنماذج المضافة ديناميكياً ***
  document.getElementById('projectPaymentForm').addEventListener('submit', handleProjectPaymentFormSubmit);
  document.getElementById('projectPaymentModal').addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) { closeProjectPaymentModal(); }
  });

  // AI Analysis Modal Listener
  document.getElementById('aiAnalysisModal').addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) { 
          closeModal('aiAnalysisModal');
      }
  });

  // Profile Modal Listeners
  // *** إصلاح: ربط الأحداث للنماذج المضافة ديناميكياً ***
  document.getElementById('profileForm')?.addEventListener('submit', handleProfileFormSubmit);
  document.getElementById('profileModal')?.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeProfileModal();
      }
  });
  document.getElementById('deleteProfileBtn')?.addEventListener('click', () => {
      openConfirmModal('هل أنت متأكد من حذف هذا الملف التعريفي؟', async () => {
          const id = parseInt(document.getElementById('profileId').value);
          if (id) {
              await db.companyProfiles.delete(id);
              renderView('my_info');
              closeProfileModal();
              closeConfirmModal();
          }
      });
  });
  document.getElementById('profileLogoUploadBtn')?.addEventListener('click', () => document.getElementById('profileLogoInput').click());
  document.getElementById('profileLogoPlaceholder')?.addEventListener('click', () => document.getElementById('profileLogoInput').click());
  document.getElementById('profileLogoPreview')?.addEventListener('click', () => document.getElementById('profileLogoInput').click());
  document.getElementById('profileLogoInput')?.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
          compressImage(file, 512, 0.8, (compressedDataUrl) => {
              document.getElementById('profileLogoDataBase64').value = compressedDataUrl;
              document.getElementById('profileLogoPreview').src = compressedDataUrl;
              showProfileLogoPreview(true);
          });
      }
  });
  document.getElementById('profileLogoRemoveBtn')?.addEventListener('click', () => resetProfileLogoPreview());

  function openProfileModal(profileId = null) {
      const form = document.getElementById('profileForm');
      form.reset();
      resetProfileLogoPreview();
      if (profileId) {
          const profile = state.companyProfiles.find(p => p.id === profileId);
          if (profile) {
              document.getElementById('profileModalTitle').textContent = 'تعديل الملف التعريفي';
              document.getElementById('profileId').value = profile.id;
              document.getElementById('profileName').value = profile.profileName;
              document.getElementById('ownerName').value = profile.ownerName;
              document.getElementById('profession').value = profile.profession;
              document.getElementById('profileCcp').value = profile.ccp;
              document.getElementById('profilePhone1').value = profile.phone1;
              document.getElementById('profilePhone2').value = profile.phone2;
              document.getElementById('profileRip').value = profile.rip;
              document.getElementById('profileAddress').value = profile.address;
              document.getElementById('privateNotes').value = profile.privateNotes;
              if (profile.logoUrl) {
                  document.getElementById('profileLogoDataBase64').value = profile.logoUrl;
                  document.getElementById('profileLogoPreview').src = profile.logoUrl;
                  showProfileLogoPreview(true);
              }
              document.getElementById('deleteProfileBtn').style.display = 'inline-block';
          }
      } else {
          document.getElementById('profileModalTitle').textContent = 'إضافة ملف تعريفي جديد';
          document.getElementById('profileId').value = '';
          document.getElementById('deleteProfileBtn').style.display = 'none';
      }
      openModal('profileModal');
  }

  // Note Modal Listeners
  noteForm.addEventListener('submit', handleNoteFormSubmit);
  noteModal.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeNoteModal();
      }
  });
  noteModal.querySelectorAll('.swatch').forEach(swatch => {
      swatch.addEventListener('click', () => {
          noteModal.querySelectorAll('.swatch').forEach(s => s.classList.remove('selected'));
          swatch.classList.add('selected');
          noteColorInput.value = swatch.dataset.color;
      });
  });
  deleteNoteBtn.addEventListener('click', () => {
      openConfirmModal('هل أنت متأكد من حذف هذه الملاحظة؟', async () => {
          const id = parseInt(noteIdInput.value);
          if (id) {
              await db.notes.delete(id);
              renderView('notes');
              closeNoteModal();
              closeConfirmModal();
          }
      });
  });
  // Note AI Helper Dropdown
  document.getElementById('noteAiHelperBtn').addEventListener('click', (e) => {
      const dropdown = document.getElementById('noteAiActionDropdown');
      dropdown.style.display = dropdown.style.display === 'none' ? 'flex' : 'none';
      e.stopPropagation();
  });
  document.getElementById('noteAiActionDropdown').addEventListener('click', (e) => {
      if (e.target.tagName === 'BUTTON') {
          handleNoteAiAction(e.target.dataset.action);
          document.getElementById('noteAiActionDropdown').style.display = 'none';
      }
  });
  document.body.addEventListener('click', () => {
      document.getElementById('noteAiActionDropdown').style.display = 'none';
  });

  // Inventory Modal Listeners
  inventoryForm.addEventListener('submit', handleInventoryFormSubmit);
  inventoryModal.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeInventoryModal();
      }
  });
  deleteInventoryBtn.addEventListener('click', () => {
      openConfirmModal('هل أنت متأكد من حذف هذه الأداة؟', async () => {
          const id = parseInt(inventoryIdInput.value);
          if (id) {
              await db.inventory.delete(id);
              renderView('inventory');
              closeInventoryModal();
              closeConfirmModal();
          }
      });
  });
  inventoryImageUploadBtn.addEventListener('click', () => inventoryImageInput.click());
  inventoryImagePlaceholder.addEventListener('click', () => inventoryImageInput.click());
  inventoryImagePreview.addEventListener('click', () => inventoryImageInput.click());
  inventoryImageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
          compressImage(file, 512, 0.75, (compressedDataUrl) => {
              inventoryImageDataBase64.value = compressedDataUrl;
              inventoryImagePreview.src = compressedDataUrl;
              showInventoryImagePreview(true);
          });
      }
  });
  inventoryImageRemoveBtn.addEventListener('click', () => resetInventoryImagePreview());

  // Calendar Event Modal Listeners
  eventForm.addEventListener('submit', handleEventFormSubmit);
  eventModal.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeEventModal();
      }
  });
  deleteEventBtn.addEventListener('click', () => {
      // This button can be clicked from two places, so we check both possible sources for the ID
      const id = parseInt(eventIdInput.value) || parseInt(deleteEventBtn.dataset.id);
      if (id) {
          openConfirmModal('هل أنت متأكد من حذف هذا الحدث؟', async () => {
              await db.calendarEvents.delete(id);
              renderView('calendar');
              closeEventModal();
              closeEventDetailsModal();
              closeConfirmModal();
          });
      }
  });

    // Task Modal Listeners (ensure task form doesn't trigger full page reload)
    const taskModal = document.getElementById('taskModal');
    const taskForm = document.getElementById('taskForm');
    const deleteTaskBtn = document.getElementById('deleteTaskBtn');

    if (taskForm) {
        taskForm.addEventListener('submit', handleTaskFormSubmit);
    }
    if (taskModal) {
        taskModal.addEventListener('click', (e) => {
            if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
                closeTaskModal();
            }
        });
    }
    if (deleteTaskBtn) {
        deleteTaskBtn.addEventListener('click', () => {
            const id = parseInt(document.getElementById('taskId').value) || parseInt(deleteTaskBtn.dataset.id);
            if (id) {
                openConfirmModal('هل أنت متأكد من حذف هذه المهمة؟', async () => {
                    await db.projectTasks.delete(id);
                    const projectId = parseInt(document.getElementById('taskProjectId').value);
                    renderView('project-details', { id: projectId, tab: 'tasks' });
                    closeTaskModal();
                    closeConfirmModal();
                });
            }
        });
    }

  // Event Details Modal Listeners
  eventDetailsModal.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeEventDetailsModal();
      }
  });
  deleteEventDetailsBtn.addEventListener('click', () => {
      openConfirmModal('هل أنت متأكد من حذف هذا الحدث؟', async () => {
          const id = parseInt(deleteEventBtn.dataset.id);
          if (id) {
              await db.calendarEvents.delete(id);
              renderView('calendar');
              closeEventDetailsModal();
              closeConfirmModal();
          }
      });
  });

  // Expense Modal Listeners
  // *** إصلاح: ربط الأحداث للنماذج المضافة ديناميكياً ***
  document.getElementById('expenseForm')?.addEventListener('submit', handleExpenseFormSubmit);
  document.getElementById('expenseModal')?.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeExpenseModal();
      }
  });
  document.getElementById('deleteExpenseBtn')?.addEventListener('click', () => {
      openConfirmModal('هل أنت متأكد من حذف هذه النفقة؟', async () => {
          const id = parseInt(document.getElementById('expenseId').value);
          if (id) {
              await db.expenses.delete(id);
              // *** تحسين: العودة إلى العرض السابق بدلاً من عرض النفقات دائماً ***
              renderView(state.currentView.name, state.currentView.params);
              closeExpenseModal();
              closeConfirmModal();
          }
      });
  });
  document.getElementById('expenseImageUploadBtn')?.addEventListener('click', () => document.getElementById('expenseImageInput').click());
  document.getElementById('expenseImagePlaceholder')?.addEventListener('click', () => document.getElementById('expenseImageInput').click());
  document.getElementById('expenseImagePreview')?.addEventListener('click', () => document.getElementById('expenseImageInput').click());
  document.getElementById('expenseImageInput')?.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
          compressImage(file, 800, 0.8, (compressedDataUrl) => {
              document.getElementById('expenseImageDataBase64').value = compressedDataUrl;
              document.getElementById('expenseImagePreview').src = compressedDataUrl;
              showExpenseImagePreview(true);
          });
      }
  });
  document.getElementById('expenseImageRemoveBtn')?.addEventListener('click', () => resetExpenseImagePreview());

  function closeProfileModal() {
      closeModal('profileModal');
  }

  function resetProfileLogoPreview() {
      document.getElementById('profileLogoDataBase64').value = '';
      document.getElementById('profileLogoInput').value = '';
      document.getElementById('profileLogoPreview').src = '';
      document.getElementById('profileLogoPreview').style.display = 'none';
      document.getElementById('profileLogoPlaceholder').style.display = 'flex';
      document.getElementById('profileLogoRemoveBtn').style.display = 'none';
  }

  function showProfileLogoPreview(show) {
      document.getElementById('profileLogoPreview').style.display = show ? 'block' : 'none';
      document.getElementById('profileLogoPlaceholder').style.display = show ? 'none' : 'flex';
      document.getElementById('profileLogoRemoveBtn').style.display = show ? 'inline-block' : 'none';
  }

  async function handleProfileFormSubmit(e) {
      e.preventDefault();
      const id = document.getElementById('profileId').value ? parseInt(document.getElementById('profileId').value) : null;
      const profileData = {
          profileName: document.getElementById('profileName').value,
          ownerName: document.getElementById('ownerName').value,
          profession: document.getElementById('profession').value,
          ccp: document.getElementById('profileCcp').value,
          phone1: document.getElementById('profilePhone1').value,
          phone2: document.getElementById('profilePhone2').value,
          rip: document.getElementById('profileRip').value,
          address: document.getElementById('profileAddress').value,
          privateNotes: document.getElementById('privateNotes').value,
          logoUrl: document.getElementById('profileLogoDataBase64').value,
      };

      if (id) {
          await db.companyProfiles.update(id, profileData);
      } else {
          await db.companyProfiles.add(profileData);
      }
      renderView('my_info');
      closeProfileModal();
  }

  // API Config Modal Listeners
  // *** إصلاح: ربط الأحداث للنماذج المضافة ديناميكياً ***
  document.getElementById('apiConfigForm')?.addEventListener('submit', handleApiConfigFormSubmit);
  document.getElementById('apiConfigModal')?.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeApiConfigModal();
      }
  });
  document.getElementById('apiConfigProvider')?.addEventListener('change', populateApiModels);


  async function toggleActiveApi(apiId, forceActivate = false) {
      let isActivating = forceActivate;
      if (!forceActivate) {
          const checkbox = document.querySelector(`[data-action="toggle-api-active"][data-id="${apiId}"]`);
          if (checkbox) {
              isActivating = checkbox.checked;
          }
      }

      if (isActivating) {
          await db.app_settings.put({ key: 'active_api_id', value: apiId });
          state.active_api_id = apiId;
      } else if (state.active_api_id === apiId) {
          await db.app_settings.delete('active_api_id');
          state.active_api_id = null;
      }
      renderView('api_settings');
  }

  async function deleteApiConfig(apiId) {
      openConfirmModal('هل أنت متأكد من حذف إعداد الـ API هذا؟', async () => {
          await db.api_configs.delete(apiId);
          if (state.active_api_id === apiId) {
              await db.app_settings.delete('active_api_id');
              state.active_api_id = null;
          }
          closeConfirmModal();
          renderView('api_settings');
      });
  }

  const availableModels = {
      openrouter: [
          { id: 'openai/gpt-3.5-turbo', name: 'ChatGPT 3.5 Turbo' }
      ]
  };

  function populateApiModels() {
      const provider = document.getElementById('apiConfigProvider').value;
      const modelSelect = document.getElementById('apiConfigModel');
      const models = availableModels[provider] || [];
      modelSelect.innerHTML = models.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
  }

  async function handleApiConfigFormSubmit(e) {
      e.preventDefault();
      const provider = document.getElementById('apiConfigProvider').value;
      const modelId = document.getElementById('apiConfigModel').value;
      const apiKey = document.getElementById('apiConfigKey').value;

      if (!apiKey) {
          showCustomToast('الرجاء إدخال مفتاح API.', 'error');
          return;
      }
      if (!modelId) {
          showCustomToast('الرجاء اختيار نموذج.', 'error');
          return;
      }

      const providerModels = availableModels[provider] || [];
      const selectedModel = providerModels.find(m => m.id === modelId);
      if (!selectedModel) {
          showCustomToast('نموذج غير صالح.', 'error');
          return;
      }

      // Create a descriptive name
      const configName = provider === 'gemini' ? 'Google Gemini' : `OpenRouter: ${selectedModel.name}`;

      const configData = {
          name: configName,
          provider: provider,
          apiKey: apiKey,
          model: modelId,
      };

      const newId = await db.api_configs.add(configData);

      if (!state.active_api_id) {
          await toggleActiveApi(newId, true); // Activate it and re-render
      }

      showToast('تم حفظ الإعداد بنجاح!');
      renderView('api_settings');
      closeApiConfigModal();
  }

  function openApiConfigModal() {
      const form = document.getElementById('apiConfigForm');
      form.reset();
      populateApiModels(); // Populate models for the default provider
      openModal('apiConfigModal');
  }

  function closeApiConfigModal() {
      closeModal('apiConfigModal');
  }

  // =================================================================
  // 5. AI ASSISTANT LOGIC
  // =================================================================

  /**
   * Gathers and formats the current application state for the AI context.
   * @returns {string} A formatted string containing the app context.
   */
  function getAppContextForAI() {
      // Create detailed summaries for the AI.
      const workersDetails = state.workers.map(worker => {
        const { totalDue, totalPaid } = calculateWorkerFinancials(worker);
        const allActivities = [
            ...(worker.attendance || []).map(a => ({ type: a.status, date: a.date, amount: a.dailyRate })),
            ...(worker.payments || []).map(p => ({ type: 'payment', date: p.date, amount: p.amount, note: p.note })),
            ...(worker.bonuses || []).map(b => ({ type: 'bonus', date: b.date, amount: b.amount, note: b.note }))
        ].sort((a, b) => new Date(b.date) - new Date(a.date));

        return {
            name: worker.name,
            dailyRate: worker.dailyRate,
            balance: totalDue - totalPaid,
            activities: allActivities.slice(0, 15) // Limit to last 15 activities to keep context size reasonable
        };
      });

      const inventoryDetails = state.inventory.map(item => {
        let details = {
            name: item.name,
            status: item.status,
            quantity: item.quantity,
        };
        if (item.status === 'in_use') {
            details.borrower = item.borrowerName;
            details.borrowDate = item.borrowDate;
        }
        return details;
      });

      const expensesDetails = state.expenses.map(e => ({
        description: e.description,
        amount: e.amount,
        date: e.date
      }));

      // Include payment info from "My Info"
      const profilesInfo = state.companyProfiles.map(p => ({
          profileName: p.profileName,
          paymentInfo: { ccp: p.ccp, rip: p.rip, phone: p.phone1 }
      }));
      
      const contextData = {
          currentDate: new Date().toISOString().split('T')[0],
          workers: workersDetails,
          inventory: inventoryDetails,
          expenses: expensesDetails,
          myPaymentProfiles: profilesInfo
      };

      const systemPrompt = `أنت مساعد ذكاء اصطناعي في تطبيق "مدير الديكور". لديك الوصول إلى البيانات الحالية للتطبيق بصيغة JSON. استخدم هذه البيانات للإجابة على أسئلة المستخدم المتعلقة بأعماله. كن موجزاً ومباشراً في إجاباتك.\n\nبيانات التطبيق الحالية:\n${JSON.stringify(contextData, null, 2)}`;

      return systemPrompt;
  }

  // *** إضافة: دالة لفتح نافذة مساعد الذكاء الاصطناعي ***
  function openAiAssistantModal() {
      if (!state.active_api_id) {
          showCustomToast('مساعد الذكاء الاصطناعي غير نشط. يرجى تفعيل مفتاح API من الإعدادات.', 'error');
          renderView('api_settings');
          return;
      }

      openModal('aiAssistantModal');
      const history = document.getElementById('aiChatHistory');
      const input = document.getElementById('aiPromptInput');
      const sendBtn = document.getElementById('sendAiPromptBtn');

      // إعادة تعيين المحتوى عند الفتح
      const welcomeMessage = "مرحباً! أنا مساعدك الذكي. كيف يمكنني مساعدتك اليوم؟";
      history.innerHTML = `<div class="ai-chat-bubble model"><p>${welcomeMessage}</p></div>`;
      input.value = '';
      sendBtn.disabled = true;

      // إزالة أي مستمعين قدامى لتجنب التكرار
      const newSendBtn = sendBtn.cloneNode(true);
      sendBtn.parentNode.replaceChild(newSendBtn, sendBtn);
      const newInput = input.cloneNode(true);
      input.parentNode.replaceChild(newInput, input);

      // إضافة مستمعين جدد
      newInput.addEventListener('input', () => { newSendBtn.disabled = newInput.value.trim() === ''; });
      newSendBtn.addEventListener('click', handleSendAiPrompt);
      newInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              if (!newSendBtn.disabled) handleSendAiPrompt();
          }
      });
      newInput.focus();
  }

  async function handleAnalysisRequest(type, id) {
      const modal = document.getElementById('aiAnalysisModal');
      const modalBody = document.getElementById('aiAnalysisModalBody');
      const modalTitle = document.getElementById('aiAnalysisModalTitle');

      openModal('aiAnalysisModal');
      modalBody.innerHTML = `<div style="display:flex; justify-content:center; align-items:center; height:100%;"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`;

      let itemData, prompt;

      try {
          switch (type) {
              // *** إضافة: حالة جديدة لتحليل بيانات المشروع ***
              case 'project':
                const project = state.projects.find(p => p.id === id);
                if (!project) throw new Error('لم يتم العثور على المشروع.');

                // جمع البيانات المالية للمشروع
                const clientPayments = state.projectPayments.filter(p => p.projectId === id);
                const totalReceived = clientPayments.reduce((sum, p) => sum + p.amount, 0);
                const projectExpenses = state.expenses.filter(e => e.projectId === id);
                const totalPaidExpenses = projectExpenses.filter(e => e.paymentStatus === 'paid').reduce((sum, e) => sum + e.amount, 0);
                const netBalance = totalReceived - totalPaidExpenses;

                itemData = {
                    name: project.name,
                    budget: project.budget,
                    totalReceived: totalReceived,
                    totalPaidExpenses: totalPaidExpenses,
                    netBalance: netBalance
                };
                modalTitle.textContent = `تحليل المشروع: ${project.name}`;
                prompt = `بصفتك مستشاراً مالياً، حلل بيانات المشروع التالية وقدم ملخصاً واضحاً للحالة المالية، مع تحديد أي مخاطر (مثل تجاوز الميزانية) وتقديم توصية عملية واحدة. البيانات: ${JSON.stringify(itemData, null, 2)}`;
                break;
              case 'worker':
                const worker = state.workers.find(w => w.id === id);
                if (!worker) throw new Error('لم يتم العثور على العامل.');
                
                // Create a clean data object for the AI, not HTML
                const { totalDue, totalPaid } = calculateWorkerFinancials(worker);
                const activitiesSummary = generateActivityLog(worker, 10, null, null, 'text'); // Get text summary

                itemData = { 
                    name: worker.name, 
                    balance: totalDue - totalPaid,
                    recent_activities_summary: activitiesSummary
                };
                modalTitle.textContent = `تحليل العامل: ${worker.name}`;
                prompt = `حلل بيانات العامل التالية وقدم ملخصاً عن أدائه المالي والتزامه مع توصية قصيرة. البيانات: ${JSON.stringify(itemData, null, 2)}`;
                break;
              case 'supplier':
                  const supplier = state.suppliers.find(s => s.id === id);
                  if (!supplier) throw new Error('لم يتم العثور على المورد.');
                  itemData = { ...supplier }; // Create a copy
                  delete itemData.imageUrl; // Remove image data before sending
                  modalTitle.textContent = `تحليل المورد: ${supplier.name}`;
                  prompt = `حلل بيانات المورد التالية وقدم ملخصاً عنه مع اقتراح للتعامل معه بناءً على تخصصه. البيانات: ${JSON.stringify(itemData, null, 2)}`;
                  break;
              case 'inventory':
                  const item = state.inventory.find(i => i.id === id);
                  if (!item) throw new Error('لم يتم العثور على الأداة.');
                  itemData = { ...item }; // Create a copy
                  delete itemData.imageUrl; // Remove image data before sending
                  modalTitle.textContent = `تحليل الأداة: ${item.name}`;
                  prompt = `حلل بيانات الأداة التالية وقدم ملخصاً لحالتها الحالية مع توصية للصيانة أو المتابعة. إذا كانت مُعارة، اذكر لمن وتاريخ الإعارة. البيانات: ${JSON.stringify(itemData, null, 2)}`;
                  break;
              case 'profile':
                  const profile = state.companyProfiles.find(p => p.id === id);
                  if (!profile) throw new Error('لم يتم العثور على الملف التعريفي.');
                  itemData = { ...profile }; // Create a copy
                  delete itemData.logoUrl; // Remove image data before sending
                  modalTitle.textContent = `تحليل الملف: ${profile.profileName}`;
                  prompt = `حلل بيانات الدفع التالية ولخصها مع ذكر أي معلومات قد تكون ناقصة ومهمة. البيانات: ${JSON.stringify(itemData, null, 2)}`;
                  break;
              case 'expense':
                  const expense = state.expenses.find(e => e.id === id);
                  if (!expense) throw new Error('لم يتم العثور على النفقة.');
                  itemData = { ...expense }; // Create a copy
                  delete itemData.receiptUrl; // Remove image data before sending
                  modalTitle.textContent = `تحليل النفقة: ${expense.description}`;
                  prompt = `حلل بيانات النفقة التالية وقدم ملخصاً لها، مع ذكر المبلغ والتاريخ وأي مشروع أو عامل مرتبط بها. البيانات: ${JSON.stringify(itemData, null, 2)}`;
                  break;
              case 'event':
                  const event = state.calendarEvents.find(e => e.id === id);
                  if (!event) throw new Error('لم يتم العثور على الحدث.');
                  itemData = event;
                  modalTitle.textContent = `تحليل الحدث: ${event.title}`;
                  prompt = `حلل بيانات الحدث التالي في الجدول الزمني وقدم ملخصاً له مع توصية قصيرة للاستعداد. البيانات: ${JSON.stringify(itemData, null, 2)}`;
                  break;
              case 'note':
                  const note = state.notes.find(n => n.id === id);
                  if (!note) throw new Error('لم يتم العثور على الملاحظة.');
                  itemData = { title: note.title, content: note.content };
                  modalTitle.textContent = `تحليل الملاحظة`;
                  prompt = `بصفتك مساعداً ذكياً، قم بتحليل الملاحظة التالية. لخصها، استخرج أي معلومات مهمة (مثل مقاسات، مهام، أرقام هواتف)، واقترح عنواناً أفضل إن أمكن. الملاحظة: ${JSON.stringify(itemData, null, 2)}.`;
                  break;
              case 'debt':
                  const debt = state.debts.find(d => d.id === id);
                  if (!debt) throw new Error('لم يتم العثور على الدين.');
                  itemData = { person: debt.person, amount: debt.amount, remaining: debt.remaining, dueDate: debt.dueDate, notes: debt.notes };
                  modalTitle.textContent = `تحليل دين: ${debt.person}`;
                  prompt = `بصفتك مستشاراً مالياً، حلل بيانات الدين التالية. قدم ملخصاً للحالة، وقيم مدى خطورة التأخير (إن وجد)، واقترح إجراءً واحداً واضحاً للتعامل مع هذا الدين. البيانات: ${JSON.stringify(itemData, null, 2)}`;
                  break;
              default:
                  throw new Error('نوع التحليل غير معروف.');
          }

          // We send a single-turn request for this, no need for full history
          const historyForAnalysis = [{ role: 'user', content: prompt }];
          const responseText = await callAI(historyForAnalysis);

          if (!responseText) {
              modalBody.innerHTML = `<p>عذراً، لم يتم تلقي رد من المساعد.</p>`;
          } else {
              modalBody.innerHTML = marked.parse(responseText);
          }

      } catch (error) {
          modalBody.innerHTML = `
              <p style="color: #ef4444;">حدث خطأ أثناء طلب التحليل.</p>
              <p style="font-size: 13px; color: var(--muted); direction: ltr; text-align: right; white-space: pre-wrap;">${error.message}</p> 
              <button onclick="handleApiErrorNavigation()" class="btn ghost" style="margin-top: 12px;">التحقق من إعدادات الـ API</button>
          `;
      }
  }


  /**
   * *** إضافة: دالة جديدة لمعالجة التنقل عند خطأ الـ API ***
   * تغلق النافذة المنبثقة الحالية ثم تنتقل إلى صفحة إعدادات الـ API.
   */
  function handleApiErrorNavigation() {
    closeModal('aiAnalysisModal');
    renderView('api_settings');
  }


  async function handleSendAiPrompt() {
      const input = document.getElementById('aiPromptInput');
      const history = document.getElementById('aiChatHistory');
      const sendBtn = document.getElementById('sendAiPromptBtn');

      const prompt = input.value.trim();
      if (!prompt) return;

      input.value = '';
      input.disabled = true;
      sendBtn.disabled = true;

      // Add user message to UI and state
      const userBubble = document.createElement('div');
      userBubble.className = 'ai-chat-bubble user';
      userBubble.textContent = prompt;
      history.appendChild(userBubble);
      
      // Add user message to the history that will be sent to the AI
      state.aiChatHistory.push({ role: 'user', content: prompt });

      history.scrollTop = history.scrollHeight;

      const typingBubble = document.createElement('div');
      typingBubble.className = 'ai-chat-bubble model';
      typingBubble.innerHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div>`;
      history.appendChild(typingBubble);
      history.scrollTop = history.scrollHeight;

      try {
          // 1. Get the app context
          const appContextPrompt = getAppContextForAI();

          // 2. Create the full history with the system prompt at the beginning
          const historyWithContext = [
              { role: 'user', content: appContextPrompt }, // The system prompt is framed as a user message for simplicity with some APIs
              ...state.aiChatHistory.slice(-1) // Get the last user message
          ];
          const responseText = await callAI(historyWithContext);
          if (!responseText) {
              typingBubble.innerHTML = `عذراً، لم يتم تلقي رد من المساعد. يرجى المحاولة مرة أخرى لاحقاً.`;
          } else {
              typingBubble.innerHTML = marked.parse(responseText);
              state.aiChatHistory.push({ role: 'model', content: responseText });
          }
      } catch (error) {
          typingBubble.innerHTML = `عذراً، حدث خطأ أثناء الاتصال بالمساعد. يرجى التحقق من إعدادات الـ API أو المحاولة لاحقاً. <br><small style="color: var(--muted);">${error.message}</small>`;
      } finally {
          input.disabled = false;
          input.focus();
          history.scrollTop = history.scrollHeight;
      }
  }

  async function callAI(chatHistory) {
      if (!state.active_api_id) throw new Error("لا يوجد مفتاح API نشط.");

      const config = state.api_configs.find(c => c.id === state.active_api_id);
      if (!config) throw new Error("لم يتم العثور على إعدادات الـ API النشطة.");

      // Map our history to the format the API expects.
      const messages = chatHistory.map(msg => ({
          role: msg.role === 'model' ? 'assistant' : msg.role,
          content: msg.content
      }));

      if (config.provider !== 'openrouter') {
          throw new Error(`مزود الخدمة '${config.provider}' غير مدعوم.`);
      }

      const url = 'https://openrouter.ai/api/v1/chat/completions';
      const options = {
          method: 'POST',
          headers: {
              'Authorization': `Bearer ${config.apiKey}`,
              'Content-Type': 'application/json',
              'HTTP-Referer': 'https://my-decor-manager.app', // Example referrer
              'X-Title': 'My Decor Manager',
          },
          body: JSON.stringify({ model: config.model, messages: messages })
      };

      try {
          const response = await fetch(url, options);

          if (!response.ok) {
              let errorDetails = `Status: ${response.status} ${response.statusText}`;
              let isCreditError = false;
              try {
                  const errorData = await response.json();
                  if (errorData.error && errorData.error.message) {
                      errorDetails = errorData.error.message;
                      // *** إضافة: التحقق من خطأ الرصيد ***
                      if (errorDetails.includes('Insufficient credits')) {
                          isCreditError = true;
                      }
                  }
              } catch (e) {
                  // Could not parse JSON, stick with the status text
              }
              // *** تعديل: إرسال رسالة خطأ مخصصة لمشكلة الرصيد ***
              const errorMessage = isCreditError ? 'رصيدك غير كافٍ في OpenRouter. يرجى شحن حسابك.' : `فشل طلب الـ API:\n${errorDetails}`;
              throw new Error(errorMessage);
          }

          const data = await response.json();
          const content = data.choices?.[0]?.message?.content;
          
          if (!content) throw new Error("لم يتم العثور على محتوى في رد الـ API.");

          return content;
      } catch (error) {
          // Re-throw network errors or errors from the !response.ok block
          throw error;
      }
  }

  async function handleNoteAiAction(action) {
      const noteContentInput = document.getElementById('noteContent');
      const noteTitleInput = document.getElementById('noteTitle');
      const text = noteContentInput.value;
      const helperBtn = document.getElementById('noteAiHelperBtn');

      if (!text) {
          showCustomToast('لا يوجد محتوى لمعالجته.', 'error');
          return;
      }

      let prompt;
      switch (action) {
          case 'summarize':
              prompt = `لخص النص التالي في بضع نقاط رئيسية:\n\n${text}`;
              break;
          case 'rephrase':
              prompt = `أعد صياغة النص التالي بأسلوب أكثر وضوحاً واحترافية:\n\n${text}`;
              break;
          case 'suggest_title':
              prompt = `اقترح عنواناً قصيراً ومناسباً للملاحظة التالية:\n\n${text}`;
              break;
          default: return;
      }

      const originalBtnContent = helperBtn.innerHTML;
      helperBtn.innerHTML = `<div class="typing-indicator" style="padding: 0 10px;"><span></span><span></span><span></span></div>`;
      helperBtn.disabled = true;

      try {
          const historyForAction = [{ role: 'user', content: prompt }];
          const responseText = await callAI(historyForAction);

          if (responseText) {
              if (action === 'suggest_title') {
                  noteTitleInput.value = responseText.replace(/["']/g, ''); // Remove quotes
              } else {
                  noteContentInput.value = responseText;
              }
          }
      } catch (error) {
          showCustomToast(error.message, 'error');
      } finally {
          helperBtn.innerHTML = originalBtnContent;
          helperBtn.disabled = false;
      }
  }
  // =================================================================
  // 10. SEARCH FUNCTIONALITY
  // =================================================================
  
  function openSearchModal() {
      openModal('searchModal');
      document.getElementById('searchInput').focus();
  }

  function performSearch(query) {
      const container = document.getElementById('searchResultsContainer');
      if (!query) {
          container.innerHTML = `
              <div style="text-align: center; padding: 40px 20px; color: var(--muted);">
                  <i class="fas fa-search" style="font-size: 32px; margin-bottom: 12px;"></i>
                  <p>ابدأ الكتابة للبحث في التطبيق.</p>
              </div>`;
          return;
      }

      const results = {
          projects: state.projects.filter(p => p.name?.toLowerCase().includes(query)),
          workers: state.workers.filter(w => w.name?.toLowerCase().includes(query)),
          expenses: state.expenses.filter(e => e.description?.toLowerCase().includes(query)),
          notes: state.notes.filter(n => (n.title && n.title.toLowerCase().includes(query)) || (n.content && n.content.toLowerCase().includes(query))),
          suppliers: state.suppliers.filter(s => s.name?.toLowerCase().includes(query)),
          inventory: state.inventory.filter(i => i.name?.toLowerCase().includes(query)),
          debts: state.debts.filter(d => d.person?.toLowerCase().includes(query) || d.notes?.toLowerCase().includes(query)),
          calendarEvents: state.calendarEvents.filter(e => e.title?.toLowerCase().includes(query)),
          companyProfiles: state.companyProfiles.filter(p => p.profileName?.toLowerCase().includes(query) || p.ownerName?.toLowerCase().includes(query)),
      };

      let html = '';

      if (results.projects.length) {
          html += '<div class="search-results-group"><h4>المشاريع</h4>';
          html += results.projects.map(p => `
              <div class="search-result-item" data-type="project" data-id="${p.id}">
                  <i class="fas fa-hard-hat" style="color: var(--muted);"></i>
                  <span>${p.name}</span>
              </div>
          `).join('');
          html += '</div>';
      }
      if (results.workers.length) {
          html += '<div class="search-results-group"><h4>العمال</h4>';
          html += results.workers.map(w => `
              <div class="search-result-item" data-type="worker" data-id="${w.id}">
                  <i class="fas fa-user" style="color: var(--muted);"></i>
                  <span>${w.name}</span>
              </div>
          `).join('');
          html += '</div>';
      }
      if (results.expenses.length) {
          html += '<div class="search-results-group"><h4>النفقات</h4>';
          html += results.expenses.map(e => `
              <div class="search-result-item" data-type="expense" data-id="${e.id}">
                  <i class="fas fa-wallet" style="color: var(--muted);"></i>
                  <span>${e.description}</span>
              </div>
          `).join('');
          html += '</div>';
      }
      if (results.notes.length) {
          html += '<div class="search-results-group"><h4>الملاحظات</h4>';
          html += results.notes.map(n => `
              <div class="search-result-item" data-type="note" data-id="${n.id}">
                  <i class="fas fa-sticky-note" style="color: var(--muted);"></i>
                  <span>${n.title || 'ملاحظة بدون عنوان'}</span>
              </div>
          `).join('');
          html += '</div>';
      }
      if (results.suppliers.length) {
          html += '<div class="search-results-group"><h4>الموردين</h4>';
          html += results.suppliers.map(s => `
              <div class="search-result-item" data-type="supplier" data-id="${s.id}">
                  <i class="fas fa-truck" style="color: var(--muted);"></i>
                  <span>${s.name}</span>
              </div>
          `).join('');
          html += '</div>';
      }
      if (results.inventory.length) {
          html += '<div class="search-results-group"><h4>المخزون</h4>';
          html += results.inventory.map(i => `
              <div class="search-result-item" data-type="inventory" data-id="${i.id}">
                  <i class="fas fa-toolbox" style="color: var(--muted);"></i>
                  <span>${i.name}</span>
              </div>
          `).join('');
          html += '</div>';
      }
      if (results.debts.length) {
          html += '<div class="search-results-group"><h4>الديون</h4>';
          html += results.debts.map(d => `
              <div class="search-result-item" data-type="debt" data-id="${d.id}">
                  <i class="fas fa-book-reader" style="color: var(--muted);"></i>
                  <span>دين على: ${d.person}</span>
              </div>
          `).join('');
          html += '</div>';
      }
      if (results.calendarEvents.length) {
          html += '<div class="search-results-group"><h4>الجدول الزمني</h4>';
          html += results.calendarEvents.map(e => `
              <div class="search-result-item" data-type="calendarEvent" data-id="${e.id}">
                  <i class="fas fa-calendar-alt" style="color: var(--muted);"></i>
                  <span>${e.title}</span>
              </div>
          `).join('');
          html += '</div>';
      }
      if (results.companyProfiles.length) {
          html += '<div class="search-results-group"><h4>الملفات التعريفية</h4>';
          html += results.companyProfiles.map(p => `
              <div class="search-result-item" data-type="profile" data-id="${p.id}">
                  <i class="fas fa-id-card" style="color: var(--muted);"></i>
                  <span>${p.profileName}</span>
              </div>
          `).join('');
          html += '</div>';
      }

      container.innerHTML = html || `<div style="text-align: center; padding: 40px 20px; color: var(--muted);"><p>لا توجد نتائج للبحث عن "${query}"</p></div>`;
  }

  // First-time setup
  // *** تحسين: دالة لتهيئة جميع معالجات الأحداث مرة واحدة ***
  function openReportReviewModal(reportId) {
    const report = state.reports.find(r => r.firestoreId === reportId);
    if (!report) return;

    const contentEl = document.getElementById('reportReviewContent');
    const form = document.getElementById('reportReviewForm');
    
    form.reset();
    document.getElementById('reviewReportId').value = reportId;

    const statusStyles = {
        pending: { text: 'قيد المراجعة', color: '#f59e0b' },
        approved: { text: 'تمت الموافقة', color: '#10b981' },
        rejected: { text: 'مرفوض', color: '#ef4444' }
    };
    const status = statusStyles[report.status] || { text: report.status, color: '#64748b' };

    // *** إضافة: تنسيق عرض التاريخ بناءً على نوع البلاغ ***
    let dateDisplayHTML;
    if (report.type === 'طلب إجازة' && report.startDate && report.endDate) {
        dateDisplayHTML = `
            <div style="font-size:14px; color:var(--muted);">فترة الإجازة</div>
            <div style="font-weight:700; font-size:16px; margin-top: 4px; display: flex; align-items: center; gap: 10px;">
                <span>من: ${new Date(report.startDate).toLocaleDateString('ar-DZ', { dateStyle: 'long' })}</span>
                <i class="fas fa-arrow-left" style="font-size: 12px;"></i>
                <span>إلى: ${new Date(report.endDate).toLocaleDateString('ar-DZ', { dateStyle: 'long' })}</span>
            </div>`;
    } else {
        dateDisplayHTML = `<div style="font-size:14px; color:var(--muted);">تاريخ البلاغ</div><div style="font-weight:700; font-size:16px; margin-top: 4px;">${new Date(normalizeTimestamp(report.date)).toLocaleDateString('ar-DZ', { dateStyle: 'long' })}</div>`;
    }

    contentEl.innerHTML = `
        <div style="margin-bottom: 12px;">
            <div style="font-size:14px; color:var(--muted);">العامل</div>
            <div style="font-weight:700; font-size:18px; margin-top: 4px;">${report.workerName || 'غير معروف'}</div>
        </div>
        <div style="margin-bottom: 12px;">
            ${dateDisplayHTML}
        </div>
        <div style="margin-bottom: 12px;">
            <div style="font-size:14px; color:var(--muted);">الحالة</div>
            <div class="status-badge" style="background-color: ${status.color}; display: inline-block; margin-top: 4px;">${status.text}</div>
        </div>
        <div style="background: var(--bg); padding: 12px; border-radius: 8px; margin-top: 16px;">
            <div style="font-size:13px; color:var(--muted);">محتوى البلاغ</div>
            <div style="font-weight:500; font-size:15px; margin-top: 4px; white-space: pre-wrap;">${report.note}</div>
        </div>
    `;

    openModal('reportReviewModal');
}

async function handleReportReview(status) {
    const reportId = document.getElementById('reviewReportId').value;
    const adminNote = document.getElementById('adminNote').value;
    const user = auth.currentUser;

    if (!reportId || !user) return;

    try {
        // الخطوة 1: إذا كانت الحالة "موافقة"، قم بتحديث سجل الحضور
        if (status === 'approved') {
            const reportRef = firestore.collection('reports').doc(reportId);
            const reportDoc = await reportRef.get();

            if (reportDoc.exists) {
                const reportData = reportDoc.data();
                // *** إصلاح: البحث عن العامل باستخدام `id` بدلاً من `uid` ***
                // `reportData.workerId` هو `uid` العامل، والذي يجب أن يتطابق مع `id` العامل في تطبيق المدير
                const workerIdToFind = parseInt(reportData.workerId);
                const workerToUpdate = state.workers.find(w => w.id === workerIdToFind);

                if (workerToUpdate) {
                    if (!workerToUpdate.attendance) workerToUpdate.attendance = [];

                    // دالة مساعدة لإضافة يوم غياب مع التحقق من عدم التكرار
                    const addAbsentDay = (dateStr) => {
                        // التأكد من أن التاريخ هو سلسلة نصية بالصيغة الصحيحة
                        const formattedDate = new Date(dateStr).toISOString().split('T')[0];
                        // إزالة أي سجل موجود لهذا اليوم قبل إضافة الجديد
                        workerToUpdate.attendance = workerToUpdate.attendance.filter(a => a.date !== formattedDate);
                        // إضافة سجل الغياب
                        workerToUpdate.attendance.push({ id: Date.now() + Math.random(), date: formattedDate, status: 'absent' });
                    };

                    if (reportData.type === 'طلب إجازة' && reportData.startDate && reportData.endDate) {
                        // إذا كان طلب إجازة، قم بالمرور على كل يوم في الفترة
                        let currentDate = new Date(reportData.startDate);
                        const endDate = new Date(reportData.endDate);
                        // *** إصلاح: التأكد من أن الحلقة تعمل بشكل صحيح ***
                        currentDate.setUTCHours(0, 0, 0, 0);
                        endDate.setUTCHours(0, 0, 0, 0);
                        while (currentDate <= endDate) {
                            addAbsentDay(currentDate);
                            currentDate.setDate(currentDate.getDate() + 1);
                        }
                    } else if (reportData.date) {
                        // إذا كان غياباً ليوم واحد
                        addAbsentDay(reportData.date);
                    }

                    // الخطوة 2: تحديث سجل العامل في قاعدة البيانات المحلية (Dexie)
                    await db.workers.update(workerToUpdate.id, { attendance: workerToUpdate.attendance });
                    showToast('تم تحديث سجل حضور العامل.');
                } else {
                    // *** إضافة: رسالة خطأ في حال عدم العثور على العامل ***
                    showCustomToast(`خطأ: لم يتم العثور على العامل (ID: ${reportData.workerId}) في سجلاتك.`, 'error');
                }
            }
        }

        // الخطوة 3: تحديث حالة البلاغ في Firestore (كما كان سابقاً)
        const reportRef = firestore.collection('reports').doc(reportId);
        await reportRef.update({
            status: status,
            reviewedBy: user.uid,
            reviewedAt: firebase.firestore.FieldValue.serverTimestamp(),
            adminNote: adminNote
        });

        showToast(`تم ${status === 'approved' ? 'الموافقة على' : 'رفض'} البلاغ.`);
        closeModal('reportReviewModal');
        // *** إضافة: إعادة تحميل الواجهة لإظهار التغييرات فوراً ***
        if (state.currentView.name === 'reportsDashboard') await renderView('reportsDashboard');
    } catch (error) {
        console.error("Error reviewing report:", error);
        showCustomToast('فشل تحديث حالة البلاغ.', 'error');
    }
}

function initializeEventListeners() {
        // Report Review Modal Listeners
    document.getElementById('reportReviewModal').addEventListener('click', (e) => {
        if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
            closeModal('reportReviewModal');
        }
    });
    document.getElementById('approveReportBtn').addEventListener('click', () => handleReportReview('approved'));
    document.getElementById('rejectReportBtn').addEventListener('click', () => handleReportReview('rejected'));

    // Search Modal Listeners
    document.getElementById('searchModal').addEventListener('click', (e) => {
        if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
            closeModal('searchModal');
        }
        const resultItem = e.target.closest('.search-result-item');
        if (resultItem) {
            const { type, id } = resultItem.dataset;
            closeModal('searchModal');
            switch (type) {
                case 'project':
                    renderView('project-details', { id: parseInt(id) });
                    break;
                case 'worker':
                    renderView('worker-details', { id: parseInt(id) });
                    break;
                case 'expense':
                    renderView('expense-details', { id: parseInt(id) });
                    break;
                case 'note':
                    openNoteModal(parseInt(id));
                    break;
                case 'supplier':
                    renderView('supplier-details', { id: parseInt(id) });
                    break;
                case 'inventory':
                    renderView('inventory-details', { id: parseInt(id) });
                    break;
                case 'debt':
                    renderView('debt-details', { id: parseInt(id) });
                    break;
                case 'calendarEvent':
                    openEventDetailsModal(parseInt(id));
                    break;
                case 'profile':
                    renderView('profile-details', { id: parseInt(id) });
                    break;
            }
        }
    });

    document.getElementById('searchInput').addEventListener('input', (e) => {
        performSearch(e.target.value.toLowerCase());
    });

    document.body.addEventListener('click', e => {
        if (e.target.closest('#openSearchModalBtn')) {
            openSearchModal();
        }
    });

    // Debt Modal Event Listeners
    document.getElementById('debtForm')?.addEventListener('submit', handleDebtFormSubmit);
    document.getElementById('debtModal')?.addEventListener('click', (e) => {
        if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
            closeDebtModal();
          }
      });

      // *** إضافة: معالج حدث لإغلاق نافذة مساعد الذكاء الاصطناعي ***
      document.getElementById('aiAssistantModal')?.addEventListener('click', (e) => {
          if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
              closeModal('aiAssistantModal');
        }
    });
    // *** إصلاح: إضافة معالج حدث لزر حذف الدين ***
    document.getElementById('deleteDebtBtn')?.addEventListener('click', () => {
        const debtId = parseInt(document.getElementById('debtId').value);
        if (debtId) {
            openConfirmModal('هل أنت متأكد من حذف هذا الدين؟', async () => {
                await db.debts.delete(debtId);
                closeDebtModal(); // *** إصلاح: إغلاق نافذة تعديل الدين بعد الحذف ***
                closeConfirmModal();
                renderView('debts_feature');
                showToast('تم حذف الدين بنجاح.'); // *** إضافة: إظهار رسالة تأكيد ***
            });
        }
    });
    
    document.getElementById('debtPaymentForm')?.addEventListener('submit', handleDebtPaymentFormSubmit);
    document.getElementById('debtPaymentModal')?.addEventListener('click', (e) => {
        if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
            closeDebtPaymentModal();
        }
    });

    // معالج تبديل الثيم
    themeToggleHeader.addEventListener('click', toggleTheme);

    // *** إضافة: معالج القائمة المنسدلة للمستخدم ***
    const userProfileBtn = document.getElementById('userProfileBtn');
    const userProfileDropdown = document.getElementById('userProfileDropdown');
    userProfileBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        userProfileDropdown.style.display = userProfileDropdown.style.display === 'none' ? 'block' : 'none';
    });
    // إغلاق القائمة عند الضغط في أي مكان آخر
    document.addEventListener('click', (e) => {
        if (!userProfileBtn.contains(e.target) && !userProfileDropdown.contains(e.target)) {
            userProfileDropdown.style.display = 'none';
        }
    });

    // معالج النقر العام على المحتوى الرئيسي (Event Delegation)
    mainContent.addEventListener('click', (e) => {
        const target = e.target;

        // بطاقات الوحدات في الصفحة الرئيسية
        const moduleCard = target.closest('.card[data-key]');
        if (moduleCard) { 
            // *** إضافة: التحقق من الاشتراك قبل الوصول للميزات المقيدة ***
            const isSubscribed = hasActiveSubscription();
            const featureIsAlwaysAccessible = ['more_features'].includes(moduleCard.dataset.key);
            if (auth.currentUser && !isSubscribed && !featureIsAlwaysAccessible) {
                openModal('subscriptionModal');
                return;
            }
            renderView(moduleCard.dataset.key, {});
            return;
        }
        
        // *** إضافة: معالج لفتح تفاصيل الاشتراك ***
        const subDetailsCard = target.closest('[data-action="open-subscription-details"]');
        if (subDetailsCard) {
            openSubscriptionDetailsModal();
            return;
        }

        // أزرار الإضافة والتعديل للنفقات
        const addExpenseBtn = target.closest('[data-action="add-expense"]');
        if (addExpenseBtn) {
            if (!hasActiveSubscription()) {
                openModal('subscriptionModal');
                return;
            }
            const prefill = addExpenseBtn.dataset.projectId ? { projectId: parseInt(addExpenseBtn.dataset.projectId) } : {};
            openExpenseModal(null, prefill);
            return;
        }
        const editExpenseBtn = target.closest('[data-action="edit-expense"]');
        if (editExpenseBtn) {
            openExpenseModal(parseInt(editExpenseBtn.dataset.id));
            return;
        }

        // عرض تفاصيل النفقة
        const viewExpenseBtn = target.closest('[data-action="view-expense"]');
        if (viewExpenseBtn) {
            renderView('expense-details', { id: parseInt(viewExpenseBtn.dataset.id) });
            return;
        }

        // أزرار تفاصيل المشروع
        if (state.currentView.name === 'project-details') {
            const projectId = state.currentView.params.id;
            if (target.closest('#backToProjects')) renderView('projects');
            if (target.closest('#editProjectBtn')) {
                if (!hasActiveSubscription()) { openModal('subscriptionModal'); return; }
                openProjectModal(projectId);
            }
            if (target.closest('#analyzeProjectBtn')) handleAnalysisRequest('project', projectId);
            if (target.closest('#addProjectPaymentBtn')) {
                if (!hasActiveSubscription()) {
                    openModal('subscriptionModal');
                    return;
                }
                openProjectPaymentModal(null, projectId)
            };
            if (target.closest('.tab-card')) switchProjectTab(target.closest('.tab-card').dataset.tab);
            if (target.closest('#showAllFinanceBtn')) openProjectFullFinanceModal(projectId);
            if (target.closest('#showAllPaymentsBtn')) openAllPaymentsModal(projectId);
            if (target.closest('#showAllExpensesBtn')) openAllExpensesModal(projectId);
        }

        // *** إضافة: معالج لفتح نافذة مراجعة البلاغ ***
        const reportCard = target.closest('.report-card');
        if (reportCard) {
            openReportReviewModal(reportCard.dataset.id);
        }

        // *** إصلاح: إضافة معالجات أزرار واجهة تفاصيل النفقة هنا ***
        if (state.currentView.name === 'expense-details') {
            const expenseId = state.currentView.params.id;
            if (target.closest('[data-action="edit-expense"]')) openExpenseModal(expenseId);
            if (target.closest('#analyzeExpenseBtn')) handleAnalysisRequest('expense', expenseId);
            if (target.closest('#printExpenseBtn')) printExpenseReport(expenseId);
        }
    });

    // معالجات النماذج (Forms)
    document.getElementById('projectForm').addEventListener('submit', handleProjectFormSubmit);
    document.getElementById('projectPaymentForm').addEventListener('submit', handleProjectPaymentFormSubmit);
    document.getElementById('expenseForm')?.addEventListener('submit', handleExpenseFormSubmit);
    document.getElementById('profileForm')?.addEventListener('submit', handleProfileFormSubmit);
    document.getElementById('apiConfigForm')?.addEventListener('submit', handleApiConfigFormSubmit);

    // معالجات النوافذ المنبثقة (Modals)
    document.getElementById('projectModal')?.addEventListener('click', (e) => {
        if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) closeProjectModal();
    });
    document.getElementById('projectPaymentModal').addEventListener('click', (e) => {
        if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) closeProjectPaymentModal();
    });
    document.getElementById('expenseModal')?.addEventListener('click', (e) => {
        if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) closeExpenseModal();
    });
    document.getElementById('profileModal')?.addEventListener('click', (e) => {
        if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) closeProfileModal();
    });

    // *** إضافة: معالج حدث لنموذج تفعيل الاشتراك ***
    const subscriptionForm = document.getElementById('subscriptionForm');
    if (subscriptionForm) {
        subscriptionForm.addEventListener('submit', handleSubscriptionActivation);
    }

    // *** إضافة: معالج حدث لزر ونافذة الرسائل ***
    document.getElementById('messagesBtn')?.addEventListener('click', openMessageModal);
    document.getElementById('messageForm')?.addEventListener('submit', handleMessageFormSubmit);
    document.getElementById('messageModal')?.addEventListener('click', (e) => {
        if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) closeModal('messageModal');
    });

      // *** إصلاح: نقل تعريف دالة تفاصيل الاشتراك وربطها هنا ***
      function openSubscriptionDetailsModal() {
          const sub = state.subscription;
          if (!sub) return;

          const subTypes = {
              'daily': 'يومي',
              'monthly': 'شهري',
              'six-months': 'نصف سنوي',
              'yearly': 'سنوي'
          };

          const details = [
              { label: 'نوع الباقة', value: subTypes[sub.type] || 'غير معروف', icon: 'fa-box-open' },
              { label: 'تاريخ البدء', value: new Date(sub.startDate).toLocaleString('ar-DZ', { dateStyle: 'full', timeStyle: 'short' }), icon: 'fa-calendar-plus' },
              { label: 'تاريخ الانتهاء', value: new Date(sub.endDate).toLocaleString('ar-DZ', { dateStyle: 'full', timeStyle: 'short' }), icon: 'fa-calendar-times' },
              { label: 'رمز التفعيل المستخدم', value: sub.usedKey, icon: 'fa-key' }
          ];

          const detailsHTML = details.map(item => `
              <div style="display: flex; align-items: flex-start; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                  <i class="fas ${item.icon}" style="color: var(--muted); font-size: 16px; margin-top: 5px; width: 20px; text-align: center;"></i>
                  <div style="flex-grow: 1;">
                      <div style="font-size: 13px; color: var(--muted);">${item.label}</div>
                      <div style="font-weight: 700; font-size: 15px; margin-top: 2px; direction: ltr; text-align: right; word-break: break-all;">${item.value}</div>
                  </div>
              </div>
          `).join('');

          document.getElementById('subDetailsList').innerHTML = detailsHTML;
          openModal('subscriptionDetailsModal');
      }

      // ربط حدث النقر لبطاقة تفاصيل الاشتراك
      const subDetailsCard = document.querySelector('[data-action="open-subscription-details"]');
      if (subDetailsCard) {
          subDetailsCard.addEventListener('click', openSubscriptionDetailsModal);
      }

      // ربط حدث النقر لإغلاق نافذة تفاصيل الاشتراك
      document.getElementById('subscriptionDetailsModal')?.addEventListener('click', (e) => {
          if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
              closeModal('subscriptionDetailsModal');
          }
      });
  }

  // *** إصلاح: إضافة معالج حدث لإغلاق نافذة تفعيل الاشتراك ***
  document.getElementById('subscriptionModal')?.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeModal('subscriptionModal');
      }
  });

  // *** تحسين: إضافة معالجة أخطاء احترافية لتهيئة التطبيق ***
  async function initializeApp() {
    try {
        // محاولة فتح قاعدة البيانات للتحقق من سلامتها
        // *** تحسين: تعيين isDbOpen إلى true بعد الفتح الناجح ***
        await db.open();
        isDbOpen = true; 

        // تحميل البيانات الأولية وتطبيق الإعدادات
        await loadState();
        
        const savedTheme = await db.app_settings.get('selected_theme');
        const themeToApply = savedTheme ? savedTheme.value : 'default-light';
        await applyThemeSet(themeToApply);
        state.active_api_id = (await db.app_settings.get('active_api_id'))?.value || null;
        state.selected_theme = themeToApply;
        
        // عرض الواجهة الرئيسية
        await renderView(state.currentView.name || 'home', state.currentView.params || {});
        
        // *** تحسين: تهيئة جميع معالجات الأحداث مرة واحدة فقط ***
        initializeEventListeners();

    } catch (error) {
        console.error("Dexie initialization failed:", error);
        // عرض رسالة خطأ واضحة للمستخدم في حال فشل التهيئة
        mainContent.innerHTML = `
            <div style="text-align: center; padding: 40px 20px;">
                <h3 style="color: #ef4444;">حدث خطأ فادح أثناء تهيئة قاعدة البيانات.</h3>
                <p style="color: var(--muted); line-height: 1.6;">قد يكون هذا بسبب تحديث للتطبيق. لحل المشكلة، يرجى محاولة مسح بيانات الموقع من إعدادات المتصفح ثم إعادة تحميل الصفحة.</p>
            </div>`;
    }
  }

  // *** إضافة: دوال إظهار وإخفاء إشعار النسخ الاحتياطي ***
  function showBackupNotification() {
    document.getElementById('settingsNotificationDot').style.display = 'block';
    // إذا كنا في صفحة الإعدادات، أظهر النقطة على البطاقة أيضاً
    if (state.currentView && state.currentView.name === 'settings') {
        const backupCardDot = document.getElementById('backupRestoreCardDot');
        if (backupCardDot) backupCardDot.style.display = 'block';
    }
  }

  function hideBackupNotification() {
    document.getElementById('settingsNotificationDot').style.display = 'none';
    const backupCardDot = document.getElementById('backupRestoreCardDot');
    if (backupCardDot) backupCardDot.style.display = 'none';
  }

  // *** إضافة: دالة لمراقبة حالة الاشتراك في الوقت الحقيقي ***
  function setupSubscriptionListener(userId) {
      // الاستماع إلى مستند المستخدم لمراقبة تغييرات الاشتراك في الوقت الفعلي
      const unsubscribe = firestore.collection('users').doc(userId).onSnapshot(async (doc) => {
          if (doc.exists) {
              const userData = doc.data();
              const newSubscription = userData.subscription || null;

              // مقارنة الحالة الجديدة بالحالة الحالية لتجنب التحديثات غير الضرورية
              if (JSON.stringify(newSubscription) !== JSON.stringify(state.subscription)) {
                  console.log('Subscription status changed, updating local state.');
                  
                  // تحديث الحالة المحلية في Dexie
                  await db.app_settings.put({ key: 'subscriptionInfo', value: newSubscription });
                  
                  // تحديث حالة التطبيق في الذاكرة
                  state.subscription = newSubscription;
                  
                  // إعادة رسم الواجهة الحالية لإظهار/إخفاء الميزات المدفوعة
                  await renderView(state.currentView.name, state.currentView.params);
                  if (!hasAttemptedExpiredSubCleanup) showToast('تم تحديث حالة اشتراكك.');
              }
          }
      }, (error) => {
          console.error("Error in subscription snapshot listener:", error);
      });
      return unsubscribe; // إرجاع دالة إلغاء الاشتراك للتنظيف عند تسجيل الخروج
  }

  // --- Auth State Observer ---
  auth.onAuthStateChanged(user => {
      // *** تعديل: تهيئة التطبيق دائماً، وتحديث الواجهة حسب حالة المستخدم ***
      // *** إصلاح: تنظيف المستمعين القدامى قبل تهيئة التطبيق لتجنب التكرار ***
      if (firestoreUnsubscribeFunctions.length > 0) {
          cleanupFirestoreListeners();
      }
      initializeApp().then(() => {
        const loggedInView = document.getElementById('loggedInView');
        const loggedOutView = document.getElementById('loggedOutView');
        const userProfileIcon = document.getElementById('userProfileIcon');

        if (user) {
            // User is signed in
            console.log("User is signed in:", user.email);
            loggedInView.style.display = 'block';
            loggedOutView.style.display = 'none';
            userProfileIcon.className = 'fas fa-user-circle';

            const userDisplayName = document.getElementById('userDisplayName');
            const userDisplayEmail = document.getElementById('userDisplayEmail');
            
            firestore.collection('users').doc(user.uid).get().then(doc => {
                if (doc.exists) {
                    const userData = doc.data();
                    userDisplayName.textContent = `${userData.firstName} ${userData.lastName}`;
                    // *** إضافة: تخزين بيانات المستخدم في الحالة العامة ***
                    state.currentUser = userData;
                    userDisplayEmail.textContent = user.email;
                } else {
                    // *** إصلاح: مسح بيانات المستخدم السابق إذا لم يتم العثور على بيانات جديدة ***
                    state.currentUser = null;
                    userDisplayName.textContent = user.email;
                    userDisplayEmail.textContent = 'مستخدم';
                }
                // *** إصلاح: إعادة عرض الواجهة الرئيسية بعد جلب بيانات المستخدم لضمان ظهور اسمه ***
                if (state.currentView.name === 'home') renderView('home');
            }).catch(() => {
                userDisplayName.textContent = user.email;
            });

            // *** إضافة: بدء الاستماع لتغييرات الاشتراك ***
            const subUnsubscribe = setupSubscriptionListener(user.uid);

            // *** تعديل: استخدام المسار الصحيح لمستند المستخدم لمراقبة التحديثات ***
            firestore.collection('users').doc(user.uid).onSnapshot(doc => {
                if (doc.exists) {
                    // *** تعديل: قراءة النسخة الاحتياطية من داخل حقل backup ***
                    const data = doc.data().backup;
                    if (!data) return; // لا يوجد حقل backup

                    if (data.lastUpdatedBy && data.lastUpdatedBy !== deviceIdentifier) {
                        const backupTime = data.backupTimestamp?.toDate().getTime();
                        const lastSyncTime = parseInt(localStorage.getItem('lastBackupSyncTime') || '0');
                        if (backupTime > lastSyncTime) {
                            showBackupNotification();
                        }
                    }
                }
            });

            // *** إضافة: مستمع Firestore لإشعارات المشتريات الجديدة ***
            // *** تعديل: استخدام المسار الصحيح المتوافق مع قواعد Firestore ***
            firestore.collection('users').doc(user.uid).collection('purchases')
                .where('status', '==', 'pending') // *** تحسين: جلب الطلبات قيد المراجعة فقط ***
                .onSnapshot(async (querySnapshot) => {
                    const changes = querySnapshot.docChanges();
                    let needsRender = false;
                    const lastChecked = parseInt(localStorage.getItem('lastCheckedPurchasesTimestamp') || '0');

                    for (const change of changes) {
                        const data = { ...change.doc.data(), firestoreId: change.doc.id };
                        if (change.type === 'added' || change.type === 'modified') {
                            await db.purchases.put(data);
                            // التحقق مما إذا كان هناك طلب جديد لم تتم قراءته بعد
                            const purchaseTime = normalizeTimestamp(data.createdAt);
                            if (data.status === 'pending' && purchaseTime > lastChecked) {
                                state.hasNewPurchases = true;
                                needsRender = true;
                            }
                        } else if (change.type === 'removed') {
                            await db.purchases.delete(data.firestoreId);
                        }
                    }
                    // تحديث الواجهة الرئيسية لإظهار النقطة، أو تحديث واجهة المشتريات إذا كانت مفتوحة
                    if (needsRender && state.currentView.name === 'home') await renderView('home');
                    else if (state.currentView.name === 'purchases') await renderView('purchases');
                });

            // *** إضافة: مستمع Firestore للبلاغات الجديدة (للمدير) ***
            // *** إصلاح: تعديل المستمع ليقرأ فقط البلاغات الخاصة بالعمال المرتبطين بالمدير الحالي ***
            firestore.collection('reports').where('managerUid', '==', user.uid).onSnapshot(async (querySnapshot) => {
                // *** الحل الجذري: تبسيط منطق التحديث ***
                let needsRender = false;
                let newReportsFound = false;
                try { 
                    // *** إصلاح جذري: تحديث الحالة المحلية (state.reports) مباشرة ***
                    for (const change of querySnapshot.docChanges()) {
                        const data = change.doc.data();
                        const report = { ...data, firestoreId: change.doc.id };
                        
                        if (change.type === 'added') {
                            await db.reports.put(report);
                            // إضافة البلاغ الجديد إلى بداية المصفوفة في الحالة
                            state.reports.unshift(report);
                            if (report.status === 'pending') {
                                newReportsFound = true;
                            }
                            needsRender = true;
                        } else if (change.type === 'modified') {
                            await db.reports.put(report); // put يعمل كـ update إذا كان السجل موجوداً
                            // تحديث البلاغ الموجود في الحالة
                            const index = state.reports.findIndex(r => r.firestoreId === report.firestoreId);
                            if (index > -1) {
                                state.reports[index] = report;
                            }
                            needsRender = true;
                        } else if (change.type === 'removed') {
                            await db.reports.delete(report.firestoreId);
                            // إزالة البلاغ من الحالة
                            state.reports = state.reports.filter(r => r.firestoreId !== report.firestoreId);
                            needsRender = true;
                        }
                    }
                    // إعادة فرز المصفوفة لضمان الترتيب الصحيح
                    state.reports.sort((a, b) => normalizeTimestamp(b.createdAt) - normalizeTimestamp(a.createdAt));

                    if (newReportsFound) {
                        state.hasNewReports = true;
                        updateNotificationDots();
                    }
                    // إذا كانت هناك تغييرات والمدير على واجهة البلاغات، أعد رسمها
                    if (needsRender && state.currentView.name === 'reportsDashboard') {
                        await renderView('reportsDashboard');
                    }
                } catch (error) {
                    console.error("Error processing reports snapshot:", error);
                }
            });
            
            // *** إضافة: تخزين دوال إلغاء الاشتراك لتنظيفها لاحقاً ***
            firestoreUnsubscribeFunctions.push(subUnsubscribe);
            // (يجب إضافة دوال إلغاء الاشتراك الأخرى هنا أيضاً إذا تم تعريفها)

        } else {
            // User is signed out or not logged in yet
            console.log("User is not signed in. Running in offline mode.");
            loggedInView.style.display = 'none';
            loggedOutView.style.display = 'flex'; // *** إصلاح: استخدام 'flex' بدلاً من 'block' لإظهار الأزرار بشكل صحيح
            userProfileIcon.className = 'fas fa-sign-in-alt';
            // *** إضافة: مسح بيانات المستخدم عند تسجيل الخروج ***
            state.currentUser = null;
        }
      });
  });

</script>
</body>
</html>
ript>
</body>
</html>
